import{ethers as e}from"ethers";var t={d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};t.r(n),t.d(n,{code:()=>le,digest:()=>ue,name:()=>se,size:()=>oe});var a={};t.r(a),t.d(a,{asLegacyPieceCID:()=>$n,asPieceCID:()=>On,calculate:()=>Bn,createPieceCIDStream:()=>Ln,downloadAndValidate:()=>N,downloadAndValidateFromUrl:()=>U});var r={};t.r(r),t.d(r,{PDPAuthHelper:()=>Wn,PDPServer:()=>Qn,PDPVerifier:()=>Xn,asDataSetData:()=>Zn,asDataSetPieceData:()=>Yn,isDataSetCreationStatusResponse:()=>zn,isFindPieceResponse:()=>Hn,isPieceAdditionStatusResponse:()=>jn,validateDataSetCreationStatusResponse:()=>Gn,validateFindPieceResponse:()=>qn,validatePieceAdditionStatusResponse:()=>Kn});var i={};t.r(i),t.d(i,{SPRegistryService:()=>Jn});var s={};t.r(s),t.d(s,{CHAIN_IDS:()=>p,CONTRACT_ABIS:()=>d,CONTRACT_ADDRESSES:()=>f,GENESIS_TIMESTAMPS:()=>l,METADATA_KEYS:()=>y,PDPAuthHelper:()=>Wn,PDPServer:()=>Qn,PDPVerifier:()=>Xn,PaymentsService:()=>k,RPC_URLS:()=>g,SETTLEMENT_FEE:()=>h,SIZE_CONSTANTS:()=>c,StorageContext:()=>ta,StorageManager:()=>na,StorageService:()=>ta,SubgraphService:()=>da,Synapse:()=>ha,TIME_CONSTANTS:()=>u,TIMING_CONSTANTS:()=>m,TOKENS:()=>o,WarmStorageService:()=>ma,asDataSetData:()=>Zn,asDataSetPieceData:()=>Yn,calculateLastProofDate:()=>b,combineMetadata:()=>E,constructFindPieceUrl:()=>M,constructPieceUrl:()=>R,createError:()=>v,dateToEpoch:()=>T,epochToDate:()=>w,getCurrentEpoch:()=>I,getFilecoinNetworkType:()=>x,getGenesisTimestamp:()=>S,isDataSetCreationStatusResponse:()=>zn,isFindPieceResponse:()=>Hn,isPieceAdditionStatusResponse:()=>jn,metadataMatches:()=>_,timeUntilEpoch:()=>P,validateDataSetCreationStatusResponse:()=>Gn,validateFindPieceResponse:()=>qn,validatePieceAdditionStatusResponse:()=>Kn});const o={USDFC:"USDFC",FIL:"FIL"},p={mainnet:314,calibration:314159},d={ERC20:[{type:"event",name:"Approval",inputs:[{indexed:!0,name:"owner",type:"address"},{indexed:!0,name:"spender",type:"address"},{indexed:!1,name:"value",type:"uint256"}]},{type:"event",name:"Transfer",inputs:[{indexed:!0,name:"from",type:"address"},{indexed:!0,name:"to",type:"address"},{indexed:!1,name:"value",type:"uint256"}]},{type:"function",name:"allowance",stateMutability:"view",inputs:[{name:"owner",type:"address"},{name:"spender",type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"approve",stateMutability:"nonpayable",inputs:[{name:"spender",type:"address"},{name:"amount",type:"uint256"}],outputs:[{type:"bool"}]},{type:"function",name:"balanceOf",stateMutability:"view",inputs:[{name:"account",type:"address"}],outputs:[{type:"uint256"}]},{type:"function",name:"decimals",stateMutability:"view",inputs:[],outputs:[{type:"uint8"}]},{type:"function",name:"name",stateMutability:"view",inputs:[],outputs:[{type:"string"}]},{type:"function",name:"symbol",stateMutability:"view",inputs:[],outputs:[{type:"string"}]},{type:"function",name:"totalSupply",stateMutability:"view",inputs:[],outputs:[{type:"uint256"}]},{type:"function",name:"transfer",stateMutability:"nonpayable",inputs:[{name:"recipient",type:"address"},{name:"amount",type:"uint256"}],outputs:[{type:"bool"}]},{type:"function",name:"transferFrom",stateMutability:"nonpayable",inputs:[{name:"sender",type:"address"},{name:"recipient",type:"address"},{name:"amount",type:"uint256"}],outputs:[{type:"bool"}]}],PAYMENTS:[{type:"constructor",inputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"COMMISSION_MAX_BPS",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"NETWORK_FEE",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"UPGRADE_INTERFACE_VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"",internalType:"address",type:"address"},{name:"",internalType:"address",type:"address"}],name:"accounts",outputs:[{name:"funds",internalType:"uint256",type:"uint256"},{name:"lockupCurrent",internalType:"uint256",type:"uint256"},{name:"lockupRate",internalType:"uint256",type:"uint256"},{name:"lockupLastSettledAt",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"validator",internalType:"address",type:"address"},{name:"commissionRateBps",internalType:"uint256",type:"uint256"},{name:"serviceFeeRecipient",internalType:"address",type:"address"}],name:"createRail",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"}],name:"deposit",outputs:[],stateMutability:"payable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"},{name:"deadline",internalType:"uint256",type:"uint256"},{name:"v",internalType:"uint8",type:"uint8"},{name:"r",internalType:"bytes32",type:"bytes32"},{name:"s",internalType:"bytes32",type:"bytes32"}],name:"depositWithPermit",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"},{name:"deadline",internalType:"uint256",type:"uint256"},{name:"v",internalType:"uint8",type:"uint8"},{name:"r",internalType:"bytes32",type:"bytes32"},{name:"s",internalType:"bytes32",type:"bytes32"},{name:"operator",internalType:"address",type:"address"},{name:"rateAllowance",internalType:"uint256",type:"uint256"},{name:"lockupAllowance",internalType:"uint256",type:"uint256"},{name:"maxLockupPeriod",internalType:"uint256",type:"uint256"}],name:"depositWithPermitAndApproveOperator",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"},{name:"deadline",internalType:"uint256",type:"uint256"},{name:"v",internalType:"uint8",type:"uint8"},{name:"r",internalType:"bytes32",type:"bytes32"},{name:"s",internalType:"bytes32",type:"bytes32"},{name:"operator",internalType:"address",type:"address"},{name:"rateAllowanceIncrease",internalType:"uint256",type:"uint256"},{name:"lockupAllowanceIncrease",internalType:"uint256",type:"uint256"}],name:"depositWithPermitAndIncreaseOperatorApproval",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"owner",internalType:"address",type:"address"}],name:"getAccountInfoIfSettled",outputs:[{name:"fundedUntilEpoch",internalType:"uint256",type:"uint256"},{name:"currentFunds",internalType:"uint256",type:"uint256"},{name:"availableFunds",internalType:"uint256",type:"uint256"},{name:"currentLockupRate",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"getRail",outputs:[{name:"",internalType:"struct Payments.RailView",type:"tuple",components:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"operator",internalType:"address",type:"address"},{name:"validator",internalType:"address",type:"address"},{name:"paymentRate",internalType:"uint256",type:"uint256"},{name:"lockupPeriod",internalType:"uint256",type:"uint256"},{name:"lockupFixed",internalType:"uint256",type:"uint256"},{name:"settledUpTo",internalType:"uint256",type:"uint256"},{name:"endEpoch",internalType:"uint256",type:"uint256"},{name:"commissionRateBps",internalType:"uint256",type:"uint256"},{name:"serviceFeeRecipient",internalType:"address",type:"address"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"payee",internalType:"address",type:"address"},{name:"token",internalType:"address",type:"address"}],name:"getRailsForPayeeAndToken",outputs:[{name:"",internalType:"struct Payments.RailInfo[]",type:"tuple[]",components:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"isTerminated",internalType:"bool",type:"bool"},{name:"endEpoch",internalType:"uint256",type:"uint256"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"payer",internalType:"address",type:"address"},{name:"token",internalType:"address",type:"address"}],name:"getRailsForPayerAndToken",outputs:[{name:"",internalType:"struct Payments.RailInfo[]",type:"tuple[]",components:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"isTerminated",internalType:"bool",type:"bool"},{name:"endEpoch",internalType:"uint256",type:"uint256"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"getRateChangeQueueSize",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"",internalType:"address",type:"address"}],name:"hasCollectedFees",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"operator",internalType:"address",type:"address"},{name:"rateAllowanceIncrease",internalType:"uint256",type:"uint256"},{name:"lockupAllowanceIncrease",internalType:"uint256",type:"uint256"}],name:"increaseOperatorApproval",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"initialize",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"period",internalType:"uint256",type:"uint256"},{name:"lockupFixed",internalType:"uint256",type:"uint256"}],name:"modifyRailLockup",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"newRate",internalType:"uint256",type:"uint256"},{name:"oneTimePayment",internalType:"uint256",type:"uint256"}],name:"modifyRailPayment",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"",internalType:"address",type:"address"},{name:"",internalType:"address",type:"address"},{name:"",internalType:"address",type:"address"}],name:"operatorApprovals",outputs:[{name:"isApproved",internalType:"bool",type:"bool"},{name:"rateAllowance",internalType:"uint256",type:"uint256"},{name:"lockupAllowance",internalType:"uint256",type:"uint256"},{name:"rateUsage",internalType:"uint256",type:"uint256"},{name:"lockupUsage",internalType:"uint256",type:"uint256"},{name:"maxLockupPeriod",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"owner",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"proxiableUUID",outputs:[{name:"",internalType:"bytes32",type:"bytes32"}],stateMutability:"view"},{type:"function",inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"operator",internalType:"address",type:"address"},{name:"approved",internalType:"bool",type:"bool"},{name:"rateAllowance",internalType:"uint256",type:"uint256"},{name:"lockupAllowance",internalType:"uint256",type:"uint256"},{name:"maxLockupPeriod",internalType:"uint256",type:"uint256"}],name:"setOperatorApproval",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"untilEpoch",internalType:"uint256",type:"uint256"}],name:"settleRail",outputs:[{name:"totalSettledAmount",internalType:"uint256",type:"uint256"},{name:"totalNetPayeeAmount",internalType:"uint256",type:"uint256"},{name:"totalOperatorCommission",internalType:"uint256",type:"uint256"},{name:"finalSettledEpoch",internalType:"uint256",type:"uint256"},{name:"note",internalType:"string",type:"string"}],stateMutability:"payable"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"settleTerminatedRailWithoutValidation",outputs:[{name:"totalSettledAmount",internalType:"uint256",type:"uint256"},{name:"totalNetPayeeAmount",internalType:"uint256",type:"uint256"},{name:"totalOperatorCommission",internalType:"uint256",type:"uint256"},{name:"finalSettledEpoch",internalType:"uint256",type:"uint256"},{name:"note",internalType:"string",type:"string"}],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"terminateRail",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newOwner",internalType:"address",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newImplementation",internalType:"address",type:"address"},{name:"data",internalType:"bytes",type:"bytes"}],name:"upgradeToAndCall",outputs:[],stateMutability:"payable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"}],name:"withdraw",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"token",internalType:"address",type:"address"},{name:"to",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"}],name:"withdrawTo",outputs:[],stateMutability:"nonpayable"},{type:"event",anonymous:!1,inputs:[{name:"token",internalType:"address",type:"address",indexed:!0},{name:"owner",internalType:"address",type:"address",indexed:!0},{name:"lockupCurrent",internalType:"uint256",type:"uint256",indexed:!1},{name:"lockupRate",internalType:"uint256",type:"uint256",indexed:!1},{name:"lockupLastSettledAt",internalType:"uint256",type:"uint256",indexed:!1}],name:"AccountLockupSettled"},{type:"event",anonymous:!1,inputs:[{name:"token",internalType:"address",type:"address",indexed:!0},{name:"from",internalType:"address",type:"address",indexed:!0},{name:"to",internalType:"address",type:"address",indexed:!0},{name:"amount",internalType:"uint256",type:"uint256",indexed:!1},{name:"usedPermit",internalType:"bool",type:"bool",indexed:!1}],name:"DepositRecorded"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"uint64",type:"uint64",indexed:!1}],name:"Initialized"},{type:"event",anonymous:!1,inputs:[{name:"token",internalType:"address",type:"address",indexed:!0},{name:"client",internalType:"address",type:"address",indexed:!0},{name:"operator",internalType:"address",type:"address",indexed:!0},{name:"approved",internalType:"bool",type:"bool",indexed:!1},{name:"rateAllowance",internalType:"uint256",type:"uint256",indexed:!1},{name:"lockupAllowance",internalType:"uint256",type:"uint256",indexed:!1},{name:"maxLockupPeriod",internalType:"uint256",type:"uint256",indexed:!1}],name:"OperatorApprovalUpdated"},{type:"event",anonymous:!1,inputs:[{name:"previousOwner",internalType:"address",type:"address",indexed:!0},{name:"newOwner",internalType:"address",type:"address",indexed:!0}],name:"OwnershipTransferred"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0},{name:"payer",internalType:"address",type:"address",indexed:!0},{name:"payee",internalType:"address",type:"address",indexed:!0},{name:"token",internalType:"address",type:"address",indexed:!1},{name:"operator",internalType:"address",type:"address",indexed:!1},{name:"validator",internalType:"address",type:"address",indexed:!1},{name:"serviceFeeRecipient",internalType:"address",type:"address",indexed:!1},{name:"commissionRateBps",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailCreated"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0}],name:"RailFinalized"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0},{name:"oldLockupPeriod",internalType:"uint256",type:"uint256",indexed:!1},{name:"newLockupPeriod",internalType:"uint256",type:"uint256",indexed:!1},{name:"oldLockupFixed",internalType:"uint256",type:"uint256",indexed:!1},{name:"newLockupFixed",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailLockupModified"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0},{name:"netPayeeAmount",internalType:"uint256",type:"uint256",indexed:!1},{name:"operatorCommission",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailOneTimePaymentProcessed"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0},{name:"oldRate",internalType:"uint256",type:"uint256",indexed:!1},{name:"newRate",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailRateModified"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0},{name:"totalSettledAmount",internalType:"uint256",type:"uint256",indexed:!1},{name:"totalNetPayeeAmount",internalType:"uint256",type:"uint256",indexed:!1},{name:"operatorCommission",internalType:"uint256",type:"uint256",indexed:!1},{name:"settledUpTo",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailSettled"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!0},{name:"by",internalType:"address",type:"address",indexed:!0},{name:"endEpoch",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailTerminated"},{type:"event",anonymous:!1,inputs:[{name:"implementation",internalType:"address",type:"address",indexed:!0}],name:"Upgraded"},{type:"event",anonymous:!1,inputs:[{name:"token",internalType:"address",type:"address",indexed:!0},{name:"from",internalType:"address",type:"address",indexed:!0},{name:"to",internalType:"address",type:"address",indexed:!0},{name:"amount",internalType:"uint256",type:"uint256",indexed:!1}],name:"WithdrawRecorded"},{type:"error",inputs:[{name:"target",internalType:"address",type:"address"}],name:"AddressEmptyCode"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"maxSettlementEpoch",internalType:"uint256",type:"uint256"},{name:"blockNumber",internalType:"uint256",type:"uint256"}],name:"CannotModifyTerminatedRailBeyondEndEpoch"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"maxAllowedEpoch",internalType:"uint256",type:"uint256"},{name:"attemptedEpoch",internalType:"uint256",type:"uint256"}],name:"CannotSettleFutureEpochs"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"requiredBlock",internalType:"uint256",type:"uint256"},{name:"currentBlock",internalType:"uint256",type:"uint256"}],name:"CannotSettleTerminatedRailBeforeMaxEpoch"},{type:"error",inputs:[{name:"maxAllowed",internalType:"uint256",type:"uint256"},{name:"actual",internalType:"uint256",type:"uint256"}],name:"CommissionRateTooHigh"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"oldLockup",internalType:"uint256",type:"uint256"},{name:"currentLockup",internalType:"uint256",type:"uint256"}],name:"CurrentLockupLessThanOldLockup"},{type:"error",inputs:[{name:"implementation",internalType:"address",type:"address"}],name:"ERC1967InvalidImplementation"},{type:"error",inputs:[],name:"ERC1967NonPayable"},{type:"error",inputs:[],name:"FailedCall"},{type:"error",inputs:[{name:"from",internalType:"address",type:"address"},{name:"token",internalType:"address",type:"address"},{name:"currentLockup",internalType:"uint256",type:"uint256"},{name:"lockupReduction",internalType:"uint256",type:"uint256"}],name:"InsufficientCurrentLockup"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"required",internalType:"uint256",type:"uint256"},{name:"actual",internalType:"uint256",type:"uint256"}],name:"InsufficientFundsForOneTimePayment"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"available",internalType:"uint256",type:"uint256"},{name:"required",internalType:"uint256",type:"uint256"}],name:"InsufficientFundsForSettlement"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"available",internalType:"uint256",type:"uint256"},{name:"required",internalType:"uint256",type:"uint256"}],name:"InsufficientLockupForSettlement"},{type:"error",inputs:[{name:"required",internalType:"uint256",type:"uint256"},{name:"sent",internalType:"uint256",type:"uint256"}],name:"InsufficientNativeTokenForBurn"},{type:"error",inputs:[{name:"available",internalType:"uint256",type:"uint256"},{name:"requested",internalType:"uint256",type:"uint256"}],name:"InsufficientUnlockedFunds"},{type:"error",inputs:[],name:"InvalidInitialization"},{type:"error",inputs:[{name:"nextRateChangeUntilEpoch",internalType:"uint256",type:"uint256"},{name:"processedEpoch",internalType:"uint256",type:"uint256"}],name:"InvalidRateChangeQueueState"},{type:"error",inputs:[{name:"actualPeriod",internalType:"uint256",type:"uint256"},{name:"actualLockupFixed",internalType:"uint256",type:"uint256"},{name:"attemptedPeriod",internalType:"uint256",type:"uint256"},{name:"attemptedLockupFixed",internalType:"uint256",type:"uint256"}],name:"InvalidTerminatedRailModification"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"account",internalType:"address",type:"address"},{name:"lockupCurrent",internalType:"uint256",type:"uint256"},{name:"fundsCurrent",internalType:"uint256",type:"uint256"}],name:"LockupExceedsFundsInvariant"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"actualLockupFixed",internalType:"uint256",type:"uint256"},{name:"attemptedLockupFixed",internalType:"uint256",type:"uint256"}],name:"LockupFixedIncreaseNotAllowedDueToInsufficientFunds"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"expectedLockup",internalType:"uint256",type:"uint256"},{name:"actualLockup",internalType:"uint256",type:"uint256"}],name:"LockupInconsistencyDuringRailFinalization"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"from",internalType:"address",type:"address"},{name:"isSettled",internalType:"bool",type:"bool"},{name:"currentRate",internalType:"uint256",type:"uint256"},{name:"attemptedRate",internalType:"uint256",type:"uint256"}],name:"LockupNotSettledRateChangeNotAllowed"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"from",internalType:"address",type:"address"},{name:"actualLockupPeriod",internalType:"uint256",type:"uint256"},{name:"attemptedLockupPeriod",internalType:"uint256",type:"uint256"}],name:"LockupPeriodChangeNotAllowedDueToInsufficientFunds"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"},{name:"operator",internalType:"address",type:"address"},{name:"maxAllowedPeriod",internalType:"uint256",type:"uint256"},{name:"requestedPeriod",internalType:"uint256",type:"uint256"}],name:"LockupPeriodExceedsOperatorMaximum"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"from",internalType:"address",type:"address"},{name:"paymentRate",internalType:"uint256",type:"uint256"},{name:"lockupRate",internalType:"uint256",type:"uint256"}],name:"LockupRateInconsistent"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"from",internalType:"address",type:"address"},{name:"lockupRate",internalType:"uint256",type:"uint256"},{name:"oldRate",internalType:"uint256",type:"uint256"}],name:"LockupRateLessThanOldRate"},{type:"error",inputs:[],name:"MissingServiceFeeRecipient"},{type:"error",inputs:[{name:"required",internalType:"uint256",type:"uint256"},{name:"sent",internalType:"uint256",type:"uint256"}],name:"MustSendExactNativeAmount"},{type:"error",inputs:[{name:"sent",internalType:"uint256",type:"uint256"}],name:"NativeTokenNotAccepted"},{type:"error",inputs:[],name:"NativeTokenNotSupported"},{type:"error",inputs:[{name:"to",internalType:"address",type:"address"},{name:"amount",internalType:"uint256",type:"uint256"}],name:"NativeTransferFailed"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"expectedSettledUpTo",internalType:"uint256",type:"uint256"},{name:"actualSettledUpTo",internalType:"uint256",type:"uint256"}],name:"NoProgressInSettlement"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"allowedClient",internalType:"address",type:"address"},{name:"allowedOperator",internalType:"address",type:"address"},{name:"caller",internalType:"address",type:"address"}],name:"NotAuthorizedToTerminateRail"},{type:"error",inputs:[],name:"NotInitializing"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"available",internalType:"uint256",type:"uint256"},{name:"required",internalType:"uint256",type:"uint256"}],name:"OneTimePaymentExceedsLockup"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"caller",internalType:"address",type:"address"}],name:"OnlyRailClientAllowed"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"caller",internalType:"address",type:"address"}],name:"OnlyRailOperatorAllowed"},{type:"error",inputs:[{name:"expectedFrom",internalType:"address",type:"address"},{name:"expectedOperator",internalType:"address",type:"address"},{name:"expectedTo",internalType:"address",type:"address"},{name:"caller",internalType:"address",type:"address"}],name:"OnlyRailParticipantAllowed"},{type:"error",inputs:[{name:"allowed",internalType:"uint256",type:"uint256"},{name:"attemptedUsage",internalType:"uint256",type:"uint256"}],name:"OperatorLockupAllowanceExceeded"},{type:"error",inputs:[{name:"from",internalType:"address",type:"address"},{name:"operator",internalType:"address",type:"address"}],name:"OperatorNotApproved"},{type:"error",inputs:[{name:"allowed",internalType:"uint256",type:"uint256"},{name:"attemptedUsage",internalType:"uint256",type:"uint256"}],name:"OperatorRateAllowanceExceeded"},{type:"error",inputs:[{name:"owner",internalType:"address",type:"address"}],name:"OwnableInvalidOwner"},{type:"error",inputs:[{name:"account",internalType:"address",type:"address"}],name:"OwnableUnauthorizedAccount"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"PermitRecipientMustBeMsgSender"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"RailAlreadyTerminated"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"RailInactiveOrSettled"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"RailNotTerminated"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"RateChangeNotAllowedOnTerminatedRail"},{type:"error",inputs:[{name:"nextUntilEpoch",internalType:"uint256",type:"uint256"}],name:"RateChangeQueueNotEmpty"},{type:"error",inputs:[],name:"ReentrancyGuardReentrantCall"},{type:"error",inputs:[{name:"token",internalType:"address",type:"address"}],name:"SafeERC20FailedOperation"},{type:"error",inputs:[],name:"UUPSUnauthorizedCallContext"},{type:"error",inputs:[{name:"slot",internalType:"bytes32",type:"bytes32"}],name:"UUPSUnsupportedProxiableUUID"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"maxAllowed",internalType:"uint256",type:"uint256"},{name:"attempted",internalType:"uint256",type:"uint256"}],name:"ValidatorModifiedAmountExceedsMaximum"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"allowedStart",internalType:"uint256",type:"uint256"},{name:"attemptedStart",internalType:"uint256",type:"uint256"}],name:"ValidatorSettledBeforeSegmentStart"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"allowedEnd",internalType:"uint256",type:"uint256"},{name:"attemptedEnd",internalType:"uint256",type:"uint256"}],name:"ValidatorSettledBeyondSegmentEnd"},{type:"error",inputs:[{name:"varName",internalType:"string",type:"string"}],name:"ZeroAddressNotAllowed"}],PDP_VERIFIER:[{type:"constructor",inputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"BURN_ACTOR",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"EXTRA_DATA_MAX_SIZE",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"FIL_USD_PRICE_FEED_ID",outputs:[{name:"",internalType:"bytes32",type:"bytes32"}],stateMutability:"view"},{type:"function",inputs:[],name:"LEAF_SIZE",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"MAX_ENQUEUED_REMOVALS",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"MAX_PIECE_SIZE_LOG2",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"NO_CHALLENGE_SCHEDULED",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"NO_PROVEN_EPOCH",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"PYTH",outputs:[{name:"",internalType:"contract IPyth",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"RANDOMNESS_PRECOMPILE",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"SECONDS_IN_DAY",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"UPGRADE_INTERFACE_VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[],name:"VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"pieceData",internalType:"struct Cids.Cid[]",type:"tuple[]",components:[{name:"data",internalType:"bytes",type:"bytes"}]},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"addPieces",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"estimatedGasFee",internalType:"uint256",type:"uint256"}],name:"calculateProofFee",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"claimDataSetStorageProvider",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"listenerAddr",internalType:"address",type:"address"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"createDataSet",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"payable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"dataSetLive",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"deleteDataSet",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"leafIndexs",internalType:"uint256[]",type:"uint256[]"}],name:"findPieceIds",outputs:[{name:"",internalType:"struct IPDPTypes.PieceIdAndOffset[]",type:"tuple[]",components:[{name:"pieceId",internalType:"uint256",type:"uint256"},{name:"offset",internalType:"uint256",type:"uint256"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getActivePieceCount",outputs:[{name:"activeCount",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"offset",internalType:"uint256",type:"uint256"},{name:"limit",internalType:"uint256",type:"uint256"}],name:"getActivePieces",outputs:[{name:"pieces",internalType:"struct Cids.Cid[]",type:"tuple[]",components:[{name:"data",internalType:"bytes",type:"bytes"}]},{name:"pieceIds",internalType:"uint256[]",type:"uint256[]"},{name:"rawSizes",internalType:"uint256[]",type:"uint256[]"},{name:"hasMore",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[],name:"getChallengeFinality",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getChallengeRange",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getDataSetLastProvenEpoch",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getDataSetLeafCount",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getDataSetListener",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getDataSetStorageProvider",outputs:[{name:"",internalType:"address",type:"address"},{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"getFILUSDPrice",outputs:[{name:"",internalType:"uint64",type:"uint64"},{name:"",internalType:"int32",type:"int32"}],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getNextChallengeEpoch",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"getNextDataSetId",outputs:[{name:"",internalType:"uint64",type:"uint64"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getNextPieceId",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"pieceId",internalType:"uint256",type:"uint256"}],name:"getPieceCid",outputs:[{name:"",internalType:"struct Cids.Cid",type:"tuple",components:[{name:"data",internalType:"bytes",type:"bytes"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"pieceId",internalType:"uint256",type:"uint256"}],name:"getPieceLeafCount",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"epoch",internalType:"uint256",type:"uint256"}],name:"getRandomness",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"getScheduledRemovals",outputs:[{name:"",internalType:"uint256[]",type:"uint256[]"}],stateMutability:"view"},{type:"function",inputs:[{name:"_challengeFinality",internalType:"uint256",type:"uint256"}],name:"initialize",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"migrate",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"challengeEpoch",internalType:"uint256",type:"uint256"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"nextProvingPeriod",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"owner",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"pieceId",internalType:"uint256",type:"uint256"}],name:"pieceChallengable",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"pieceId",internalType:"uint256",type:"uint256"}],name:"pieceLive",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"newStorageProvider",internalType:"address",type:"address"}],name:"proposeDataSetStorageProvider",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"proofs",internalType:"struct IPDPTypes.Proof[]",type:"tuple[]",components:[{name:"leaf",internalType:"bytes32",type:"bytes32"},{name:"proof",internalType:"bytes32[]",type:"bytes32[]"}]}],name:"provePossession",outputs:[],stateMutability:"payable"},{type:"function",inputs:[],name:"proxiableUUID",outputs:[{name:"",internalType:"bytes32",type:"bytes32"}],stateMutability:"view"},{type:"function",inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"},{name:"pieceIds",internalType:"uint256[]",type:"uint256[]"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"schedulePieceDeletions",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newOwner",internalType:"address",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newImplementation",internalType:"address",type:"address"},{name:"data",internalType:"bytes",type:"bytes"}],name:"upgradeToAndCall",outputs:[],stateMutability:"payable"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"string",type:"string",indexed:!1},{name:"implementation",internalType:"address",type:"address",indexed:!1}],name:"ContractUpgraded"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"storageProvider",internalType:"address",type:"address",indexed:!0}],name:"DataSetCreated"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"deletedLeafCount",internalType:"uint256",type:"uint256",indexed:!1}],name:"DataSetDeleted"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0}],name:"DataSetEmpty"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"uint64",type:"uint64",indexed:!1}],name:"Initialized"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"challengeEpoch",internalType:"uint256",type:"uint256",indexed:!1},{name:"leafCount",internalType:"uint256",type:"uint256",indexed:!1}],name:"NextProvingPeriod"},{type:"event",anonymous:!1,inputs:[{name:"previousOwner",internalType:"address",type:"address",indexed:!0},{name:"newOwner",internalType:"address",type:"address",indexed:!0}],name:"OwnershipTransferred"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"pieceIds",internalType:"uint256[]",type:"uint256[]",indexed:!1},{name:"pieceCids",internalType:"struct Cids.Cid[]",type:"tuple[]",components:[{name:"data",internalType:"bytes",type:"bytes"}],indexed:!1}],name:"PiecesAdded"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"pieceIds",internalType:"uint256[]",type:"uint256[]",indexed:!1}],name:"PiecesRemoved"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"challenges",internalType:"struct IPDPTypes.PieceIdAndOffset[]",type:"tuple[]",components:[{name:"pieceId",internalType:"uint256",type:"uint256"},{name:"offset",internalType:"uint256",type:"uint256"}],indexed:!1}],name:"PossessionProven"},{type:"event",anonymous:!1,inputs:[{name:"reason",internalType:"bytes",type:"bytes",indexed:!1}],name:"PriceOracleFailure"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"fee",internalType:"uint256",type:"uint256",indexed:!1},{name:"price",internalType:"uint64",type:"uint64",indexed:!1},{name:"expo",internalType:"int32",type:"int32",indexed:!1}],name:"ProofFeePaid"},{type:"event",anonymous:!1,inputs:[{name:"setId",internalType:"uint256",type:"uint256",indexed:!0},{name:"oldStorageProvider",internalType:"address",type:"address",indexed:!0},{name:"newStorageProvider",internalType:"address",type:"address",indexed:!0}],name:"StorageProviderChanged"},{type:"event",anonymous:!1,inputs:[{name:"implementation",internalType:"address",type:"address",indexed:!0}],name:"Upgraded"},{type:"error",inputs:[{name:"target",internalType:"address",type:"address"}],name:"AddressEmptyCode"},{type:"error",inputs:[{name:"implementation",internalType:"address",type:"address"}],name:"ERC1967InvalidImplementation"},{type:"error",inputs:[],name:"ERC1967NonPayable"},{type:"error",inputs:[],name:"FailedCall"},{type:"error",inputs:[{name:"idx",internalType:"uint256",type:"uint256"},{name:"msg",internalType:"string",type:"string"}],name:"IndexedError"},{type:"error",inputs:[],name:"InvalidInitialization"},{type:"error",inputs:[],name:"NotInitializing"},{type:"error",inputs:[{name:"owner",internalType:"address",type:"address"}],name:"OwnableInvalidOwner"},{type:"error",inputs:[{name:"account",internalType:"address",type:"address"}],name:"OwnableUnauthorizedAccount"},{type:"error",inputs:[],name:"UUPSUnauthorizedCallContext"},{type:"error",inputs:[{name:"slot",internalType:"bytes32",type:"bytes32"}],name:"UUPSUnsupportedProxiableUUID"}],WARM_STORAGE:[{type:"constructor",inputs:[{name:"_pdpVerifierAddress",internalType:"address",type:"address"},{name:"_paymentsContractAddress",internalType:"address",type:"address"},{name:"_usdfcTokenAddress",internalType:"address",type:"address"},{name:"_filCDNBeneficiaryAddress",internalType:"address",type:"address"},{name:"_serviceProviderRegistry",internalType:"contract ServiceProviderRegistry",type:"address"},{name:"_sessionKeyRegistry",internalType:"contract SessionKeyRegistry",type:"address"}],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"UPGRADE_INTERFACE_VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[],name:"VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"addApprovedProvider",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"totalBytes",internalType:"uint256",type:"uint256"}],name:"calculateRatesPerEpoch",outputs:[{name:"storageRate",internalType:"uint256",type:"uint256"},{name:"cacheMissRate",internalType:"uint256",type:"uint256"},{name:"cdnRate",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"_maxProvingPeriod",internalType:"uint64",type:"uint64"},{name:"_challengeWindowSize",internalType:"uint256",type:"uint256"}],name:"configureProvingPeriod",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"serviceProvider",internalType:"address",type:"address"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"dataSetCreated",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"",internalType:"uint256",type:"uint256"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"dataSetDeleted",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"eip712Domain",outputs:[{name:"fields",internalType:"bytes1",type:"bytes1"},{name:"name",internalType:"string",type:"string"},{name:"version",internalType:"string",type:"string"},{name:"chainId",internalType:"uint256",type:"uint256"},{name:"verifyingContract",internalType:"address",type:"address"},{name:"salt",internalType:"bytes32",type:"bytes32"},{name:"extensions",internalType:"uint256[]",type:"uint256[]"}],stateMutability:"view"},{type:"function",inputs:[{name:"slot",internalType:"bytes32",type:"bytes32"}],name:"extsload",outputs:[{name:"",internalType:"bytes32",type:"bytes32"}],stateMutability:"view"},{type:"function",inputs:[{name:"slot",internalType:"bytes32",type:"bytes32"},{name:"size",internalType:"uint256",type:"uint256"}],name:"extsloadStruct",outputs:[{name:"",internalType:"bytes32[]",type:"bytes32[]"}],stateMutability:"view"},{type:"function",inputs:[],name:"filCDNBeneficiaryAddress",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"getEffectiveRates",outputs:[{name:"serviceFee",internalType:"uint256",type:"uint256"},{name:"spPayment",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"epoch",internalType:"uint256",type:"uint256"}],name:"getProvingPeriodForEpoch",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"getServicePrice",outputs:[{name:"pricing",internalType:"struct FilecoinWarmStorageService.ServicePricing",type:"tuple",components:[{name:"pricePerTiBPerMonthNoCDN",internalType:"uint256",type:"uint256"},{name:"pricePerTiBPerMonthWithCDN",internalType:"uint256",type:"uint256"},{name:"tokenAddress",internalType:"address",type:"address"},{name:"epochsPerMonth",internalType:"uint256",type:"uint256"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"_maxProvingPeriod",internalType:"uint64",type:"uint64"},{name:"_challengeWindowSize",internalType:"uint256",type:"uint256"},{name:"_filCDNControllerAddress",internalType:"address",type:"address"},{name:"_name",internalType:"string",type:"string"},{name:"_description",internalType:"string",type:"string"}],name:"initialize",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"epoch",internalType:"uint256",type:"uint256"}],name:"isEpochProven",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"_viewContract",internalType:"address",type:"address"}],name:"migrate",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"challengeEpoch",internalType:"uint256",type:"uint256"},{name:"leafCount",internalType:"uint256",type:"uint256"},{name:"",internalType:"bytes",type:"bytes"}],name:"nextProvingPeriod",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"owner",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"paymentsContractAddress",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"pdpVerifierAddress",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"firstAdded",internalType:"uint256",type:"uint256"},{name:"pieceData",internalType:"struct Cids.Cid[]",type:"tuple[]",components:[{name:"data",internalType:"bytes",type:"bytes"}]},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"piecesAdded",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"pieceIds",internalType:"uint256[]",type:"uint256[]"},{name:"extraData",internalType:"bytes",type:"bytes"}],name:"piecesScheduledRemove",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"",internalType:"uint256",type:"uint256"},{name:"",internalType:"uint256",type:"uint256"},{name:"challengeCount",internalType:"uint256",type:"uint256"}],name:"possessionProven",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"proxiableUUID",outputs:[{name:"",internalType:"bytes32",type:"bytes32"}],stateMutability:"view"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"terminator",internalType:"address",type:"address"},{name:"endEpoch",internalType:"uint256",type:"uint256"}],name:"railTerminated",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"index",internalType:"uint256",type:"uint256"}],name:"removeApprovedProvider",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"serviceCommissionBps",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"serviceProviderRegistry",outputs:[{name:"",internalType:"contract ServiceProviderRegistry",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"sessionKeyRegistry",outputs:[{name:"",internalType:"contract SessionKeyRegistry",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"_viewContract",internalType:"address",type:"address"}],name:"setViewContract",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"oldServiceProvider",internalType:"address",type:"address"},{name:"newServiceProvider",internalType:"address",type:"address"},{name:"",internalType:"bytes",type:"bytes"}],name:"storageProviderChanged",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"terminateCDNService",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"terminateService",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newController",internalType:"address",type:"address"}],name:"transferFilCDNController",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newOwner",internalType:"address",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newCommissionBps",internalType:"uint256",type:"uint256"}],name:"updateServiceCommission",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newImplementation",internalType:"address",type:"address"},{name:"data",internalType:"bytes",type:"bytes"}],name:"upgradeToAndCall",outputs:[],stateMutability:"payable"},{type:"function",inputs:[],name:"usdfcTokenAddress",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"},{name:"proposedAmount",internalType:"uint256",type:"uint256"},{name:"fromEpoch",internalType:"uint256",type:"uint256"},{name:"toEpoch",internalType:"uint256",type:"uint256"},{name:"",internalType:"uint256",type:"uint256"}],name:"validatePayment",outputs:[{name:"result",internalType:"struct IValidator.ValidationResult",type:"tuple",components:[{name:"modifiedAmount",internalType:"uint256",type:"uint256"},{name:"settleUpto",internalType:"uint256",type:"uint256"},{name:"note",internalType:"string",type:"string"}]}],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"viewContractAddress",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"endEpoch",internalType:"uint256",type:"uint256",indexed:!1},{name:"cacheMissRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"cdnRailId",internalType:"uint256",type:"uint256",indexed:!1}],name:"CDNPaymentTerminated"},{type:"event",anonymous:!1,inputs:[{name:"caller",internalType:"address",type:"address",indexed:!0},{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"cacheMissRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"cdnRailId",internalType:"uint256",type:"uint256",indexed:!1}],name:"CDNServiceTerminated"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"string",type:"string",indexed:!1},{name:"implementation",internalType:"address",type:"address",indexed:!1}],name:"ContractUpgraded"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0},{name:"pdpRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"cacheMissRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"cdnRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"payer",internalType:"address",type:"address",indexed:!1},{name:"serviceProvider",internalType:"address",type:"address",indexed:!1},{name:"payee",internalType:"address",type:"address",indexed:!1},{name:"metadataKeys",internalType:"string[]",type:"string[]",indexed:!1},{name:"metadataValues",internalType:"string[]",type:"string[]",indexed:!1}],name:"DataSetCreated"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"oldServiceProvider",internalType:"address",type:"address",indexed:!0},{name:"newServiceProvider",internalType:"address",type:"address",indexed:!0}],name:"DataSetServiceProviderChanged"},{type:"event",anonymous:!1,inputs:[],name:"EIP712DomainChanged"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"periodsFaulted",internalType:"uint256",type:"uint256",indexed:!1},{name:"deadline",internalType:"uint256",type:"uint256",indexed:!1}],name:"FaultRecord"},{type:"event",anonymous:!1,inputs:[{name:"oldController",internalType:"address",type:"address",indexed:!1},{name:"newController",internalType:"address",type:"address",indexed:!1}],name:"FilCDNControllerChanged"},{type:"event",anonymous:!1,inputs:[{name:"name",internalType:"string",type:"string",indexed:!1},{name:"description",internalType:"string",type:"string",indexed:!1}],name:"FilecoinServiceDeployed"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"uint64",type:"uint64",indexed:!1}],name:"Initialized"},{type:"event",anonymous:!1,inputs:[{name:"previousOwner",internalType:"address",type:"address",indexed:!0},{name:"newOwner",internalType:"address",type:"address",indexed:!0}],name:"OwnershipTransferred"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"endEpoch",internalType:"uint256",type:"uint256",indexed:!1},{name:"pdpRailId",internalType:"uint256",type:"uint256",indexed:!1}],name:"PDPPaymentTerminated"},{type:"event",anonymous:!1,inputs:[{name:"railId",internalType:"uint256",type:"uint256",indexed:!1},{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!1},{name:"originalAmount",internalType:"uint256",type:"uint256",indexed:!1},{name:"modifiedAmount",internalType:"uint256",type:"uint256",indexed:!1},{name:"faultedEpochs",internalType:"uint256",type:"uint256",indexed:!1}],name:"PaymentArbitrated"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"pieceId",internalType:"uint256",type:"uint256",indexed:!0},{name:"keys",internalType:"string[]",type:"string[]",indexed:!1},{name:"values",internalType:"string[]",type:"string[]",indexed:!1}],name:"PieceAdded"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0}],name:"ProviderApproved"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0}],name:"ProviderUnapproved"},{type:"event",anonymous:!1,inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"railId",internalType:"uint256",type:"uint256",indexed:!1},{name:"newRate",internalType:"uint256",type:"uint256",indexed:!1}],name:"RailRateUpdated"},{type:"event",anonymous:!1,inputs:[{name:"caller",internalType:"address",type:"address",indexed:!0},{name:"dataSetId",internalType:"uint256",type:"uint256",indexed:!0},{name:"pdpRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"cacheMissRailId",internalType:"uint256",type:"uint256",indexed:!1},{name:"cdnRailId",internalType:"uint256",type:"uint256",indexed:!1}],name:"ServiceTerminated"},{type:"event",anonymous:!1,inputs:[{name:"implementation",internalType:"address",type:"address",indexed:!0}],name:"Upgraded"},{type:"event",anonymous:!1,inputs:[{name:"viewContract",internalType:"address",type:"address",indexed:!0}],name:"ViewContractSet"},{type:"error",inputs:[{name:"target",internalType:"address",type:"address"}],name:"AddressEmptyCode"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"expectedPayer",internalType:"address",type:"address"},{name:"expectedPayee",internalType:"address",type:"address"},{name:"caller",internalType:"address",type:"address"}],name:"CallerNotPayerOrPayee"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"CallerNotPayments"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"windowStart",internalType:"uint256",type:"uint256"},{name:"nowBlock",internalType:"uint256",type:"uint256"}],name:"ChallengeWindowTooEarly"},{type:"error",inputs:[{name:"commissionType",internalType:"enum Errors.CommissionType",type:"uint8"},{name:"max",internalType:"uint256",type:"uint256"},{name:"actual",internalType:"uint256",type:"uint256"}],name:"CommissionExceedsMaximum"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"DataSetNotFoundForRail"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"DataSetNotRegistered"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"DataSetPaymentAlreadyTerminated"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"pdpEndEpoch",internalType:"uint256",type:"uint256"},{name:"currentBlock",internalType:"uint256",type:"uint256"}],name:"DataSetPaymentBeyondEndEpoch"},{type:"error",inputs:[],name:"DivisionByZero"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"key",internalType:"string",type:"string"}],name:"DuplicateMetadataKey"},{type:"error",inputs:[{name:"implementation",internalType:"address",type:"address"}],name:"ERC1967InvalidImplementation"},{type:"error",inputs:[],name:"ERC1967NonPayable"},{type:"error",inputs:[],name:"ExtraDataRequired"},{type:"error",inputs:[],name:"FailedCall"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"FilCDNPaymentAlreadyTerminated"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"FilCDNServiceNotConfigured"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"minExpected",internalType:"uint256",type:"uint256"},{name:"actual",internalType:"uint256",type:"uint256"}],name:"InvalidChallengeCount"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"minAllowed",internalType:"uint256",type:"uint256"},{name:"maxAllowed",internalType:"uint256",type:"uint256"},{name:"actual",internalType:"uint256",type:"uint256"}],name:"InvalidChallengeEpoch"},{type:"error",inputs:[{name:"maxProvingPeriod",internalType:"uint256",type:"uint256"},{name:"challengeWindowSize",internalType:"uint256",type:"uint256"}],name:"InvalidChallengeWindowSize"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"InvalidDataSetId"},{type:"error",inputs:[{name:"fromEpoch",internalType:"uint256",type:"uint256"},{name:"toEpoch",internalType:"uint256",type:"uint256"}],name:"InvalidEpochRange"},{type:"error",inputs:[],name:"InvalidInitialization"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"InvalidSignature"},{type:"error",inputs:[{name:"expectedLength",internalType:"uint256",type:"uint256"},{name:"actualLength",internalType:"uint256",type:"uint256"}],name:"InvalidSignatureLength"},{type:"error",inputs:[],name:"MaxProvingPeriodZero"},{type:"error",inputs:[{name:"metadataArrayCount",internalType:"uint256",type:"uint256"},{name:"pieceCount",internalType:"uint256",type:"uint256"}],name:"MetadataArrayCountMismatch"},{type:"error",inputs:[{name:"keysLength",internalType:"uint256",type:"uint256"},{name:"valuesLength",internalType:"uint256",type:"uint256"}],name:"MetadataKeyAndValueLengthMismatch"},{type:"error",inputs:[{name:"index",internalType:"uint256",type:"uint256"},{name:"maxAllowed",internalType:"uint256",type:"uint256"},{name:"length",internalType:"uint256",type:"uint256"}],name:"MetadataKeyExceedsMaxLength"},{type:"error",inputs:[{name:"index",internalType:"uint256",type:"uint256"},{name:"maxAllowed",internalType:"uint256",type:"uint256"},{name:"length",internalType:"uint256",type:"uint256"}],name:"MetadataValueExceedsMaxLength"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"periodDeadline",internalType:"uint256",type:"uint256"},{name:"nowBlock",internalType:"uint256",type:"uint256"}],name:"NextProvingPeriodAlreadyCalled"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"NoPDPPaymentRail"},{type:"error",inputs:[],name:"NotInitializing"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"OldServiceProviderMismatch"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"OnlyFilCDNControllerAllowed"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"OnlyPDPVerifierAllowed"},{type:"error",inputs:[{name:"expected",internalType:"address",type:"address"},{name:"actual",internalType:"address",type:"address"}],name:"OnlySelf"},{type:"error",inputs:[{name:"owner",internalType:"address",type:"address"}],name:"OwnableInvalidOwner"},{type:"error",inputs:[{name:"account",internalType:"address",type:"address"}],name:"OwnableUnauthorizedAccount"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"pdpEndEpoch",internalType:"uint256",type:"uint256"},{name:"cdnEndEpoch",internalType:"uint256",type:"uint256"}],name:"PaymentRailsNotFinalized"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"ProofAlreadySubmitted"},{type:"error",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"ProviderAlreadyApproved"},{type:"error",inputs:[{name:"provider",internalType:"address",type:"address"},{name:"providerId",internalType:"uint256",type:"uint256"}],name:"ProviderNotApproved"},{type:"error",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"ProviderNotInApprovedList"},{type:"error",inputs:[{name:"provider",internalType:"address",type:"address"}],name:"ProviderNotRegistered"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"ProvingNotStarted"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"deadline",internalType:"uint256",type:"uint256"},{name:"nowBlock",internalType:"uint256",type:"uint256"}],name:"ProvingPeriodPassed"},{type:"error",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"RailNotAssociated"},{type:"error",inputs:[],name:"ServiceContractMustTerminateRail"},{type:"error",inputs:[{name:"maxAllowed",internalType:"uint256",type:"uint256"},{name:"keysLength",internalType:"uint256",type:"uint256"}],name:"TooManyMetadataKeys"},{type:"error",inputs:[],name:"UUPSUnauthorizedCallContext"},{type:"error",inputs:[{name:"slot",internalType:"bytes32",type:"bytes32"}],name:"UUPSUnsupportedProxiableUUID"},{type:"error",inputs:[{name:"v",internalType:"uint8",type:"uint8"}],name:"UnsupportedSignatureV"},{type:"error",inputs:[{name:"field",internalType:"enum Errors.AddressField",type:"uint8"}],name:"ZeroAddress"}],WARM_STORAGE_VIEW:[{type:"constructor",inputs:[{name:"_service",internalType:"contract FilecoinWarmStorageService",type:"address"}],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"challengeWindow",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"payer",internalType:"address",type:"address"}],name:"clientDataSetIDs",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"payer",internalType:"address",type:"address"}],name:"clientDataSets",outputs:[{name:"dataSetIds",internalType:"uint256[]",type:"uint256[]"}],stateMutability:"view"},{type:"function",inputs:[],name:"filCDNControllerAddress",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"getAllDataSetMetadata",outputs:[{name:"keys",internalType:"string[]",type:"string[]"},{name:"values",internalType:"string[]",type:"string[]"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"pieceId",internalType:"uint256",type:"uint256"}],name:"getAllPieceMetadata",outputs:[{name:"keys",internalType:"string[]",type:"string[]"},{name:"values",internalType:"string[]",type:"string[]"}],stateMutability:"view"},{type:"function",inputs:[],name:"getApprovedProviders",outputs:[{name:"providerIds",internalType:"uint256[]",type:"uint256[]"}],stateMutability:"view"},{type:"function",inputs:[],name:"getChallengesPerProof",outputs:[{name:"",internalType:"uint64",type:"uint64"}],stateMutability:"pure"},{type:"function",inputs:[{name:"client",internalType:"address",type:"address"}],name:"getClientDataSets",outputs:[{name:"infos",internalType:"struct FilecoinWarmStorageService.DataSetInfo[]",type:"tuple[]",components:[{name:"pdpRailId",internalType:"uint256",type:"uint256"},{name:"cacheMissRailId",internalType:"uint256",type:"uint256"},{name:"cdnRailId",internalType:"uint256",type:"uint256"},{name:"payer",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"serviceProvider",internalType:"address",type:"address"},{name:"commissionBps",internalType:"uint256",type:"uint256"},{name:"clientDataSetId",internalType:"uint256",type:"uint256"},{name:"pdpEndEpoch",internalType:"uint256",type:"uint256"},{name:"providerId",internalType:"uint256",type:"uint256"},{name:"cdnEndEpoch",internalType:"uint256",type:"uint256"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"getDataSet",outputs:[{name:"info",internalType:"struct FilecoinWarmStorageService.DataSetInfo",type:"tuple",components:[{name:"pdpRailId",internalType:"uint256",type:"uint256"},{name:"cacheMissRailId",internalType:"uint256",type:"uint256"},{name:"cdnRailId",internalType:"uint256",type:"uint256"},{name:"payer",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"serviceProvider",internalType:"address",type:"address"},{name:"commissionBps",internalType:"uint256",type:"uint256"},{name:"clientDataSetId",internalType:"uint256",type:"uint256"},{name:"pdpEndEpoch",internalType:"uint256",type:"uint256"},{name:"providerId",internalType:"uint256",type:"uint256"},{name:"cdnEndEpoch",internalType:"uint256",type:"uint256"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"key",internalType:"string",type:"string"}],name:"getDataSetMetadata",outputs:[{name:"exists",internalType:"bool",type:"bool"},{name:"value",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"leafCount",internalType:"uint256",type:"uint256"}],name:"getDataSetSizeInBytes",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"pure"},{type:"function",inputs:[],name:"getMaxProvingPeriod",outputs:[{name:"",internalType:"uint64",type:"uint64"}],stateMutability:"view"},{type:"function",inputs:[],name:"getPDPConfig",outputs:[{name:"maxProvingPeriod",internalType:"uint64",type:"uint64"},{name:"challengeWindowSize",internalType:"uint256",type:"uint256"},{name:"challengesPerProof",internalType:"uint256",type:"uint256"},{name:"initChallengeWindowStart",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"pieceId",internalType:"uint256",type:"uint256"},{name:"key",internalType:"string",type:"string"}],name:"getPieceMetadata",outputs:[{name:"exists",internalType:"bool",type:"bool"},{name:"value",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"isProviderApproved",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"nextPDPChallengeWindowStart",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"},{name:"periodId",internalType:"uint256",type:"uint256"}],name:"provenPeriods",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"provenThisPeriod",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"provingActivationEpoch",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"setId",internalType:"uint256",type:"uint256"}],name:"provingDeadline",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"railId",internalType:"uint256",type:"uint256"}],name:"railToDataSet",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"service",outputs:[{name:"",internalType:"contract FilecoinWarmStorageService",type:"address"}],stateMutability:"view"},{type:"error",inputs:[{name:"dataSetId",internalType:"uint256",type:"uint256"}],name:"ProvingPeriodNotInitialized"}],MULTICALL3:[{inputs:[{components:[{name:"target",type:"address"},{name:"allowFailure",type:"bool"},{name:"callData",type:"bytes"}],name:"calls",type:"tuple[]"}],name:"aggregate3",outputs:[{components:[{name:"success",type:"bool"},{name:"returnData",type:"bytes"}],name:"returnData",type:"tuple[]"}],stateMutability:"view",type:"function"},{inputs:[],name:"getCurrentBlockTimestamp",outputs:[{internalType:"uint256",name:"timestamp",type:"uint256"}],stateMutability:"view",type:"function"}],SERVICE_PROVIDER_REGISTRY:[{type:"constructor",inputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"BURN_ACTOR",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[],name:"MAX_CAPABILITIES",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"MAX_CAPABILITY_KEY_LENGTH",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"MAX_CAPABILITY_VALUE_LENGTH",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"REGISTRATION_FEE",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"UPGRADE_INTERFACE_VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[],name:"VERSION",outputs:[{name:"",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"}],name:"activeProductTypeProviderCount",outputs:[{name:"count",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[],name:"activeProviderCount",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"productData",internalType:"bytes",type:"bytes"},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"capabilityValues",internalType:"string[]",type:"string[]"}],name:"addProduct",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"providerAddress",internalType:"address",type:"address"}],name:"addressToProviderId",outputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"data",internalType:"bytes",type:"bytes"}],name:"decodePDPOffering",outputs:[{name:"",internalType:"struct ServiceProviderRegistryStorage.PDPOffering",type:"tuple",components:[{name:"serviceURL",internalType:"string",type:"string"},{name:"minPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"maxPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"ipniPiece",internalType:"bool",type:"bool"},{name:"ipniIpfs",internalType:"bool",type:"bool"},{name:"storagePricePerTibPerMonth",internalType:"uint256",type:"uint256"},{name:"minProvingPeriodInEpochs",internalType:"uint256",type:"uint256"},{name:"location",internalType:"string",type:"string"},{name:"paymentTokenAddress",internalType:"contract IERC20",type:"address"}]}],stateMutability:"pure"},{type:"function",inputs:[],name:"eip712Domain",outputs:[{name:"fields",internalType:"bytes1",type:"bytes1"},{name:"name",internalType:"string",type:"string"},{name:"version",internalType:"string",type:"string"},{name:"chainId",internalType:"uint256",type:"uint256"},{name:"verifyingContract",internalType:"address",type:"address"},{name:"salt",internalType:"bytes32",type:"bytes32"},{name:"extensions",internalType:"uint256[]",type:"uint256[]"}],stateMutability:"view"},{type:"function",inputs:[{name:"pdpOffering",internalType:"struct ServiceProviderRegistryStorage.PDPOffering",type:"tuple",components:[{name:"serviceURL",internalType:"string",type:"string"},{name:"minPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"maxPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"ipniPiece",internalType:"bool",type:"bool"},{name:"ipniIpfs",internalType:"bool",type:"bool"},{name:"storagePricePerTibPerMonth",internalType:"uint256",type:"uint256"},{name:"minProvingPeriodInEpochs",internalType:"uint256",type:"uint256"},{name:"location",internalType:"string",type:"string"},{name:"paymentTokenAddress",internalType:"contract IERC20",type:"address"}]}],name:"encodePDPOffering",outputs:[{name:"",internalType:"bytes",type:"bytes"}],stateMutability:"pure"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"offset",internalType:"uint256",type:"uint256"},{name:"limit",internalType:"uint256",type:"uint256"}],name:"getActiveProvidersByProductType",outputs:[{name:"result",internalType:"struct ServiceProviderRegistryStorage.PaginatedProviders",type:"tuple",components:[{name:"providers",internalType:"struct ServiceProviderRegistryStorage.ProviderWithProduct[]",type:"tuple[]",components:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"providerInfo",internalType:"struct ServiceProviderRegistryStorage.ServiceProviderInfo",type:"tuple",components:[{name:"serviceProvider",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"},{name:"isActive",internalType:"bool",type:"bool"}]},{name:"product",internalType:"struct ServiceProviderRegistryStorage.ServiceProduct",type:"tuple",components:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"productData",internalType:"bytes",type:"bytes"},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"isActive",internalType:"bool",type:"bool"}]}]},{name:"hasMore",internalType:"bool",type:"bool"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"offset",internalType:"uint256",type:"uint256"},{name:"limit",internalType:"uint256",type:"uint256"}],name:"getAllActiveProviders",outputs:[{name:"providerIds",internalType:"uint256[]",type:"uint256[]"},{name:"hasMore",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[],name:"getNextProviderId",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"getPDPService",outputs:[{name:"pdpOffering",internalType:"struct ServiceProviderRegistryStorage.PDPOffering",type:"tuple",components:[{name:"serviceURL",internalType:"string",type:"string"},{name:"minPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"maxPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"ipniPiece",internalType:"bool",type:"bool"},{name:"ipniIpfs",internalType:"bool",type:"bool"},{name:"storagePricePerTibPerMonth",internalType:"uint256",type:"uint256"},{name:"minProvingPeriodInEpochs",internalType:"uint256",type:"uint256"},{name:"location",internalType:"string",type:"string"},{name:"paymentTokenAddress",internalType:"contract IERC20",type:"address"}]},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"isActive",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"}],name:"getProduct",outputs:[{name:"productData",internalType:"bytes",type:"bytes"},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"isActive",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"keys",internalType:"string[]",type:"string[]"}],name:"getProductCapabilities",outputs:[{name:"exists",internalType:"bool[]",type:"bool[]"},{name:"values",internalType:"string[]",type:"string[]"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"key",internalType:"string",type:"string"}],name:"getProductCapability",outputs:[{name:"exists",internalType:"bool",type:"bool"},{name:"value",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"getProvider",outputs:[{name:"info",internalType:"struct ServiceProviderRegistryStorage.ServiceProviderInfo",type:"tuple",components:[{name:"serviceProvider",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"},{name:"isActive",internalType:"bool",type:"bool"}]}],stateMutability:"view"},{type:"function",inputs:[{name:"providerAddress",internalType:"address",type:"address"}],name:"getProviderByAddress",outputs:[{name:"info",internalType:"struct ServiceProviderRegistryStorage.ServiceProviderInfo",type:"tuple",components:[{name:"serviceProvider",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"},{name:"isActive",internalType:"bool",type:"bool"}]}],stateMutability:"view"},{type:"function",inputs:[],name:"getProviderCount",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerAddress",internalType:"address",type:"address"}],name:"getProviderIdByAddress",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"offset",internalType:"uint256",type:"uint256"},{name:"limit",internalType:"uint256",type:"uint256"}],name:"getProvidersByProductType",outputs:[{name:"result",internalType:"struct ServiceProviderRegistryStorage.PaginatedProviders",type:"tuple",components:[{name:"providers",internalType:"struct ServiceProviderRegistryStorage.ProviderWithProduct[]",type:"tuple[]",components:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"providerInfo",internalType:"struct ServiceProviderRegistryStorage.ServiceProviderInfo",type:"tuple",components:[{name:"serviceProvider",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"},{name:"isActive",internalType:"bool",type:"bool"}]},{name:"product",internalType:"struct ServiceProviderRegistryStorage.ServiceProduct",type:"tuple",components:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"productData",internalType:"bytes",type:"bytes"},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"isActive",internalType:"bool",type:"bool"}]}]},{name:"hasMore",internalType:"bool",type:"bool"}]}],stateMutability:"view"},{type:"function",inputs:[],name:"initialize",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"isProviderActive",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"provider",internalType:"address",type:"address"}],name:"isRegisteredProvider",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"newVersion",internalType:"string",type:"string"}],name:"migrate",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"owner",outputs:[{name:"",internalType:"address",type:"address"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"key",internalType:"string",type:"string"}],name:"productCapabilities",outputs:[{name:"value",internalType:"string",type:"string"}],stateMutability:"view"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"}],name:"productTypeProviderCount",outputs:[{name:"count",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"}],name:"providerHasProduct",outputs:[{name:"",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"}],name:"providerProducts",outputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"productData",internalType:"bytes",type:"bytes"},{name:"isActive",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],name:"providers",outputs:[{name:"serviceProvider",internalType:"address",type:"address"},{name:"payee",internalType:"address",type:"address"},{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"},{name:"isActive",internalType:"bool",type:"bool"}],stateMutability:"view"},{type:"function",inputs:[],name:"proxiableUUID",outputs:[{name:"",internalType:"bytes32",type:"bytes32"}],stateMutability:"view"},{type:"function",inputs:[{name:"payee",internalType:"address",type:"address"},{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"productData",internalType:"bytes",type:"bytes"},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"capabilityValues",internalType:"string[]",type:"string[]"}],name:"registerProvider",outputs:[{name:"providerId",internalType:"uint256",type:"uint256"}],stateMutability:"payable"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"}],name:"removeProduct",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"removeProvider",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newOwner",internalType:"address",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"pdpOffering",internalType:"struct ServiceProviderRegistryStorage.PDPOffering",type:"tuple",components:[{name:"serviceURL",internalType:"string",type:"string"},{name:"minPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"maxPieceSizeInBytes",internalType:"uint256",type:"uint256"},{name:"ipniPiece",internalType:"bool",type:"bool"},{name:"ipniIpfs",internalType:"bool",type:"bool"},{name:"storagePricePerTibPerMonth",internalType:"uint256",type:"uint256"},{name:"minProvingPeriodInEpochs",internalType:"uint256",type:"uint256"},{name:"location",internalType:"string",type:"string"},{name:"paymentTokenAddress",internalType:"contract IERC20",type:"address"}]},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"capabilityValues",internalType:"string[]",type:"string[]"}],name:"updatePDPServiceWithCapabilities",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8"},{name:"productData",internalType:"bytes",type:"bytes"},{name:"capabilityKeys",internalType:"string[]",type:"string[]"},{name:"capabilityValues",internalType:"string[]",type:"string[]"}],name:"updateProduct",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"name",internalType:"string",type:"string"},{name:"description",internalType:"string",type:"string"}],name:"updateProviderInfo",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"newImplementation",internalType:"address",type:"address"},{name:"data",internalType:"bytes",type:"bytes"}],name:"upgradeToAndCall",outputs:[],stateMutability:"payable"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"string",type:"string",indexed:!1},{name:"implementation",internalType:"address",type:"address",indexed:!1}],name:"ContractUpgraded"},{type:"event",anonymous:!1,inputs:[],name:"EIP712DomainChanged"},{type:"event",anonymous:!1,inputs:[{name:"version",internalType:"uint64",type:"uint64",indexed:!1}],name:"Initialized"},{type:"event",anonymous:!1,inputs:[{name:"previousOwner",internalType:"address",type:"address",indexed:!0},{name:"newOwner",internalType:"address",type:"address",indexed:!0}],name:"OwnershipTransferred"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8",indexed:!0},{name:"serviceUrl",internalType:"string",type:"string",indexed:!1},{name:"serviceProvider",internalType:"address",type:"address",indexed:!1},{name:"capabilityKeys",internalType:"string[]",type:"string[]",indexed:!1},{name:"capabilityValues",internalType:"string[]",type:"string[]",indexed:!1}],name:"ProductAdded"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8",indexed:!0}],name:"ProductRemoved"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0},{name:"productType",internalType:"enum ServiceProviderRegistryStorage.ProductType",type:"uint8",indexed:!0},{name:"serviceUrl",internalType:"string",type:"string",indexed:!1},{name:"serviceProvider",internalType:"address",type:"address",indexed:!1},{name:"capabilityKeys",internalType:"string[]",type:"string[]",indexed:!1},{name:"capabilityValues",internalType:"string[]",type:"string[]",indexed:!1}],name:"ProductUpdated"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0}],name:"ProviderInfoUpdated"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0},{name:"serviceProvider",internalType:"address",type:"address",indexed:!0},{name:"payee",internalType:"address",type:"address",indexed:!0}],name:"ProviderRegistered"},{type:"event",anonymous:!1,inputs:[{name:"providerId",internalType:"uint256",type:"uint256",indexed:!0}],name:"ProviderRemoved"},{type:"event",anonymous:!1,inputs:[{name:"implementation",internalType:"address",type:"address",indexed:!0}],name:"Upgraded"},{type:"error",inputs:[{name:"target",internalType:"address",type:"address"}],name:"AddressEmptyCode"},{type:"error",inputs:[{name:"implementation",internalType:"address",type:"address"}],name:"ERC1967InvalidImplementation"},{type:"error",inputs:[],name:"ERC1967NonPayable"},{type:"error",inputs:[],name:"FailedCall"},{type:"error",inputs:[],name:"InvalidInitialization"},{type:"error",inputs:[],name:"NotInitializing"},{type:"error",inputs:[{name:"owner",internalType:"address",type:"address"}],name:"OwnableInvalidOwner"},{type:"error",inputs:[{name:"account",internalType:"address",type:"address"}],name:"OwnableUnauthorizedAccount"},{type:"error",inputs:[],name:"UUPSUnauthorizedCallContext"},{type:"error",inputs:[{name:"slot",internalType:"bytes32",type:"bytes32"}],name:"UUPSUnsupportedProxiableUUID"}],SESSION_KEY_REGISTRY:[{type:"function",inputs:[{name:"user",internalType:"address",type:"address"},{name:"signer",internalType:"address",type:"address"},{name:"permission",internalType:"bytes32",type:"bytes32"}],name:"authorizationExpiry",outputs:[{name:"",internalType:"uint256",type:"uint256"}],stateMutability:"view"},{type:"function",inputs:[{name:"signer",internalType:"address",type:"address"},{name:"expiry",internalType:"uint256",type:"uint256"},{name:"permissions",internalType:"bytes32[]",type:"bytes32[]"}],name:"login",outputs:[],stateMutability:"nonpayable"},{type:"function",inputs:[{name:"signer",internalType:"address payable",type:"address"},{name:"expiry",internalType:"uint256",type:"uint256"},{name:"permissions",internalType:"bytes32[]",type:"bytes32[]"}],name:"loginAndFund",outputs:[],stateMutability:"payable"},{type:"function",inputs:[{name:"signer",internalType:"address",type:"address"},{name:"permissions",internalType:"bytes32[]",type:"bytes32[]"}],name:"revoke",outputs:[],stateMutability:"nonpayable"}]},u={EPOCH_DURATION:30,EPOCHS_PER_DAY:2880n,EPOCHS_PER_MONTH:86400n,DAYS_PER_MONTH:30n,DEFAULT_LOCKUP_DAYS:10n},l={mainnet:1598306400,calibration:1667326380},c={KiB:1024n,MiB:1048576n,GiB:1073741824n,TiB:1099511627776n,MAX_UPLOAD_SIZE:209715200,MIN_UPLOAD_SIZE:127,DEFAULT_UPLOAD_BATCH_SIZE:32},y={WITH_CDN:"withCDN",WITH_IPFS_INDEXING:"withIPFSIndexing",IPFS_ROOT_CID:"ipfsRootCID"},m={TRANSACTION_PROPAGATION_TIMEOUT_MS:3e4,TRANSACTION_PROPAGATION_POLL_INTERVAL_MS:2e3,DATA_SET_CREATION_TIMEOUT_MS:42e4,DATA_SET_CREATION_POLL_INTERVAL_MS:2e3,PIECE_PARKING_TIMEOUT_MS:42e4,PIECE_PARKING_POLL_INTERVAL_MS:5e3,TRANSACTION_CONFIRMATIONS:1,PIECE_ADDITION_TIMEOUT_MS:42e4,PIECE_ADDITION_POLL_INTERVAL_MS:1e3},h=1300000000000000n,g={mainnet:{http:"https://api.node.glif.io/rpc/v1",websocket:"wss://wss.node.glif.io/apigw/lotus/rpc/v1"},calibration:{http:"https://api.calibration.node.glif.io/rpc/v1",websocket:"wss://wss.calibration.node.glif.io/apigw/lotus/rpc/v1"}},f={WARM_STORAGE:{mainnet:"0x81DFD9813aDd354f03704F31419b0c6268d46232",calibration:"0x80617b65FD2EEa1D7fDe2B4F85977670690ed348"},MULTICALL3:{mainnet:"0xcA11bde05977b3631167028862bE2a173976CA11",calibration:"0xcA11bde05977b3631167028862bE2a173976CA11"},USDFC:{mainnet:"0x80B98d3aa09ffff255c3ba4A241111Ff1262F045",calibration:"0xb3042734b608a1B16e9e86B374A3f3e389B4cDf0"}};function v(e,t,n,a){let r=`${e} ${t} failed: ${n}`;return null!=a&&a instanceof Error&&(r=`${r} - ${a.message}`),null!=a?new Error(r,{cause:a}):new Error(r)}function w(e,t){const n=l[t],a=u.EPOCH_DURATION;return new Date(1e3*(n+e*a))}function T(e,t){const n=l[t],a=u.EPOCH_DURATION,r=Math.floor(e.getTime()/1e3)-n;return Math.floor(r/a)}function S(e){return l[e]}function P(e,t){const n=e-t,a=n*u.EPOCH_DURATION;return{epochs:n,seconds:a,minutes:a/60,hours:a/3600,days:a/86400}}function b(e,t,n){if(0===e)return null;const a=e-t;return a<=0?null:w(a,n)}async function I(e){const t=await e.getBlockNumber();if(null==t)throw v("epoch","getCurrentEpoch","Failed to get latest block number");return BigInt(t)}const C=128;function A(e){return Object.entries(e).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>({key:e,value:t}))}function D(e){const t=Array.isArray(e)?e:A(e);if(t.length>5)throw new Error(`Too many metadata keys for piece: ${t.length} (max: 5)`);for(const{key:e,value:n}of t){if(e.length>32)throw new Error(`Metadata key "${e}" exceeds max length: ${e.length} bytes (max: 32)`);if(n.length>C)throw new Error(`Metadata value for key "${e}" exceeds max length: ${n.length} bytes (max: 128)`)}}function _(e,t){const n=Object.keys(e),a=Object.keys(t);if(n.length!==a.length)return!1;if(0===a.length)return!0;for(const n of a)if(e[n]!==t[n])return!1;return!0}function E(e={},t){return null==t||y.WITH_CDN in e?e:t?{...e,[y.WITH_CDN]:""}:e}async function x(e){try{const t=await e.getNetwork(),n=Number(t.chainId);if(n===p.mainnet)return"mainnet";if(n===p.calibration)return"calibration";throw v("NetworkUtils","getFilecoinNetworkType",`Unsupported network: chain ID ${n}. Only Filecoin mainnet (${p.mainnet}) and calibration (${p.calibration}) are supported.`)}catch(e){if(e instanceof Error&&e.message.includes("Unsupported network"))throw e;throw v("NetworkUtils","getFilecoinNetworkType",`Failed to detect network: ${e instanceof Error?e.message:String(e)}`)}}function R(e,t){return`${e.replace(/\/$/,"")}/piece/${t.toString()}`}function M(e,t){return`${e.replace(/\/$/,"")}/pdp/piece?${new URLSearchParams({pieceCid:t.toString()}).toString()}`}class k{_provider;_signer;_paymentsAddress;_usdfcAddress;_disableNonceManager;_usdfcContract=null;_paymentsContract=null;constructor(e,t,n,a,r){this._provider=e,this._signer=t,this._paymentsAddress=n,this._usdfcAddress=a,this._disableNonceManager=r}_getUsdfcContract(){return null==this._usdfcContract&&(this._usdfcContract=new e.Contract(this._usdfcAddress,d.ERC20,this._signer)),this._usdfcContract}_getPaymentsContract(){return null==this._paymentsContract&&(this._paymentsContract=new e.Contract(this._paymentsAddress,d.PAYMENTS,this._signer)),this._paymentsContract}async balance(e=o.USDFC){if(e!==o.USDFC)throw v("PaymentsService","payments contract balance check",`Token "${e}" is not supported. Currently only USDFC token is supported for payments contract balance queries.`);return(await this.accountInfo(e)).availableFunds}async accountInfo(e=o.USDFC){if(e!==o.USDFC)throw v("PaymentsService","account info",`Token "${e}" is not supported. Currently only USDFC token is supported.`);const t=await this._signer.getAddress(),n=this._getPaymentsContract();let a;try{a=await n.accounts(this._usdfcAddress,t)}catch(e){throw v("PaymentsService","account info","Failed to read account information from payments contract. This could indicate the contract is not properly deployed, the ABI is incorrect, or there are network connectivity issues.",e)}const[r,i,s,p]=a,d=await I(this._provider)-BigInt(p),u=BigInt(i)+BigInt(s)*d,l=BigInt(r)-u;return{funds:BigInt(r),lockupCurrent:BigInt(i),lockupRate:BigInt(s),lockupLastSettledAt:BigInt(p),availableFunds:l>0n?l:0n}}async walletBalance(e){if(null==e||e===o.FIL)try{const e=await this._signer.getAddress();return await this._provider.getBalance(e)}catch(e){throw v("PaymentsService","wallet FIL balance check","Unable to retrieve FIL balance from wallet. This could be due to network connectivity issues, RPC endpoint problems, or wallet connection issues.",e)}if(e===o.USDFC)try{const e=await this._signer.getAddress(),t=this._getUsdfcContract();return await t.balanceOf(e)}catch(e){throw v("PaymentsService","wallet USDFC balance check","Unexpected error while checking USDFC token balance in wallet.",e)}throw v("PaymentsService","wallet balance",`Token "${e}" is not supported. Currently only FIL and USDFC tokens are supported.`)}decimals(e=o.USDFC){return 18}async allowance(e,t=o.USDFC){if(t!==o.USDFC)throw v("PaymentsService","allowance",`Token "${t}" is not supported. Currently only USDFC token is supported.`);const n=await this._signer.getAddress(),a=this._getUsdfcContract();try{return await a.allowance(n,e)}catch(e){throw v("PaymentsService","allowance check","Failed to check token allowance. This could indicate network connectivity issues or an invalid spender address.",e)}}async approve(e,t,n=o.USDFC){if(n!==o.USDFC)throw v("PaymentsService","approve",`Token "${n}" is not supported. Currently only USDFC token is supported.`);const a="bigint"==typeof t?t:BigInt(t);if(a<0n)throw v("PaymentsService","approve","Approval amount cannot be negative");const r=await this._signer.getAddress(),i=this._getUsdfcContract(),s={};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(r,"pending");s.nonce=e}try{return await i.approve(e,a,s)}catch(t){throw v("PaymentsService","approve",`Failed to approve ${e} to spend ${a.toString()} ${n}`,t)}}async approveService(e,t,n,a,r=o.USDFC){if(r!==o.USDFC)throw v("PaymentsService","approveService",`Token "${r}" is not supported. Currently only USDFC token is supported.`);const i="bigint"==typeof t?t:BigInt(t),s="bigint"==typeof n?n:BigInt(n),p="bigint"==typeof a?a:BigInt(a);if(i<0n||s<0n||p<0n)throw v("PaymentsService","approveService","Allowance values cannot be negative");const d=await this._signer.getAddress(),u=this._getPaymentsContract(),l={};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(d,"pending");l.nonce=e}try{return await u.setOperatorApproval(this._usdfcAddress,e,!0,i,s,p,l)}catch(t){throw v("PaymentsService","approveService",`Failed to approve service ${e} as operator for ${r}`,t)}}async revokeService(e,t=o.USDFC){if(t!==o.USDFC)throw v("PaymentsService","revokeService",`Token "${t}" is not supported. Currently only USDFC token is supported.`);const n=await this._signer.getAddress(),a=this._getPaymentsContract(),r={};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(n,"pending");r.nonce=e}try{return await a.setOperatorApproval(this._usdfcAddress,e,!1,0n,0n,0n,r)}catch(n){throw v("PaymentsService","revokeService",`Failed to revoke service ${e} as operator for ${t}`,n)}}async serviceApproval(e,t=o.USDFC){if(t!==o.USDFC)throw v("PaymentsService","serviceApproval",`Token "${t}" is not supported. Currently only USDFC token is supported.`);const n=await this._signer.getAddress(),a=this._getPaymentsContract();try{const t=await a.operatorApprovals(this._usdfcAddress,n,e);return{isApproved:t[0],rateAllowance:t[1],lockupAllowance:t[2],rateUsed:t[3],lockupUsed:t[4],maxLockupPeriod:t[5]}}catch(t){throw v("PaymentsService","serviceApproval",`Failed to check service approval status for ${e}`,t)}}async deposit(e,t=o.USDFC,n){if(t!==o.USDFC)throw v("PaymentsService","deposit",`Unsupported token: ${t}`);const a="bigint"==typeof e?e:BigInt(e);if(a<=0n)throw v("PaymentsService","deposit","Invalid amount");const r=await this._signer.getAddress(),i=this._getUsdfcContract(),s=this._getPaymentsContract(),p=await i.balanceOf(r);if(p<a)throw v("PaymentsService","deposit",`Insufficient USDFC: have ${BigInt(p).toString()}, need ${a.toString()}`);const d=await this.allowance(this._paymentsAddress,t);if(n?.onAllowanceCheck?.(d,a),d<a){const e=await this.approve(this._paymentsAddress,a,t);n?.onApprovalTransaction?.(e);const r=await e.wait(m.TRANSACTION_CONFIRMATIONS);null!=r&&n?.onApprovalConfirmed?.(r)}n?.onDepositStarting?.();const u={};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(r,"pending");u.nonce=e}return await s.deposit(this._usdfcAddress,r,a,u)}async withdraw(e,t=o.USDFC){if(t!==o.USDFC)throw v("PaymentsService","withdraw",`Unsupported token: ${t}`);const n="bigint"==typeof e?e:BigInt(e);if(n<=0n)throw v("PaymentsService","withdraw","Invalid amount");const a=await this._signer.getAddress(),r=this._getPaymentsContract(),i=await this.accountInfo(t);if(i.availableFunds<n)throw v("PaymentsService","withdraw",`Insufficient available balance: have ${i.availableFunds.toString()}, need ${n.toString()}`);const s={};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(a,"pending");s.nonce=e}return await r.withdraw(this._usdfcAddress,n,s)}async settle(e,t){const n="bigint"==typeof e?e:BigInt(e),[a,r]=await Promise.all([this._signer.getAddress(),null==t?I(this._provider):Promise.resolve(null)]),i=null==t?r:BigInt(t),s=this._getPaymentsContract(),o={value:h};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(a,"pending");o.nonce=e}try{return await s.settleRail(n,i,o)}catch(e){throw v("PaymentsService","settle",`Failed to settle rail ${n.toString()} up to epoch ${i.toString()}`,e)}}async getSettlementAmounts(e,t){const n="bigint"==typeof e?e:BigInt(e),a=null==t?await I(this._provider):null,r=null==t?a:BigInt(t),i=this._getPaymentsContract();try{const e=await i.settleRail.staticCall(n,r,{value:h});return{totalSettledAmount:e[0],totalNetPayeeAmount:e[1],totalOperatorCommission:e[2],finalSettledEpoch:e[3],note:e[4]}}catch(e){throw v("PaymentsService","getSettlementAmounts",`Failed to get settlement amounts for rail ${n.toString()} up to epoch ${r.toString()}`,e)}}async settleTerminatedRail(e){const t="bigint"==typeof e?e:BigInt(e),n=await this._signer.getAddress(),a=this._getPaymentsContract(),r={};if(this._disableNonceManager){const e=await this._provider.getTransactionCount(n,"pending");r.nonce=e}try{return await a.settleTerminatedRailWithoutValidation(t,r)}catch(e){throw v("PaymentsService","settleTerminatedRail",`Failed to settle terminated rail ${t.toString()}`,e)}}async getRail(e){const t="bigint"==typeof e?e:BigInt(e),n=this._getPaymentsContract();try{const e=await n.getRail(t);return{token:e.token,from:e.from,to:e.to,operator:e.operator,validator:e.validator,paymentRate:e.paymentRate,lockupPeriod:e.lockupPeriod,lockupFixed:e.lockupFixed,settledUpTo:e.settledUpTo,endEpoch:e.endEpoch,commissionRateBps:e.commissionRateBps,serviceFeeRecipient:e.serviceFeeRecipient}}catch(e){if(e.message?.includes("RailInactiveOrSettled"))throw v("PaymentsService","getRail",`Rail ${t.toString()} does not exist or is inactive`);throw v("PaymentsService","getRail",`Failed to get rail ${t.toString()}`,e)}}async settleAuto(e,t){const n="bigint"==typeof e?e:BigInt(e);return(await this.getRail(n)).endEpoch>0n?await this.settleTerminatedRail(n):await this.settle(n,t)}async getRailsAsPayer(e=o.USDFC){if(e!==o.USDFC)throw v("PaymentsService","getRailsAsPayer",`Token "${e}" is not supported. Currently only USDFC token is supported.`);const t=await this._signer.getAddress(),n=this._getPaymentsContract();try{return(await n.getRailsForPayerAndToken(t,this._usdfcAddress)).map(e=>({railId:Number(e.railId),isTerminated:e.isTerminated,endEpoch:Number(e.endEpoch)}))}catch(e){throw v("PaymentsService","getRailsAsPayer","Failed to get rails where wallet is payer",e)}}async getRailsAsPayee(e=o.USDFC){if(e!==o.USDFC)throw v("PaymentsService","getRailsAsPayee",`Token "${e}" is not supported. Currently only USDFC token is supported.`);const t=await this._signer.getAddress(),n=this._getPaymentsContract();try{return(await n.getRailsForPayeeAndToken(t,this._usdfcAddress)).map(e=>({railId:Number(e.railId),isTerminated:e.isTerminated,endEpoch:Number(e.endEpoch)}))}catch(e){throw v("PaymentsService","getRailsAsPayee","Failed to get rails where wallet is payee",e)}}}async function N(e,t){const n=On(t);if(null==n)throw new Error(`Invalid PieceCID: ${String(t)}`);if(!e.ok)throw new Error(`Download failed: ${e.status} ${e.statusText}`);if(null==e.body)throw new Error("Response body is null");const{stream:a,getPieceCID:r}=Ln(),i=[],s=new TransformStream({transform(e,t){i.push(e),t.enqueue(e)}}),o=e.body.pipeThrough(a).pipeThrough(s).getReader();try{for(;;){const{done:e}=await o.read();if(e)break}}finally{o.releaseLock()}if(0===i.length)throw new Error("Response body is null");const p=r();if(null==p)throw new Error("Failed to calculate PieceCID from stream");if(p.toString()!==n.toString())throw new Error(`PieceCID verification failed. Expected: ${String(n)}, Got: ${String(p)}`);const d=i.reduce((e,t)=>e+t.length,0),u=new Uint8Array(d);let l=0;for(const e of i)u.set(e,l),l+=e.length;return u}async function U(e,t){const n=await fetch(e);return await N(n,t)}BigInt(4);const F=127,O=BigInt(F),$=(BigInt(128),.9921875),B=32,L=BigInt(B),V=()=>W,W=(e=>{if(e instanceof Uint8Array){if(e.length>B)return e.subarray(0,B);if(e.length==B)return e}const t=new Uint8Array(B);return t.set([...e]),t})(new Uint8Array(B).fill(0));Object.freeze(W.buffer);const z=new Uint8Array(0);function j(e){if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}function H(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function G(e,t){!function(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const K=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),q=(e,t)=>e<<32-t|e>>>t;if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");function Y(e){if("string"==typeof e&&(e=function(e){if("string"!=typeof e)throw new Error("utf8ToBytes expected string, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e)),!(e instanceof Uint8Array))throw new Error("expected Uint8Array, got "+typeof e);return e}class Z{clone(){return this._cloneInto()}}function Q(e){const t=t=>e().update(Y(t)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}class X extends Z{constructor(e,t,n,a){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=a,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=K(this.buffer)}update(e){H(this);const{view:t,buffer:n,blockLen:a}=this,r=(e=Y(e)).length;for(let i=0;i<r;){const s=Math.min(a-this.pos,r-i);if(s===a){const t=K(e);for(;a<=r-i;i+=a)this.process(t,i);continue}n.set(e.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===a&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){H(this),G(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:a,isLE:r}=this;let{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>a-i&&(this.process(n,0),i=0);for(let e=i;e<a;e++)t[e]=0;!function(e,t,n,a){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,n,a);const r=BigInt(32),i=BigInt(4294967295),s=Number(n>>r&i),o=Number(n&i),p=a?4:0,d=a?0:4;e.setUint32(t+p,s,a),e.setUint32(t+d,o,a)}(n,a-8,BigInt(8*this.length),r),this.process(n,0);const s=K(e),o=this.outputLen;if(o%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const p=o/4,d=this.get();if(p>d.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<p;e++)s.setUint32(4*e,d[e],r)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:a,finished:r,destroyed:i,pos:s}=this;return e.length=a,e.pos=s,e.finished=r,e.destroyed=i,a%t&&e.buffer.set(n),e}}const J=(e,t,n)=>e&t^~e&n,ee=(e,t,n)=>e&t^e&n^t&n,te=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ne=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ae=new Uint32Array(64);class re extends X{constructor(){super(64,32,8,!1),this.A=0|ne[0],this.B=0|ne[1],this.C=0|ne[2],this.D=0|ne[3],this.E=0|ne[4],this.F=0|ne[5],this.G=0|ne[6],this.H=0|ne[7]}get(){const{A:e,B:t,C:n,D:a,E:r,F:i,G:s,H:o}=this;return[e,t,n,a,r,i,s,o]}set(e,t,n,a,r,i,s,o){this.A=0|e,this.B=0|t,this.C=0|n,this.D=0|a,this.E=0|r,this.F=0|i,this.G=0|s,this.H=0|o}process(e,t){for(let n=0;n<16;n++,t+=4)ae[n]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=ae[e-15],n=ae[e-2],a=q(t,7)^q(t,18)^t>>>3,r=q(n,17)^q(n,19)^n>>>10;ae[e]=r+ae[e-7]+a+ae[e-16]|0}let{A:n,B:a,C:r,D:i,E:s,F:o,G:p,H:d}=this;for(let e=0;e<64;e++){const t=d+(q(s,6)^q(s,11)^q(s,25))+J(s,o,p)+te[e]+ae[e]|0,u=(q(n,2)^q(n,13)^q(n,22))+ee(n,a,r)|0;d=p,p=o,o=s,s=i+t|0,i=r,r=a,a=n,n=t+u|0}n=n+this.A|0,a=a+this.B|0,r=r+this.C|0,i=i+this.D|0,s=s+this.E|0,o=o+this.F|0,p=p+this.G|0,d=d+this.H|0,this.set(n,a,r,i,s,o,p,d)}roundClean(){ae.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const ie=Q(()=>new re),se="sha2-256",oe=32,pe=new Uint8Array([18,32]);class de{constructor(e){this.code=18,this.name=se,this.bytes=e,this.size=oe,this.digest=e.subarray(2)}}const ue=e=>{const t=new Uint8Array(pe.length+oe);return t.set(pe,0),t.set(ie(e),pe.length),new de(t)},le=18,ce=["string","number","bigint","symbol"],ye=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];class me{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}me.uint=new me(0,"uint",!0),me.negint=new me(1,"negint",!0),me.bytes=new me(2,"bytes",!0),me.string=new me(3,"string",!0),me.array=new me(4,"array",!1),me.map=new me(5,"map",!1),me.tag=new me(6,"tag",!1),me.float=new me(7,"float",!0),me.false=new me(7,"false",!0),me.true=new me(7,"true",!0),me.null=new me(7,"null",!0),me.undefined=new me(7,"undefined",!0),me.break=new me(7,"break",!0);class he{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const ge=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.isBuffer,fe=new TextDecoder,ve=new TextEncoder;function we(e){return ge&&globalThis.Buffer.isBuffer(e)}const Te=ge?(e,t,n)=>n-t>64?globalThis.Buffer.from(e.subarray(t,n)).toString("utf8"):Ae(e,t,n):(e,t,n)=>n-t>64?fe.decode(e.subarray(t,n)):Ae(e,t,n),Se=ge?e=>e.length>64?globalThis.Buffer.from(e):Ce(e):e=>e.length>64?ve.encode(e):Ce(e),Pe=ge?(e,t,n)=>we(e)?new Uint8Array(e.subarray(t,n)):e.slice(t,n):(e,t,n)=>e.slice(t,n),be=ge?(e,t)=>{return e=e.map(e=>e instanceof Uint8Array?e:globalThis.Buffer.from(e)),(n=globalThis.Buffer.concat(e,t))instanceof Uint8Array?we(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n:Uint8Array.from(n);var n}:(e,t)=>{const n=new Uint8Array(t);let a=0;for(let t of e)a+t.length>n.length&&(t=t.subarray(0,n.length-a)),n.set(t,a),a+=t.length;return n},Ie=ge?e=>globalThis.Buffer.allocUnsafe(e):e=>new Uint8Array(e);function Ce(e){const t=[];let n=0;for(let a=0;a<e.length;a++){let r=e.charCodeAt(a);r<128?t[n++]=r:r<2048?(t[n++]=r>>6|192,t[n++]=63&r|128):55296==(64512&r)&&a+1<e.length&&56320==(64512&e.charCodeAt(a+1))?(r=65536+((1023&r)<<10)+(1023&e.charCodeAt(++a)),t[n++]=r>>18|240,t[n++]=r>>12&63|128,t[n++]=r>>6&63|128,t[n++]=63&r|128):(t[n++]=r>>12|224,t[n++]=r>>6&63|128,t[n++]=63&r|128)}return t}function Ae(e,t,n){const a=[];for(;t<n;){const r=e[t];let i=null,s=r>239?4:r>223?3:r>191?2:1;if(t+s<=n){let n,a,o,p;switch(s){case 1:r<128&&(i=r);break;case 2:n=e[t+1],128==(192&n)&&(p=(31&r)<<6|63&n,p>127&&(i=p));break;case 3:n=e[t+1],a=e[t+2],128==(192&n)&&128==(192&a)&&(p=(15&r)<<12|(63&n)<<6|63&a,p>2047&&(p<55296||p>57343)&&(i=p));break;case 4:n=e[t+1],a=e[t+2],o=e[t+3],128==(192&n)&&128==(192&a)&&128==(192&o)&&(p=(15&r)<<18|(63&n)<<12|(63&a)<<6|63&o,p>65535&&p<1114112&&(i=p))}}null===i?(i=65533,s=1):i>65535&&(i-=65536,a.push(i>>>10&1023|55296),i=56320|1023&i),a.push(i),t+=s}return function(e){const t=e.length;if(t<=De)return String.fromCharCode.apply(String,e);let n="",a=0;for(;a<t;)n+=String.fromCharCode.apply(String,e.slice(a,a+=De));return n}(a)}const De=4096;const _e="CBOR decode error:",Ee="CBOR encode error:",xe=[];function Re(e,t,n){if(e.length-t<n)throw new Error(`${_e} not enough data for type`)}xe[23]=1,xe[24]=2,xe[25]=3,xe[26]=5,xe[27]=9;const Me=[24,256,65536,4294967296,BigInt("18446744073709551616")];function ke(e,t,n){Re(e,t,1);const a=e[t];if(!0===n.strict&&a<Me[0])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);return a}function Ne(e,t,n){Re(e,t,2);const a=e[t]<<8|e[t+1];if(!0===n.strict&&a<Me[1])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);return a}function Ue(e,t,n){Re(e,t,4);const a=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];if(!0===n.strict&&a<Me[2])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);return a}function Fe(e,t,n){Re(e,t,8);const a=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3],r=16777216*e[t+4]+(e[t+5]<<16)+(e[t+6]<<8)+e[t+7],i=(BigInt(a)<<BigInt(32))+BigInt(r);if(!0===n.strict&&i<Me[3])throw new Error(`${_e} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(!0===n.allowBigInt)return i;throw new Error(`${_e} integers outside of the safe integer range are not supported`)}function Oe(e,t){return $e(e,0,t.value)}function $e(e,t,n){if(n<Me[0]){const a=Number(n);e.push([t|a])}else if(n<Me[1]){const a=Number(n);e.push([24|t,a])}else if(n<Me[2]){const a=Number(n);e.push([25|t,a>>>8,255&a])}else if(n<Me[3]){const a=Number(n);e.push([26|t,a>>>24&255,a>>>16&255,a>>>8&255,255&a])}else{const a=BigInt(n);if(!(a<Me[4]))throw new Error(`${_e} encountered BigInt larger than allowable range`);{const n=[27|t,0,0,0,0,0,0,0];let r=Number(a&BigInt(4294967295)),i=Number(a>>BigInt(32)&BigInt(4294967295));n[8]=255&r,r>>=8,n[7]=255&r,r>>=8,n[6]=255&r,r>>=8,n[5]=255&r,n[4]=255&i,i>>=8,n[3]=255&i,i>>=8,n[2]=255&i,i>>=8,n[1]=255&i,e.push(n)}}}Oe.encodedSize=function(e){return $e.encodedSize(e.value)},$e.encodedSize=function(e){return e<Me[0]?1:e<Me[1]?2:e<Me[2]?3:e<Me[3]?5:9},Oe.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};const Be=BigInt(-1),Le=BigInt(1);function Ve(e,t){const n=t.value,a="bigint"==typeof n?n*Be-Le:-1*n-1;$e(e,t.type.majorEncoded,a)}function We(e,t,n,a){Re(e,t,n+a);const r=Pe(e,t+n,t+n+a);return new he(me.bytes,r,n+a)}function ze(e,t,n,a){return We(e,t,1,n)}function je(e){return void 0===e.encodedBytes&&(e.encodedBytes=e.type===me.string?Se(e.value):e.value),e.encodedBytes}function He(e,t){const n=je(t);$e(e,t.type.majorEncoded,n.length),e.push(n)}function Ge(e,t,n,a,r){const i=n+a;Re(e,t,i);const s=new he(me.string,Te(e,t+n,t+i),i);return!0===r.retainStringBytes&&(s.byteValue=Pe(e,t+n,t+i)),s}function Ke(e,t,n,a){return Ge(e,t,1,n,a)}Ve.encodedSize=function(e){const t=e.value,n="bigint"==typeof t?t*Be-Le:-1*t-1;return n<Me[0]?1:n<Me[1]?2:n<Me[2]?3:n<Me[3]?5:9},Ve.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0},He.encodedSize=function(e){const t=je(e);return $e.encodedSize(t.length)+t.length},He.compareTokens=function(e,t){return n=je(e),a=je(t),n.length<a.length?-1:n.length>a.length?1:function(e,t){if(we(e)&&we(t))return e.compare(t);for(let n=0;n<e.length;n++)if(e[n]!==t[n])return e[n]<t[n]?-1:1;return 0}(n,a);var n,a};const qe=He;function Ye(e,t,n,a){return new he(me.array,a,n)}function Ze(e,t,n,a){return Ye(0,0,1,n)}function Qe(e,t){$e(e,me.array.majorEncoded,t.value)}function Xe(e,t,n,a){return new he(me.map,a,n)}function Je(e,t,n,a){return Xe(0,0,1,n)}function et(e,t){$e(e,me.map.majorEncoded,t.value)}function tt(e,t,n,a){return new he(me.tag,n,1)}function nt(e,t){$e(e,me.tag.majorEncoded,t.value)}function at(e,t,n){if(n){if(!1===n.allowNaN&&Number.isNaN(e))throw new Error(`${_e} NaN values are not supported`);if(!1===n.allowInfinity&&(e===1/0||e===-1/0))throw new Error(`${_e} Infinity values are not supported`)}return new he(me.float,e,t)}function rt(e,t,n){const a=t.value;if(!1===a)e.push([20|me.float.majorEncoded]);else if(!0===a)e.push([21|me.float.majorEncoded]);else if(null===a)e.push([22|me.float.majorEncoded]);else if(void 0===a)e.push([23|me.float.majorEncoded]);else{let t,i=!1;n&&!0===n.float64||(pt(a),t=dt(ot,1),a===t||Number.isNaN(a)?(ot[0]=249,e.push(ot.slice(0,3)),i=!0):(ut(a),t=lt(ot,1),a===t&&(ot[0]=250,e.push(ot.slice(0,5)),i=!0))),i||(r=a,st.setFloat64(0,r,!1),t=ct(ot,1),ot[0]=251,e.push(ot.slice(0,9)))}var r}Qe.compareTokens=Oe.compareTokens,Qe.encodedSize=function(e){return $e.encodedSize(e.value)},et.compareTokens=Oe.compareTokens,et.encodedSize=function(e){return $e.encodedSize(e.value)},nt.compareTokens=Oe.compareTokens,nt.encodedSize=function(e){return $e.encodedSize(e.value)},rt.encodedSize=function(e,t){const n=e.value;if(!1===n||!0===n||null==n)return 1;if(!t||!0!==t.float64){pt(n);let e=dt(ot,1);if(n===e||Number.isNaN(n))return 3;if(ut(n),e=lt(ot,1),n===e)return 5}return 9};const it=new ArrayBuffer(9),st=new DataView(it,1),ot=new Uint8Array(it,0);function pt(e){if(e===1/0)st.setUint16(0,31744,!1);else if(e===-1/0)st.setUint16(0,64512,!1);else if(Number.isNaN(e))st.setUint16(0,32256,!1);else{st.setFloat32(0,e);const t=st.getUint32(0),n=(2139095040&t)>>23,a=8388607&t;if(255===n)st.setUint16(0,31744,!1);else if(0===n)st.setUint16(0,(2147483648&e)>>16|a>>13,!1);else{const e=n-127;e<-24?st.setUint16(0,0):e<-14?st.setUint16(0,(2147483648&t)>>16|1<<24+e,!1):st.setUint16(0,(2147483648&t)>>16|e+15<<10|a>>13,!1)}}}function dt(e,t){if(e.length-t<2)throw new Error(`${_e} not enough data for float16`);const n=(e[t]<<8)+e[t+1];if(31744===n)return 1/0;if(64512===n)return-1/0;if(32256===n)return NaN;const a=n>>10&31,r=1023&n;let i;return i=0===a?r*2**-24:31!==a?(r+1024)*2**(a-25):0===r?1/0:NaN,32768&n?-i:i}function ut(e){st.setFloat32(0,e,!1)}function lt(e,t){if(e.length-t<4)throw new Error(`${_e} not enough data for float32`);const n=(e.byteOffset||0)+t;return new DataView(e.buffer,n,4).getFloat32(0,!1)}function ct(e,t){if(e.length-t<8)throw new Error(`${_e} not enough data for float64`);const n=(e.byteOffset||0)+t;return new DataView(e.buffer,n,8).getFloat64(0,!1)}function yt(e,t,n){throw new Error(`${_e} encountered invalid minor (${n}) for major ${e[t]>>>5}`)}function mt(e){return()=>{throw new Error(`${_e} ${e}`)}}rt.compareTokens=Oe.compareTokens;const ht=[];for(let e=0;e<=23;e++)ht[e]=yt;ht[24]=function(e,t,n,a){return new he(me.uint,ke(e,t+1,a),2)},ht[25]=function(e,t,n,a){return new he(me.uint,Ne(e,t+1,a),3)},ht[26]=function(e,t,n,a){return new he(me.uint,Ue(e,t+1,a),5)},ht[27]=function(e,t,n,a){return new he(me.uint,Fe(e,t+1,a),9)},ht[28]=yt,ht[29]=yt,ht[30]=yt,ht[31]=yt;for(let e=32;e<=55;e++)ht[e]=yt;ht[56]=function(e,t,n,a){return new he(me.negint,-1-ke(e,t+1,a),2)},ht[57]=function(e,t,n,a){return new he(me.negint,-1-Ne(e,t+1,a),3)},ht[58]=function(e,t,n,a){return new he(me.negint,-1-Ue(e,t+1,a),5)},ht[59]=function(e,t,n,a){const r=Fe(e,t+1,a);if("bigint"!=typeof r){const e=-1-r;if(e>=Number.MIN_SAFE_INTEGER)return new he(me.negint,e,9)}if(!0!==a.allowBigInt)throw new Error(`${_e} integers outside of the safe integer range are not supported`);return new he(me.negint,Be-BigInt(r),9)},ht[60]=yt,ht[61]=yt,ht[62]=yt,ht[63]=yt;for(let e=64;e<=87;e++)ht[e]=ze;ht[88]=function(e,t,n,a){return We(e,t,2,ke(e,t+1,a))},ht[89]=function(e,t,n,a){return We(e,t,3,Ne(e,t+1,a))},ht[90]=function(e,t,n,a){return We(e,t,5,Ue(e,t+1,a))},ht[91]=function(e,t,n,a){const r=Fe(e,t+1,a);if("bigint"==typeof r)throw new Error(`${_e} 64-bit integer bytes lengths not supported`);return We(e,t,9,r)},ht[92]=yt,ht[93]=yt,ht[94]=yt,ht[95]=mt("indefinite length bytes/strings are not supported");for(let e=96;e<=119;e++)ht[e]=Ke;ht[120]=function(e,t,n,a){return Ge(e,t,2,ke(e,t+1,a),a)},ht[121]=function(e,t,n,a){return Ge(e,t,3,Ne(e,t+1,a),a)},ht[122]=function(e,t,n,a){return Ge(e,t,5,Ue(e,t+1,a),a)},ht[123]=function(e,t,n,a){const r=Fe(e,t+1,a);if("bigint"==typeof r)throw new Error(`${_e} 64-bit integer string lengths not supported`);return Ge(e,t,9,r,a)},ht[124]=yt,ht[125]=yt,ht[126]=yt,ht[127]=mt("indefinite length bytes/strings are not supported");for(let e=128;e<=151;e++)ht[e]=Ze;ht[152]=function(e,t,n,a){return Ye(0,0,2,ke(e,t+1,a))},ht[153]=function(e,t,n,a){return Ye(0,0,3,Ne(e,t+1,a))},ht[154]=function(e,t,n,a){return Ye(0,0,5,Ue(e,t+1,a))},ht[155]=function(e,t,n,a){const r=Fe(e,t+1,a);if("bigint"==typeof r)throw new Error(`${_e} 64-bit integer array lengths not supported`);return Ye(0,0,9,r)},ht[156]=yt,ht[157]=yt,ht[158]=yt,ht[159]=function(e,t,n,a){if(!1===a.allowIndefinite)throw new Error(`${_e} indefinite length items not allowed`);return Ye(0,0,1,1/0)};for(let e=160;e<=183;e++)ht[e]=Je;ht[184]=function(e,t,n,a){return Xe(0,0,2,ke(e,t+1,a))},ht[185]=function(e,t,n,a){return Xe(0,0,3,Ne(e,t+1,a))},ht[186]=function(e,t,n,a){return Xe(0,0,5,Ue(e,t+1,a))},ht[187]=function(e,t,n,a){const r=Fe(e,t+1,a);if("bigint"==typeof r)throw new Error(`${_e} 64-bit integer map lengths not supported`);return Xe(0,0,9,r)},ht[188]=yt,ht[189]=yt,ht[190]=yt,ht[191]=function(e,t,n,a){if(!1===a.allowIndefinite)throw new Error(`${_e} indefinite length items not allowed`);return Xe(0,0,1,1/0)};for(let e=192;e<=215;e++)ht[e]=tt;ht[216]=function(e,t,n,a){return new he(me.tag,ke(e,t+1,a),2)},ht[217]=function(e,t,n,a){return new he(me.tag,Ne(e,t+1,a),3)},ht[218]=function(e,t,n,a){return new he(me.tag,Ue(e,t+1,a),5)},ht[219]=function(e,t,n,a){return new he(me.tag,Fe(e,t+1,a),9)},ht[220]=yt,ht[221]=yt,ht[222]=yt,ht[223]=yt;for(let e=224;e<=243;e++)ht[e]=mt("simple values are not supported");ht[244]=yt,ht[245]=yt,ht[246]=yt,ht[247]=function(e,t,n,a){if(!1===a.allowUndefined)throw new Error(`${_e} undefined values are not supported`);return!0===a.coerceUndefinedToNull?new he(me.null,null,1):new he(me.undefined,void 0,1)},ht[248]=mt("simple values are not supported"),ht[249]=function(e,t,n,a){return at(dt(e,t+1),3,a)},ht[250]=function(e,t,n,a){return at(lt(e,t+1),5,a)},ht[251]=function(e,t,n,a){return at(ct(e,t+1),9,a)},ht[252]=yt,ht[253]=yt,ht[254]=yt,ht[255]=function(e,t,n,a){if(!1===a.allowIndefinite)throw new Error(`${_e} indefinite length items not allowed`);return new he(me.break,void 0,1)};const gt=[];for(let e=0;e<24;e++)gt[e]=new he(me.uint,e,1);for(let e=-1;e>=-24;e--)gt[31-e]=new he(me.negint,e,1);gt[64]=new he(me.bytes,new Uint8Array(0),1),gt[96]=new he(me.string,"",1),gt[128]=new he(me.array,0,1),gt[160]=new he(me.map,0,1),gt[244]=new he(me.false,!1,1),gt[245]=new he(me.true,!0,1),gt[246]=new he(me.null,null,1),function(){const e=[];e[me.uint.major]=Oe,e[me.negint.major]=Ve,e[me.bytes.major]=He,e[me.string.major]=qe,e[me.array.major]=Qe,e[me.map.major]=et,e[me.tag.major]=nt,e[me.float.major]=rt}(),new class{constructor(e=256){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),null!==this._initReuseChunk&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const n=t.length-(this.maxCursor-this.cursor)-1;t.set(e,n)}else{if(t){const e=t.length-(this.maxCursor-this.cursor)-1;e<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,e),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=Ie(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,null===this._initReuseChunk&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(1===this.chunks.length){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=Pe(n,0,this.cursor)}else t=be(this.chunks,this.cursor);return e&&this.reset(),t}};class ft{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do{if(t.obj===e)return!0}while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Ee} object contains circular references`);return new ft(t,e)}}const vt={null:new he(me.null,null),undefined:new he(me.undefined,void 0),true:new he(me.true,!0),false:new he(me.false,!1),emptyArray:new he(me.array,0),emptyMap:new he(me.map,0)},wt={number:(e,t,n,a)=>Number.isInteger(e)&&Number.isSafeInteger(e)?new he(e>=0?me.uint:me.negint,e):new he(me.float,e),bigint:(e,t,n,a)=>e>=BigInt(0)?new he(me.uint,e):new he(me.negint,e),Uint8Array:(e,t,n,a)=>new he(me.bytes,e),string:(e,t,n,a)=>new he(me.string,e),boolean:(e,t,n,a)=>e?vt.true:vt.false,null:(e,t,n,a)=>vt.null,undefined:(e,t,n,a)=>vt.undefined,ArrayBuffer:(e,t,n,a)=>new he(me.bytes,new Uint8Array(e)),DataView:(e,t,n,a)=>new he(me.bytes,new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),Array(e,t,n,a){if(!e.length)return!0===n.addBreakTokens?[vt.emptyArray,new he(me.break)]:vt.emptyArray;a=ft.createCheck(a,e);const r=[];let i=0;for(const t of e)r[i++]=Tt(t,n,a);return n.addBreakTokens?[new he(me.array,e.length),r,new he(me.break)]:[new he(me.array,e.length),r]},Object(e,t,n,a){const r="Object"!==t,i=r?e.keys():Object.keys(e),s=r?e.size:i.length;if(!s)return!0===n.addBreakTokens?[vt.emptyMap,new he(me.break)]:vt.emptyMap;a=ft.createCheck(a,e);const o=[];let p=0;for(const t of i)o[p++]=[Tt(t,n,a),Tt(r?e.get(t):e[t],n,a)];return function(e,t){t.mapSorter&&e.sort(t.mapSorter)}(o,n),n.addBreakTokens?[new he(me.map,s),o,new he(me.break)]:[new he(me.map,s),o]}};wt.Map=wt.Object,wt.Buffer=wt.Uint8Array;for(const e of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))wt[`${e}Array`]=wt.DataView;function Tt(e,t={},n){const a=function(e){if(null===e)return"null";if(void 0===e)return"undefined";if(!0===e||!1===e)return"boolean";const t=typeof e;if(ce.includes(t))return t;if("function"===t)return"Function";if(Array.isArray(e))return"Array";if(function(e){return e&&e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer.call(null,e)}(e))return"Buffer";return function(e){const t=Object.prototype.toString.call(e).slice(8,-1);if(ye.includes(t))return t}(e)||"Object"}(e),r=t&&t.typeEncoders&&t.typeEncoders[a]||wt[a];if("function"==typeof r){const i=r(e,a,t,n);if(null!=i)return i}const i=wt[a];if(!i)throw new Error(`${Ee} unsupported type: ${a}`);return i(e,a,t,n)}Symbol.for("DONE"),Symbol.for("BREAK");const St=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),a=0;a<n.length;a++)n[a]=255;for(var r=0;r<e.length;r++){var i=e.charAt(r),s=i.charCodeAt(0);if(255!==n[s])throw new TypeError(i+" is ambiguous");n[s]=r}var o=e.length,p=e.charAt(0),d=Math.log(o)/Math.log(256),u=Math.log(256)/Math.log(o);function l(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var a=0,r=0;e[t]===p;)a++,t++;for(var i=(e.length-t)*d+1>>>0,s=new Uint8Array(i);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var l=0,c=i-1;(0!==u||l<r)&&-1!==c;c--,l++)u+=o*s[c]>>>0,s[c]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");r=l,t++}if(" "!==e[t]){for(var y=i-r;y!==i&&0===s[y];)y++;for(var m=new Uint8Array(a+(i-y)),h=a;y!==i;)m[h++]=s[y++];return m}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,a=0,r=0,i=t.length;r!==i&&0===t[r];)r++,n++;for(var s=(i-r)*u+1>>>0,d=new Uint8Array(s);r!==i;){for(var l=t[r],c=0,y=s-1;(0!==l||c<a)&&-1!==y;y--,c++)l+=256*d[y]>>>0,d[y]=l%o>>>0,l=l/o>>>0;if(0!==l)throw new Error("Non-zero carry");a=c,r++}for(var m=s-a;m!==s&&0===d[m];)m++;for(var h=p.repeat(n);m<s;++m)h+=e.charAt(d[m]);return h},decodeUnsafe:l,decode:function(e){var n=l(e);if(n)return n;throw new Error(`Non-${t} character`)}}};class Pt{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class bt{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const a=t.codePointAt(0);if(void 0===a)throw new Error("Invalid prefix character");this.prefixCodePoint=a,this.baseDecode=n}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return Ct(this,e)}}class It{decoders;constructor(e){this.decoders=e}or(e){return Ct(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(null!=n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function Ct(e,t){return new It({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}class At{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,a){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=a,this.encoder=new Pt(e,t,n),this.decoder=new bt(e,t,a)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function Dt({name:e,prefix:t,encode:n,decode:a}){return new At(e,t,n,a)}function _t({name:e,prefix:t,alphabet:n}){const{encode:a,decode:r}=St(n,e);return Dt({prefix:t,name:e,encode:a,decode:e=>j(r(e))})}function Et({name:e,prefix:t,bitsPerChar:n,alphabet:a}){const r=function(e){const t={};for(let n=0;n<e.length;++n)t[e[n]]=n;return t}(a);return Dt({prefix:t,name:e,encode:e=>function(e,t,n){const a="="===t[t.length-1],r=(1<<n)-1;let i="",s=0,o=0;for(let a=0;a<e.length;++a)for(o=o<<8|e[a],s+=8;s>n;)s-=n,i+=t[r&o>>s];if(0!==s&&(i+=t[r&o<<n-s]),a)for(;i.length*n&7;)i+="=";return i}(e,a,n),decode:t=>function(e,t,n,a){let r=e.length;for(;"="===e[r-1];)--r;const i=new Uint8Array(r*n/8|0);let s=0,o=0,p=0;for(let d=0;d<r;++d){const r=t[e[d]];if(void 0===r)throw new SyntaxError(`Non-${a} character`);o=o<<n|r,s+=n,s>=8&&(s-=8,i[p++]=255&o>>s)}if(s>=n||255&o<<8-s)throw new SyntaxError("Unexpected end of data");return i}(t,r,n,e)})}const xt=Et({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Rt=(Et({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Et({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Et({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Et({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Et({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Et({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Et({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Et({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),_t({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"})),Mt=(_t({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),_t({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}));_t({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var kt=128,Nt=-128,Ut=Math.pow(2,31),Ft=128,Ot=127,$t=Math.pow(2,7),Bt=Math.pow(2,14),Lt=Math.pow(2,21),Vt=Math.pow(2,28),Wt=Math.pow(2,35),zt=Math.pow(2,42),jt=Math.pow(2,49),Ht=Math.pow(2,56),Gt=Math.pow(2,63);const Kt={encode:function e(t,n,a){n=n||[];for(var r=a=a||0;t>=Ut;)n[a++]=255&t|kt,t/=128;for(;t&Nt;)n[a++]=255&t|kt,t>>>=7;return n[a]=0|t,e.bytes=a-r+1,n},decode:function e(t,n){var a,r=0,i=(n=n||0,0),s=n,o=t.length;do{if(s>=o)throw e.bytes=0,new RangeError("Could not decode varint");a=t[s++],r+=i<28?(a&Ot)<<i:(a&Ot)*Math.pow(2,i),i+=7}while(a>=Ft);return e.bytes=s-n,r},encodingLength:function(e){return e<$t?1:e<Bt?2:e<Lt?3:e<Vt?4:e<Wt?5:e<zt?6:e<jt?7:e<Ht?8:e<Gt?9:10}};function qt(e,t=0){return[Kt.decode(e,t),Kt.decode.bytes]}function Yt(e,t,n=0){return Kt.encode(e,t,n),t}function Zt(e){return Kt.encodingLength(e)}function Qt(e,t){const n=t.byteLength,a=Zt(e),r=a+Zt(n),i=new Uint8Array(r+n);return Yt(e,i,0),Yt(n,i,a),i.set(t,r),new Xt(e,n,t,i)}class Xt{code;size;digest;bytes;constructor(e,t,n,a){this.code=e,this.size=t,this.digest=n,this.bytes=a}}function Jt(e,t){const{bytes:n,version:a}=e;return 0===a?function(e,t,n){const{prefix:a}=n;if(a!==Mt.prefix)throw Error(`Cannot string encode V0 in ${n.name} encoding`);const r=t.get(a);if(null==r){const r=n.encode(e).slice(1);return t.set(a,r),r}return r}(n,tn(e),t??Mt.encoder):function(e,t,n){const{prefix:a}=n,r=t.get(a);if(null==r){const r=n.encode(e);return t.set(a,r),r}return r}(n,tn(e),t??xt.encoder)}const en=new WeakMap;function tn(e){const t=en.get(e);if(null==t){const t=new Map;return en.set(e,t),t}return t}class nn{code;version;multihash;bytes;"/";constructor(e,t,n,a){this.code=t,this.version=e,this.multihash=n,this.bytes=a,this["/"]=a}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==an)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==rn)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return nn.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Qt(e,t);return nn.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return nn.equals(this,e)}static equals(e,t){const n=t;return null!=n&&e.code===n.code&&e.version===n.version&&function(e,t){if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}(e.bytes,n.bytes)}}(e.multihash,n.multihash)}toString(e){return Jt(this,e)}toJSON(){return{"/":Jt(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(null==e)return null;const t=e;if(t instanceof nn)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:a,bytes:r}=t;return new nn(e,n,a,r??sn(e,n,a.bytes))}if(!0===t[on]){const{version:e,multihash:n,code:a}=t,r=function(e){const t=j(e),[n,a]=qt(t),[r,i]=qt(t.subarray(a)),s=t.subarray(a+i);if(s.byteLength!==r)throw new Error("Incorrect length");return new Xt(n,r,s,t)}(n);return nn.create(e,a,r)}return null}static create(e,t,n){if("number"!=typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==an)throw new Error(`Version 0 CID must use dag-pb (code: ${an}) block encoding`);return new nn(e,t,n,n.bytes);case 1:{const a=sn(e,t,n.bytes);return new nn(e,t,n,a)}default:throw new Error("Invalid version")}}static createV0(e){return nn.create(0,an,e)}static createV1(e,t){return nn.create(1,e,t)}static decode(e){const[t,n]=nn.decodeFirst(e);if(0!==n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=nn.inspectBytes(e),n=t.size-t.multihashSize,a=j(e.subarray(n,n+t.multihashSize));if(a.byteLength!==t.multihashSize)throw new Error("Incorrect length");const r=a.subarray(t.multihashSize-t.digestSize),i=new Xt(t.multihashCode,t.digestSize,r,a);return[0===t.version?nn.createV0(i):nn.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,a]=qt(e.subarray(t));return t+=a,n};let a=n(),r=an;if(18===a?(a=0,t=0):r=n(),0!==a&&1!==a)throw new RangeError(`Invalid CID version ${a}`);const i=t,s=n(),o=n(),p=t+o;return{version:a,codec:r,multihashCode:s,digestSize:o,multihashSize:p-i,size:p}}static parse(e,t){const[n,a]=function(e,t){switch(e[0]){case"Q":{const n=t??Mt;return[Mt.prefix,n.decode(`${Mt.prefix}${e}`)]}case Mt.prefix:{const n=t??Mt;return[Mt.prefix,n.decode(e)]}case xt.prefix:{const n=t??xt;return[xt.prefix,n.decode(e)]}case Rt.prefix:{const n=t??Rt;return[Rt.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}(e,t),r=nn.decode(a);if(0===r.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return tn(r).set(n,e),r}}const an=112,rn=18;function sn(e,t,n){const a=Zt(e),r=a+Zt(t),i=new Uint8Array(r+n.byteLength);return Yt(e,i,0),Yt(t,i,a),i.set(n,r),i}const on=Symbol.for("@ipld/js-cid/CID"),pn={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};function dn(e,t){return nn.create(1,e,t)}pn.tags[42]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return nn.decode(e.subarray(1))},pn.tags.slice();const un=(e,t,a)=>{const r=new Uint8Array(e.length+t.length);return r.set(e,0),r.set(t,e.length),function(e,t={}){const a=t.hasher||n,{digest:r}=a.digest(e);return(i=r)[31]&=63,i;var i}(r,a)},ln=new class{constructor(){this.bytes=new Uint8Array(2048),this.bytes.set(V(),0),this.node=V(),this.length=B}slice(e,t){for(;this.length<t;)this.node=un(this.node,this.node),this.bytes.set(this.node,this.length),this.length+=B;return this.bytes.subarray(e,t)}},cn=e=>{if(e<0||e>=64)throw new Error("Only levels between 0 and 63 inclusive are available");return ln.slice(B*e,B*(e+1))},yn=e=>{const t=e.length/B,n=new Array(t);for(let a=0;a<t;a++){const t=a*B,r=e.subarray(t,t+B);n[a]=r}return n};function mn(e){const t=Math.max(e,65),n=Math.floor(Math.log2(t)),a=Math.ceil($*2**(n+1));return t<=a?a:Math.ceil($*2**(n+2))}const hn=(e,t=new Uint8Array((e=>mn(e)/$)(e.length)))=>{const n=mn(e.byteLength)/F;for(let a=0;a<n;a++){const n=a*F,r=128*a;t.set(e.subarray(n,n+32),r),t[r+31]&=63;for(let a=32;a<64;a++)t[r+a]=e[n+a]<<2|e[n+a-1]>>6;t[r+63]&=63;for(let a=64;a<96;a++)t[r+a]=e[n+a]<<4|e[n+a-1]>>4;t[r+95]&=63;for(let a=96;a<127;a++)t[r+a]=e[n+a]<<6|e[n+a-1]>>2;t[r+127]=e[n+126]>>2}return t},gn=e=>{return 2n**BigInt((t=(e+O-1n)/O)<=1n?0:(e=>{let t=0n;for(;e>>=1n;)t++;return Number(t)})(BigInt(t)-1n)+1);var t},fn=e=>vn(2n**BigInt(e)),vn=e=>e*L,wn=4113,Tn=oe,Sn=10+oe,Pn=Zt(wn),bn=Pn+Zt(Sn)+Sn;fn(255),BigInt(254),BigInt(256);class In{constructor(e){this.bytes=e;const[t]=qt(e);if(t!==wn)throw new RangeError("Expected multihash with code 4113");let n=Pn;const[a,r]=qt(e,n);n+=r;const i=e.subarray(n);if(i.length!==a)throw new RangeError(`Invalid multihash size expected ${n+a} bytes, got ${e.length} bytes`);this.digest=i}get name(){return"fr32-sha2-256-trunc254-padded-binary-tree"}get code(){return wn}get size(){return this.digest.length}get padding(){return(({digest:e})=>{const[t]=qt(e);return BigInt(t)})(this)}get height(){return(({digest:e})=>{const[,t]=qt(e);return e[t]})(this)}get root(){return(({digest:e})=>{const[,t]=qt(e);return e.subarray(t+1,t+1+oe)})(this)}}const Cn=4113,An=fn(255)*BigInt(254)/BigInt(256),Dn=()=>new _n;class _n{constructor(){this.bytesWritten=0n,this.buffer=new Uint8Array(F),this.offset=0,this.layers=[[]]}count(){return this.bytesWritten}digest(){const e=new Uint8Array(bn),t=this.digestInto(e,0,!0);return(e=>new In(e))(e.subarray(0,t))}digestInto(e,t=0,n=!0){const{buffer:a,layers:r,offset:i,bytesWritten:s}=this;let[o,...p]=r;(i>0||0n===s)&&(o=[...o,...yn(hn(a.fill(0,i)))]);const d=xn([o,...p]),u=d.length-1,[l]=d[u],c=Number((e=>(e=>gn(e)*O)(e)-e)(this.bytesWritten)),y=Zt(c);let m=t;if(n){Yt(Cn,e,m),m+=Pn;const t=y+1+Tn,n=Zt(t);Yt(t,e,m),m+=n}return Yt(c,e,m),m+=y,e[m]=u,m+=1,e.set(l,m),m+=l.length,m-t}write(e){const{buffer:t,offset:n,layers:a}=this,r=a[0],{length:i}=e;if(0===i)return this;if(this.bytesWritten+BigInt(i)>An)throw new RangeError(`Writing ${i} bytes exceeds max payload size of ${An}`);if(n+i<t.length)return t.set(e,n),this.offset+=i,this.bytesWritten+=BigInt(i),this;{const a=t.length-n;t.set(e.subarray(0,a),n),r.push(...yn(hn(t)));let s=a;for(;s+F<i;){const t=e.subarray(s,s+F);r.push(...yn(hn(t))),s+=F}return this.buffer.set(e.subarray(s),0),this.offset=i-s,this.bytesWritten+=BigInt(i),En(this.layers),this}}reset(){return this.offset=0,this.bytesWritten=0n,this.layers.length=1,this.layers[0].length=0,this}dispose(){this.reset()}get code(){return Cn}get name(){return"fr32-sha2-256-trunc254-padded-binary-tree"}}const En=e=>Rn(e,!1),xn=e=>Rn([...e],!0),Rn=(e,t)=>{let n=0;for(;n<e.length;){let a=e[n+1];const r=e[n];t&&r.length%2>0&&a&&r.push(cn(n)),n+=1,a=a?t?[...a]:a:[];let i=0;for(;i+1<r.length;){const e=un(r[i],r[i+1]);delete r[i],delete r[i+1],a.push(e),i+=2}a.length&&(e[n]=a),r.splice(0,i)}return e},Mn=85,kn=61697,Nn=4114;function Un(e){return e.code===Mn&&e.multihash.code===Cn}function Fn(e){return e.code===kn&&e.multihash.code===Nn}function On(e){return"string"==typeof e?function(e){try{const t=nn.parse(e);if(Un(t))return t}catch{}return null}(e):"object"==typeof e&&null!==nn.asCID(e)&&Un(e)?e:null}function $n(e){const t=On(e);if(null!=t){const e=Qt(Nn,t.multihash.digest.subarray(-32));return dn(kn,e)}return"string"==typeof e?function(e){try{const t=nn.parse(e);if(Fn(t))return t}catch{}return null}(e):"object"==typeof e&&null!==nn.asCID(e)&&Fn(e)?e:null}function Bn(e){const t=Dn();for(let n=0;n<e.length;n+=2048)t.write(e.subarray(n,n+2048));const n=t.digest();return dn(Mn,n)}function Ln(){const e=Dn();let t=!1,n=null;const a=new TransformStream({transform(t,n){e.write(t),n.enqueue(t)},flush(){const a=e.digest();n=dn(Mn,a),t=!0}});return{stream:a,getPieceCID:()=>t?n:null}}const Vn={MetadataEntry:[{name:"key",type:"string"},{name:"value",type:"string"}],CreateDataSet:[{name:"clientDataSetId",type:"uint256"},{name:"payee",type:"address"},{name:"metadata",type:"MetadataEntry[]"}],Cid:[{name:"data",type:"bytes"}],PieceMetadata:[{name:"pieceIndex",type:"uint256"},{name:"metadata",type:"MetadataEntry[]"}],AddPieces:[{name:"clientDataSetId",type:"uint256"},{name:"firstAdded",type:"uint256"},{name:"pieceData",type:"Cid[]"},{name:"pieceMetadata",type:"PieceMetadata[]"}],SchedulePieceRemovals:[{name:"clientDataSetId",type:"uint256"},{name:"pieceIds",type:"uint256[]"}],DeleteDataSet:[{name:"clientDataSetId",type:"uint256"}]};class Wn{signer;domain;WITH_CDN_METADATA={key:y.WITH_CDN,value:""};constructor(e,t,n){this.signer=t,this.domain={name:"FilecoinWarmStorageService",version:"1",chainId:Number(n),verifyingContract:e}}getUnderlyingSigner(){return"signer"in this.signer&&"NonceManager"===this.signer.constructor.name?this.signer.signer:this.signer}async isMetaMaskSigner(){try{const e=this.getUnderlyingSigner();if("Wallet"===e.constructor.name)return!1;const t=e.provider;if(null==t)return!1;if("_eip1193Provider"in t)return!0;if("undefined"!=typeof globalThis&&"window"in globalThis){const e=globalThis;if(null!=e.window?.ethereum)return!0}if("send"in t||"request"in t)return!0}catch{}return!1}async signWithMetaMask(e,t){const n=this.signer.provider;if(null==n)throw new Error("No provider available");const a=await this.signer.getAddress();let r="";for(const t of Object.keys(e))if("Cid"!==t&&"PieceData"!==t){r=t;break}const i={types:{EIP712Domain:[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}],...e},primaryType:r,domain:this.domain,message:t};let s,o;return s="_eip1193Provider"in n?n._eip1193Provider:n,o=null!=s&&"request"in s?await s.request({method:"eth_signTypedData_v4",params:[a.toLowerCase(),JSON.stringify(i)]}):await n.send("eth_signTypedData_v4",[a.toLowerCase(),JSON.stringify(i)]),o}async signCreateDataSet(t,n,a=[]){let r;const i={CreateDataSet:Vn.CreateDataSet,MetadataEntry:Vn.MetadataEntry};if(await this.isMetaMaskSigner()){const e={clientDataSetId:t.toString(),metadata:a,payee:n};r=await this.signWithMetaMask(i,e)}else{const e={clientDataSetId:BigInt(t),metadata:a,payee:n},s=this.getUnderlyingSigner();r=await s.signTypedData(this.domain,i,e)}const s=e.Signature.from(r),o=e.TypedDataEncoder.hash(this.domain,i,{clientDataSetId:BigInt(t),metadata:a,payee:n});return{signature:r,v:s.v,r:s.r,s:s.s,signedData:o}}async signAddPieces(t,n,a,r=[]){if(0===r.length)r=Array(a.length).fill([]);else if(r.length!==a.length)throw new Error("metadata length must match pieceDataArray length");const i=[],s=[];for(let e=0;e<a.length;e++){const t=a[e],n="string"==typeof t?On(t):t;if(null==n)throw new Error(`Invalid PieceCID: ${String(n)}`);s.push({data:n.bytes}),i.push({pieceIndex:e,metadata:r[e]})}const o={AddPieces:Vn.AddPieces,Cid:Vn.Cid,PieceMetadata:Vn.PieceMetadata,MetadataEntry:Vn.MetadataEntry};let p;if(await this.isMetaMaskSigner()){const a={clientDataSetId:t.toString(),firstAdded:n.toString(),pieceData:s.map(t=>({data:e.hexlify(t.data)})),pieceMetadata:i};p=await this.signWithMetaMask(o,a)}else{const e={clientDataSetId:BigInt(t),firstAdded:BigInt(n),pieceData:s,pieceMetadata:i},a=this.getUnderlyingSigner();p=await a.signTypedData(this.domain,o,e)}const d=e.Signature.from(p),u=e.TypedDataEncoder.hash(this.domain,o,{clientDataSetId:BigInt(t),firstAdded:BigInt(n),pieceData:s,pieceMetadata:i});return{signature:p,v:d.v,r:d.r,s:d.s,signedData:u}}async signSchedulePieceRemovals(t,n){const a=n.map(e=>BigInt(e));let r;if(await this.isMetaMaskSigner()){const e={clientDataSetId:t.toString(),pieceIds:a.map(e=>e.toString())};r=await this.signWithMetaMask({SchedulePieceRemovals:Vn.SchedulePieceRemovals},e)}else{const e={clientDataSetId:BigInt(t),pieceIds:a},n=this.getUnderlyingSigner();r=await n.signTypedData(this.domain,{SchedulePieceRemovals:Vn.SchedulePieceRemovals},e)}const i=e.Signature.from(r),s=e.TypedDataEncoder.hash(this.domain,{SchedulePieceRemovals:Vn.SchedulePieceRemovals},{clientDataSetId:BigInt(t),pieceIds:a});return{signature:r,v:i.v,r:i.r,s:i.s,signedData:s}}async signDeleteDataSet(t){let n;if(await this.isMetaMaskSigner()){const e={clientDataSetId:t.toString()};n=await this.signWithMetaMask({DeleteDataSet:Vn.DeleteDataSet},e)}else{const e={clientDataSetId:BigInt(t)},a=this.getUnderlyingSigner();n=await a.signTypedData(this.domain,{DeleteDataSet:Vn.DeleteDataSet},e)}const a=e.Signature.from(n),r=e.TypedDataEncoder.hash(this.domain,{DeleteDataSet:Vn.DeleteDataSet},{clientDataSetId:BigInt(t)});return{signature:n,v:a.v,r:a.r,s:a.s,signedData:r}}async getSignerAddress(){return await this.signer.getAddress()}}function zn(e){if("object"!=typeof e||null==e)return!1;const t=e;return!("string"!=typeof t.createMessageHash||"boolean"!=typeof t.dataSetCreated||"string"!=typeof t.service||"string"!=typeof t.txStatus||null!==t.ok&&"boolean"!=typeof t.ok||void 0!==t.dataSetId&&"number"!=typeof t.dataSetId)}function jn(e){if("object"!=typeof e||null==e)return!1;const t=e;if("string"!=typeof t.txHash)return!1;if("string"!=typeof t.txStatus)return!1;if("number"!=typeof t.dataSetId)return!1;if("number"!=typeof t.pieceCount)return!1;if(null!==t.addMessageOk&&"boolean"!=typeof t.addMessageOk)return!1;if(void 0!==t.confirmedPieceIds){if(!Array.isArray(t.confirmedPieceIds))return!1;for(const e of t.confirmedPieceIds)if("number"!=typeof e)return!1}return!0}function Hn(e){if("object"!=typeof e||null==e)return!1;const t=e;return"string"==typeof t.pieceCid&&null!=On(t.pieceCid)}function Gn(e){if(!zn(e))throw new Error("Invalid data set creation status response format");return e}function Kn(e){if(!jn(e))throw new Error("Invalid piece addition status response format");return e}function qn(e){if(!Hn(e)){if("object"==typeof e&&null!=e){const t=e,n=t.pieceCid??t.piece_cid;if(null!=n&&null==On(n))throw new Error("Invalid find piece response: pieceCid is not a valid PieceCID")}throw new Error("Invalid find piece response format")}const t=e,n=On(t.pieceCid??t.piece_cid);if(null==n)throw new Error("Invalid find piece response: pieceCid is not a valid PieceCID");return{pieceCid:n,piece_cid:t.piece_cid}}function Yn(e){if("object"!=typeof e||null==e)return null;const t=e;if("number"!=typeof t.pieceId)return null;if("string"!=typeof t.pieceCid)return null;if("string"!=typeof t.subPieceCid)return null;if("number"!=typeof t.subPieceOffset)return null;const n=On(t.pieceCid),a=On(t.subPieceCid);return null==n||null==a?null:{pieceId:t.pieceId,pieceCid:n,subPieceCid:a,subPieceOffset:t.subPieceOffset}}function Zn(e){if("object"!=typeof e||null==e)return null;const t=e;if("number"!=typeof t.id)return null;if(!Array.isArray(t.pieces))return null;const n=[];for(const e of t.pieces){const t=Yn(e);if(null==t)return null;n.push(t)}return"number"!=typeof t.nextChallengeEpoch?null:{id:t.id,pieces:n,nextChallengeEpoch:t.nextChallengeEpoch}}class Qn{_serviceURL;_authHelper;constructor(e,t){if(""===t.trim())throw new Error("PDP service URL is required");this._serviceURL=t.replace(/\/$/,""),this._authHelper=e}async createDataSet(e,t,n,a){!function(e){const t=Array.isArray(e)?e:A(e);if(t.length>10)throw new Error(`Too many metadata keys for data set: ${t.length} (max: 10)`);for(const{key:e,value:n}of t){if(e.length>32)throw new Error(`Metadata key "${e}" exceeds max length: ${e.length} bytes (max: 32)`);if(n.length>C)throw new Error(`Metadata value for key "${e}" exceeds max length: ${n.length} bytes (max: 128)`)}}(n);const r=await this.getAuthHelper().signCreateDataSet(e,t,n),i={recordKeeper:a,extraData:`0x${this._encodeDataSetCreateData({payer:await this.getAuthHelper().getSignerAddress(),metadata:n,signature:r.signature})}`},s=await fetch(`${this._serviceURL}/pdp/data-sets`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(201!==s.status){const e=await s.text();throw new Error(`Failed to create data set: ${s.status} ${s.statusText} - ${e}`)}const o=s.headers.get("Location");if(null==o)throw new Error("Server did not provide Location header in response");const p=o.match(/\/pdp\/data-sets\/created\/(.+)$/);if(null==p)throw new Error(`Invalid Location header format: ${o}`);return{txHash:p[1],statusUrl:`${this._serviceURL}${o}`}}async addPieces(e,t,n,a,r){if(0===a.length)throw new Error("At least one piece must be provided");if(null!=r)for(let e=0;e<r.length;e++)if(null!=r[e]&&r[e].length>0)try{D(r[e])}catch(t){throw new Error(`Piece ${e} metadata validation failed: ${t.message}`)}for(const e of a)if(null==On(e))throw new Error(`Invalid PieceCID: ${String(e)}`);const i=r??a.map(()=>[]);if(i.length!==a.length)throw new Error(`Metadata length (${i.length}) must match pieces length (${a.length})`);const s=await this.getAuthHelper().signAddPieces(t,n,a,i),o=this._encodeAddPiecesExtraData({signature:s.signature,metadata:i}),p={pieces:a.map(e=>{const t="string"==typeof e?e:e.toString();return{pieceCid:t,subPieces:[{subPieceCid:t}]}}),extraData:`0x${o}`},d=await fetch(`${this._serviceURL}/pdp/data-sets/${e}/pieces`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(201!==d.status){const e=await d.text();throw new Error(`Failed to add pieces to data set: ${d.status} ${d.statusText} - ${e}`)}const u=d.headers.get("Location");let l,c;if(null!=u){const e=u.match(/\/pieces\/added\/([0-9a-fA-Fx]+)$/);null!=e&&(l=e[1],l.startsWith("0x")||(l=`0x${l}`),c=`${this._serviceURL}${u}`)}const y=await d.text();return{message:""!==y?y:`Pieces added to data set ID ${e} successfully`,txHash:l,statusUrl:c}}async getDataSetCreationStatus(e){const t=await fetch(`${this._serviceURL}/pdp/data-sets/created/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(404===t.status)throw new Error(`Data set creation not found for transaction hash: ${e}`);if(200!==t.status){const e=await t.text();throw new Error(`Failed to get data set creation status: ${t.status} ${t.statusText} - ${e}`)}return Gn(await t.json())}async getPieceAdditionStatus(e,t){const n=await fetch(`${this._serviceURL}/pdp/data-sets/${e}/pieces/added/${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(404===n.status)throw new Error(`Piece addition not found for transaction: ${t}`);if(200!==n.status){const e=await n.text();throw new Error(`Failed to get piece addition status: ${n.status} ${n.statusText} - ${e}`)}return Kn(await n.json())}async findPiece(e){const t=On(e);if(null==t)throw new Error(`Invalid PieceCID: ${String(e)}`);const n=M(this._serviceURL,t),a=await fetch(n,{method:"GET",headers:{}});if(404===a.status)throw new Error(`Piece not found: ${t.toString()}`);if(!a.ok){const e=await a.text();throw new Error(`Failed to find piece: ${a.status} ${a.statusText} - ${e}`)}return qn(await a.json())}async uploadPiece(e){const t=e instanceof ArrayBuffer?new Uint8Array(e):e;performance.mark("synapse:calculatePieceCID-start");const n=Bn(t);performance.mark("synapse:calculatePieceCID-end"),performance.measure("synapse:calculatePieceCID","synapse:calculatePieceCID-start","synapse:calculatePieceCID-end");const a=t.length,r={pieceCid:n.toString()};performance.mark("synapse:POST.pdp.piece-start");const i=await fetch(`${this._serviceURL}/pdp/piece`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(performance.mark("synapse:POST.pdp.piece-end"),performance.measure("synapse:POST.pdp.piece","synapse:POST.pdp.piece-start","synapse:POST.pdp.piece-end"),200===i.status)return{pieceCid:n,size:a};if(201!==i.status){const e=await i.text();throw new Error(`Failed to create upload session: ${i.status} ${i.statusText} - ${e}`)}const s=i.headers.get("Location");if(null==s)throw new Error("Server did not provide Location header in response (may be restricted by CORS policy)");const o=s.match(/\/(?:pdp\/)?piece\/upload\/([a-fA-F0-9-]+)/);if(null==o)throw new Error(`Invalid Location header format: ${s}`);const p=o[1];performance.mark("synapse:PUT.pdp.piece.upload-start");const d=await fetch(`${this._serviceURL}/pdp/piece/upload/${p}`,{method:"PUT",headers:{"Content-Type":"application/octet-stream","Content-Length":t.length.toString()},body:t});if(performance.mark("synapse:PUT.pdp.piece.upload-end"),performance.measure("synapse:PUT.pdp.piece.upload","synapse:PUT.pdp.piece.upload-start","synapse:PUT.pdp.piece.upload-end"),204!==d.status){const e=await d.text();throw new Error(`Failed to upload piece: ${d.status} ${d.statusText} - ${e}`)}return{pieceCid:n,size:a}}async downloadPiece(e){const t=On(e);if(null==t)throw new Error(`Invalid PieceCID: ${String(e)}`);const n=R(this._serviceURL,t),a=await fetch(n);return await N(a,t)}async getDataSet(e){const t=await fetch(`${this._serviceURL}/pdp/data-sets/${e}`,{method:"GET",headers:{Accept:"application/json"}});if(404===t.status)throw new Error(`Data set not found: ${e}`);if(!t.ok){const e=await t.text();throw new Error(`Failed to fetch data set: ${t.status} ${t.statusText} - ${e}`)}const n=await t.json(),a=Zn(n);if(null==a)throw console.error("Invalid data set data response:",n),new Error("Invalid data set data response format");return a}_encodeDataSetCreateData(t){const n=t.signature.startsWith("0x")?t.signature:`0x${t.signature}`,a=t.metadata.map(e=>e.key),r=t.metadata.map(e=>e.value);return e.AbiCoder.defaultAbiCoder().encode(["address","string[]","string[]","bytes"],[t.payer,a,r,n]).slice(2)}_encodeAddPiecesExtraData(t){const n=t.signature.startsWith("0x")?t.signature:`0x${t.signature}`,a=t.metadata.map(e=>e.map(e=>e.key)),r=t.metadata.map(e=>e.map(e=>e.value));return e.AbiCoder.defaultAbiCoder().encode(["bytes","string[][]","string[][]"],[n,a,r]).slice(2)}async ping(){const e=await fetch(`${this._serviceURL}/pdp/ping`,{method:"GET",headers:{}});if(200!==e.status){const t=await e.text().catch(()=>"Unknown error");throw new Error(`Provider ping failed: ${e.status} ${e.statusText} - ${t}`)}}getServiceURL(){return this._serviceURL}getAuthHelper(){if(null==this._authHelper)throw new Error("AuthHelper is not available for an operation that requires signing");return this._authHelper}}class Xn{_provider;_contractAddress;_contract;constructor(t,n){this._provider=t,this._contractAddress=n,this._contract=new e.Contract(this._contractAddress,d.PDP_VERIFIER,this._provider)}async dataSetLive(e){return await this._contract.dataSetLive(e)}async getNextPieceId(e){const t=await this._contract.getNextPieceId(e);return Number(t)}async getDataSetListener(e){return await this._contract.getDataSetListener(e)}async getDataSetStorageProvider(e){const[t,n]=await this._contract.getDataSetStorageProvider(e);return{storageProvider:t,proposedStorageProvider:n}}async getDataSetLeafCount(e){const t=await this._contract.getDataSetLeafCount(e);return Number(t)}extractDataSetIdFromReceipt(e){try{for(const t of e.logs)try{const e=this._contract.interface.parseLog({topics:t.topics,data:t.data});if(null!=e&&"DataSetCreated"===e.name)return Number(e.args.setId)}catch{}return null}catch(e){throw new Error(`Failed to extract data set ID from receipt: ${e instanceof Error?e.message:String(e)}`)}}getContractAddress(){return this._contract.target}}class Jn{_provider;_registryAddress;_registryContract=null;constructor(e,t){this._provider=e,this._registryAddress=t}static async create(e,t){return new Jn(e,t)}_getRegistryContract(){return null==this._registryContract&&(this._registryContract=new e.Contract(this._registryAddress,d.SERVICE_PROVIDER_REGISTRY,this._provider)),this._registryContract}async registerProvider(e,t){const n=this._getRegistryContract().connect(e),a=await n.REGISTRATION_FEE();let r=0,i="0x",s=[],o=[];if(null!=t.pdpOffering&&(r=0,i=await this.encodePDPOffering(t.pdpOffering),null!=t.capabilities)){s=[],o=[];for(const[e,n]of Object.entries(t.capabilities))s.push(e),o.push(n??"")}return await n.registerProvider(t.payee,t.name,t.description,r,i,s,o,{value:a})}async updateProviderInfo(e,t,n){const a=this._getRegistryContract().connect(e);return await a.updateProviderInfo(t,n)}async removeProvider(e){const t=this._getRegistryContract().connect(e);return await t.removeProvider()}async getProvider(t){try{const n=this._getRegistryContract(),a=await n.getProvider(t);if(a.serviceProvider===e.ZeroAddress)return null;const r=await this._getProviderProducts(t);return this._convertToProviderInfo(t,a,r)}catch(e){if(e instanceof Error&&e.message.includes("Provider not found"))return null;throw e}}async getProviderByAddress(t){try{const n=this._getRegistryContract(),[a,r]=await Promise.all([n.getProviderByAddress(t),n.getProviderIdByAddress(t)]);if(a.serviceProvider===e.ZeroAddress)return null;const i=await this._getProviderProducts(Number(r));return this._convertToProviderInfo(Number(r),a,i)}catch{return null}}async getProviderIdByAddress(e){const t=this._getRegistryContract(),n=await t.getProviderIdByAddress(e);return Number(n)}async getAllActiveProviders(){const e=this._getRegistryContract(),t=[];let n=0,a=!0;for(;a;){const r=await e.getAllActiveProviders(n,50),i=r[0];if(a=r[1],i.length>0){const e=i.map(e=>Number(e));t.push(this.getProviders(e))}n+=50}return(await Promise.all(t)).flat()}async getActiveProvidersByProductType(e){const t=this._getRegistryContract(),n=[];let a=0,r=!0;for(;r;){const i=await t.getProvidersByProductType(e,a,50);if(i.providerIds.length>0){const e=i.providerIds.map(e=>Number(e));n.push(this.getProviders(e))}r=i.hasMore,a+=50}return(await Promise.all(n)).flat().filter(e=>e.active)}async isProviderActive(e){const t=this._getRegistryContract();return await t.isProviderActive(e)}async isRegisteredProvider(e){const t=this._getRegistryContract();return await t.isRegisteredProvider(e)}async getProviderCount(){const e=this._getRegistryContract(),t=await e.getProviderCount();return Number(t)}async activeProviderCount(){const e=this._getRegistryContract(),t=await e.activeProviderCount();return Number(t)}async addPDPProduct(e,t,n={}){const a=this._getRegistryContract().connect(e),r=await this.encodePDPOffering(t),i=Object.entries(n),s=i.map(([e])=>e),o=i.map(([,e])=>e||"");return await a.addProduct(0,r,s,o)}async updatePDPProduct(e,t,n={}){const a=this._getRegistryContract().connect(e),r=await this.encodePDPOffering(t),i=Object.entries(n),s=i.map(([e])=>e),o=i.map(([,e])=>e||"");return await a.updateProduct(0,r,s,o)}async removeProduct(e,t){const n=this._getRegistryContract().connect(e);return await n.removeProduct(t)}async getPDPService(e){try{const t=this._getRegistryContract(),n=await t.getPDPService(e);return n.pdpOffering.serviceURL?{offering:{serviceURL:n.pdpOffering.serviceURL,minPieceSizeInBytes:n.pdpOffering.minPieceSizeInBytes,maxPieceSizeInBytes:n.pdpOffering.maxPieceSizeInBytes,ipniPiece:n.pdpOffering.ipniPiece,ipniIpfs:n.pdpOffering.ipniIpfs,storagePricePerTibPerMonth:n.pdpOffering.storagePricePerTibPerMonth,minProvingPeriodInEpochs:Number(n.pdpOffering.minProvingPeriodInEpochs),location:n.pdpOffering.location,paymentTokenAddress:n.pdpOffering.paymentTokenAddress},capabilities:this._convertCapabilitiesToObject(n.capabilityKeys,n.capabilityValues||[]),isActive:n.isActive}:null}catch{return null}}async providerHasProduct(e,t){const n=this._getRegistryContract();return await n.providerHasProduct(e,t)}async getProviders(e){if(0===e.length)return[];try{return await this._getProvidersWithMulticall(e)}catch{return await this._getProvidersIndividually(e)}}async _getProvidersWithMulticall(t){const n=await x(this._provider),a=f.MULTICALL3[n],r=new e.Contract(a,d.MULTICALL3,this._provider),i=new e.Interface(d.SERVICE_PROVIDER_REGISTRY),s=this._prepareMulticallCalls(t,i),o=await r.aggregate3.staticCall(s);return this._processMulticallResults(t,o,i)}_prepareMulticallCalls(e,t){const n=[];for(const a of e)n.push({target:this._registryAddress,allowFailure:!0,callData:t.encodeFunctionData("getProvider",[a])}),n.push({target:this._registryAddress,allowFailure:!0,callData:t.encodeFunctionData("getPDPService",[a])});return n}_processMulticallResults(e,t,n){const a=[];for(let r=0;r<e.length;r++){const i=2*r,s=2*r+1;if(t[i].success)try{const o=n.decodeFunctionResult("getProvider",t[i].returnData)[0],p=this._extractProductsFromMulticallResult(t[s],n),d=this._convertToProviderInfo(e[r],o,p);a.push(d)}catch{}}return a}_extractProductsFromMulticallResult(e,t){const n=[];if(!e.success)return n;try{const a=t.decodeFunctionResult("getPDPService",e.returnData),[r,i,s]=a;if(!r[0])return n;const o=this._buildCapabilitiesFromKeys(i);n.push({type:"PDP",isActive:s,capabilities:o,data:{serviceURL:r[0],minPieceSizeInBytes:r[1],maxPieceSizeInBytes:r[2],ipniPiece:r[3],ipniIpfs:r[4],storagePricePerTibPerMonth:r[5],minProvingPeriodInEpochs:Number(r[6]),location:r[7],paymentTokenAddress:r[8]}})}catch{}return n}_buildCapabilitiesFromKeys(e){const t={};if(e&&Array.isArray(e))for(const n of e)t[n]="";return t}async _getProvidersIndividually(e){const t=[],n=e.map(e=>this.getProvider(e)),a=await Promise.all(n);for(const e of a)null!=e&&t.push(e);return t}async _getProviderProducts(e){const t=[],n=await this.getPDPService(e);return null!=n&&t.push({type:"PDP",isActive:n.isActive,capabilities:n.capabilities,data:n.offering}),t}_convertToProviderInfo(e,t,n){const a={};for(const e of n)"PDP"===e.type&&(a.PDP=e);return{id:e,serviceProvider:t.serviceProvider,payee:t.payee,name:t.name,description:t.description,active:t.isActive,products:a}}_convertCapabilitiesToObject(e,t){const n={};for(let a=0;a<e.length;a++)n[e[a]]=t[a]||"";return n}async encodePDPOffering(e){const t=this._getRegistryContract();return await t.encodePDPOffering(e)}}class ea{warmStorage;spRegistry;constructor(e,t){this.warmStorage=e,this.spRegistry=t}async getApprovedProviders(e=50){const t=await this.warmStorage.getApprovedProviderIds();if(t.length<=e)return await this.spRegistry.getProviders(t);const n=[];let a=0;for(;a<t.length;){const r=t.slice(a,a+e),i=await this.spRegistry.getProviders(r);n.push(...i),a+=e}return n}async getApprovedProvider(e){return await this.warmStorage.isProviderIdApproved(e)?await this.spRegistry.getProvider(e):null}async getApprovedProvidersByIds(t){if(0===t.length)return[];try{const n=this.warmStorage.getProvider(),a=await x(n),r=f.MULTICALL3[a],i=new e.Contract(r,d.MULTICALL3,n),s=this.warmStorage.getViewContractAddress(),o=new e.Interface(d.WARM_STORAGE_VIEW),p=t.map(e=>({target:s,allowFailure:!0,callData:o.encodeFunctionData("isProviderApproved",[e])})),u=(await i.aggregate3.staticCall(p)).map(e=>{if(!e.success)return!1;try{return o.decodeFunctionResult("isProviderApproved",e.returnData)[0]}catch{return!1}}),l=t.filter((e,t)=>u[t]);if(0===l.length)return t.map(()=>null);const c=await this.spRegistry.getProviders(l),y=new Map;for(const e of c)y.set(e.id,e);return t.map((e,t)=>u[t]?y.get(e)??null:null)}catch{const e=await Promise.all(t.map(e=>this.warmStorage.isProviderIdApproved(e))),n=t.filter((t,n)=>e[n]);if(0===n.length)return t.map(()=>null);const a=await this.spRegistry.getProviders(n),r=new Map;for(const e of a)r.set(e.id,e);return t.map((t,n)=>e[n]?r.get(t)??null:null)}}async getApprovedProviderByAddress(e){const t=await this.spRegistry.getProviderByAddress(e);return null==t?null:await this.warmStorage.isProviderIdApproved(t.id)?t:null}async isProviderApproved(e){return!!await this.warmStorage.isProviderIdApproved(e)&&await this.spRegistry.isProviderActive(e)}}class ta{_synapse;_provider;_pdpServer;_warmStorageService;_warmStorageAddress;_withCDN;_dataSetId;_signer;_uploadBatchSize;_dataSetMetadata;_pendingPieces=[];_isProcessing=!1;dataSetId;serviceProvider;get withCDN(){return this._withCDN}get provider(){return this._provider}get dataSetMetadata(){return this._dataSetMetadata}static validateRawSize(e,t){if(e<c.MIN_UPLOAD_SIZE)throw v("StorageContext",t,`Data size ${e} bytes is below minimum allowed size of ${c.MIN_UPLOAD_SIZE} bytes`);if(e>c.MAX_UPLOAD_SIZE)throw v("StorageContext",t,`Data size ${e} bytes exceeds maximum allowed size of ${c.MAX_UPLOAD_SIZE} bytes (${Math.floor(c.MAX_UPLOAD_SIZE/1024/1024)} MiB)`)}constructor(e,t,n,a,r,i){this._synapse=e,this._provider=n,this._dataSetId=a,this._withCDN=r.withCDN??!1,this._signer=e.getSigner(),this._warmStorageService=t,this._uploadBatchSize=Math.max(1,r.uploadBatchSize??c.DEFAULT_UPLOAD_BATCH_SIZE),this._dataSetMetadata=i,this.dataSetId=a,this.serviceProvider=n.serviceProvider,this._warmStorageAddress=e.getWarmStorageAddress();const s=new Wn(this._warmStorageAddress,this._signer,BigInt(e.getChainId()));if(!n.products.PDP?.data.serviceURL)throw new Error(`Provider ${n.id} does not have a PDP product with serviceURL`);this._pdpServer=new Qn(s,n.products.PDP.data.serviceURL)}static async create(e,t,n={}){const a=t.getServiceProviderRegistryAddress(),r=new Jn(e.getProvider(),a),i=new ea(t,r),s=await ta.resolveProviderAndDataSet(e,t,i,n);try{n.callbacks?.onProviderSelected?.(s.provider)}catch(e){console.error("Error in onProviderSelected callback:",e)}let o;if(-1===s.dataSetId||!0===n.forceCreateDataSet)o=await ta.createDataSet(e,t,s.provider,n.withCDN??!1,n.callbacks,n.metadata);else{o=s.dataSetId;try{n.callbacks?.onDataSetResolved?.({isExisting:s.isExisting??!0,dataSetId:o,provider:s.provider})}catch(e){console.error("Error in onDataSetResolved callback:",e)}}return new ta(e,t,s.provider,o,n,s.dataSetMetadata)}static async createDataSet(e,t,n,a,r,i){performance.mark("synapse:createDataSet-start");const s=e.getSigner(),o=await s.getAddress(),p=await t.getNextClientDataSetId(o),d=e.getWarmStorageAddress(),u=new Wn(d,s,BigInt(e.getChainId()));if(!n.products.PDP?.data.serviceURL)throw new Error(`Provider ${n.id} does not have a PDP product with serviceURL`);const l=new Qn(u,n.products.PDP.data.serviceURL),c=i??{},h=A(a&&!(y.WITH_CDN in c)?{...c,[y.WITH_CDN]:""}:c);performance.mark("synapse:pdpServer.createDataSet-start");const g=await l.createDataSet(p,n.payee,h,d);performance.mark("synapse:pdpServer.createDataSet-end"),performance.measure("synapse:pdpServer.createDataSet","synapse:pdpServer.createDataSet-start","synapse:pdpServer.createDataSet-end");const{txHash:f,statusUrl:w}=g,T=e.getProvider();let S=null;const P=Date.now(),b=m.TRANSACTION_PROPAGATION_TIMEOUT_MS,I=m.TRANSACTION_PROPAGATION_POLL_INTERVAL_MS;for(performance.mark("synapse:getTransaction-start");Date.now()-P<b;){try{if(S=await T.getTransaction(f),null!==S)break}catch(e){console.warn(`Failed to fetch transaction ${f}, retrying...`,e)}await new Promise(e=>setTimeout(e,I))}if(performance.mark("synapse:getTransaction-end"),performance.measure("synapse:getTransaction","synapse:getTransaction-start","synapse:getTransaction-end"),null===S)throw v("StorageContext","create",`Transaction ${f} not found after ${b/1e3} seconds. The transaction may not have propagated to the RPC node.`);try{r?.onDataSetCreationStarted?.(S,w)}catch(e){console.error("Error in onDataSetCreationStarted callback:",e)}let C;performance.mark("synapse:waitForDataSetCreationWithStatus-start");try{C=await t.waitForDataSetCreationWithStatus(S,l,m.DATA_SET_CREATION_TIMEOUT_MS,m.DATA_SET_CREATION_POLL_INTERVAL_MS,async(e,t)=>{if(null!=r?.onDataSetCreationProgress)try{let n;if(e.chainStatus.transactionMined&&null!=e.chainStatus.blockNumber)try{n=await S.wait(m.TRANSACTION_CONFIRMATIONS)??void 0}catch(e){console.error("Failed to fetch transaction receipt:",e)}r.onDataSetCreationProgress({transactionMined:e.chainStatus.transactionMined,transactionSuccess:e.chainStatus.transactionSuccess,dataSetLive:e.chainStatus.dataSetLive,serverConfirmed:!0===e.serverStatus?.ok,dataSetId:e.summary.dataSetId??void 0,elapsedMs:t,receipt:n})}catch(e){console.error("Error in onDataSetCreationProgress callback:",e)}})}catch(e){throw performance.mark("synapse:waitForDataSetCreationWithStatus-end"),performance.measure("synapse:waitForDataSetCreationWithStatus","synapse:waitForDataSetCreationWithStatus-start","synapse:waitForDataSetCreationWithStatus-end"),v("StorageContext","waitForDataSetCreation",e instanceof Error?e.message:"Data set creation failed")}if(performance.mark("synapse:waitForDataSetCreationWithStatus-end"),performance.measure("synapse:waitForDataSetCreationWithStatus","synapse:waitForDataSetCreationWithStatus-start","synapse:waitForDataSetCreationWithStatus-end"),!C.summary.isComplete||null==C.summary.dataSetId)throw v("StorageContext","waitForDataSetCreation",`Data set creation failed: ${C.summary.error??"Transaction may have failed"}`);const D=C.summary.dataSetId;try{r?.onDataSetResolved?.({isExisting:!1,dataSetId:D,provider:n})}catch(e){console.error("Error in onDataSetResolved callback:",e)}return performance.mark("synapse:createDataSet-end"),performance.measure("synapse:createDataSet","synapse:createDataSet-start","synapse:createDataSet-end"),D}static async resolveProviderAndDataSet(e,t,n,a){const r=e.getSigner(),i=await r.getAddress();if(null!=a.dataSetId)return await ta.resolveByDataSetId(a.dataSetId,t,n,i,a);const s=E(a.metadata,a.withCDN);return null!=a.providerId?await ta.resolveByProviderId(i,a.providerId,s,t,n):null!=a.providerAddress?await ta.resolveByProviderAddress(a.providerAddress,t,n,i,s):await ta.smartSelectProvider(i,s,t,n,r)}static async resolveByDataSetId(e,t,n,a,r){const i=(await t.getClientDataSetsWithDetails(a)).find(t=>t.pdpVerifierDataSetId===e);if(null==i||!i.isLive||!i.isManaged)throw v("StorageContext","resolveByDataSetId",`Data set ${e} not found, not owned by ${a}, or not managed by the current WarmStorage contract`);null==r.providerId&&null==r.providerAddress||await ta.validateDataSetConsistency(i,r,n);const s=await n.getApprovedProvider(i.providerId);if(null==s)throw v("StorageContext","resolveByDataSetId",`Provider ID ${i.providerId} for data set ${e} is not currently approved`);if(null!=r.withCDN&&i.withCDN!==r.withCDN)throw v("StorageContext","resolveByDataSetId",`Data set ${e} has CDN ${i.withCDN?"enabled":"disabled"}, but requested `+(r.withCDN?"enabled":"disabled"));const o=await t.getDataSetMetadata(e);return{provider:s,dataSetId:e,isExisting:!0,dataSetMetadata:o}}static async validateDataSetConsistency(e,t,n){if(null!=t.providerId&&e.providerId!==t.providerId)throw v("StorageContext","validateDataSetConsistency",`Data set ${e.pdpVerifierDataSetId} belongs to provider ID ${e.providerId}, but provider ID ${t.providerId} was requested`);if(null!=t.providerAddress){const a=await n.getApprovedProvider(e.providerId);if(null==a||a.serviceProvider.toLowerCase()!==t.providerAddress.toLowerCase())throw v("StorageContext","validateDataSetConsistency",`Data set ${e.pdpVerifierDataSetId} belongs to provider ${a?.serviceProvider??"unknown"}, but provider ${t.providerAddress} was requested`)}}static async resolveByProviderId(e,t,n,a,r){const[i,s]=await Promise.all([r.getApprovedProvider(t),a.getClientDataSetsWithDetails(e)]);if(null==i)throw v("StorageContext","resolveByProviderId",`Provider ID ${t} is not currently approved`);const o=s.filter(e=>!(e.providerId!==i.id||!e.isLive||!e.isManaged)&&_(e.metadata,n));if(o.length>0){const e=o.sort((e,t)=>e.currentPieceCount>0&&0===t.currentPieceCount?-1:t.currentPieceCount>0&&0===e.currentPieceCount?1:e.pdpVerifierDataSetId-t.pdpVerifierDataSetId),t=await a.getDataSetMetadata(e[0].pdpVerifierDataSetId);return{provider:i,dataSetId:e[0].pdpVerifierDataSetId,isExisting:!0,dataSetMetadata:t}}return{provider:i,dataSetId:-1,isExisting:!1,dataSetMetadata:n}}static async resolveByProviderAddress(e,t,n,a,r){const i=await n.getApprovedProviderByAddress(e);if(null==i)throw v("StorageContext","resolveByProviderAddress",`Provider ${e} is not currently approved`);return await ta.resolveByProviderId(a,i.id,r,t,n)}static async smartSelectProvider(e,t,n,a,r){const i=(await n.getClientDataSetsWithDetails(e)).filter(e=>e.isLive&&e.isManaged&&_(e.metadata,t));if(i.length>0){const o=i.sort((e,t)=>e.currentPieceCount>0&&0===t.currentPieceCount?-1:t.currentPieceCount>0&&0===e.currentPieceCount?1:e.pdpVerifierDataSetId-t.pdpVerifierDataSetId);async function*p(){const e=new Set;for(const t of o){const n=await a.getApprovedProvider(t.providerId);null!=n?e.has(n.serviceProvider.toLowerCase())||(e.add(n.serviceProvider.toLowerCase()),yield n):console.warn(`Provider ID ${t.providerId} for data set ${t.pdpVerifierDataSetId} is not currently approved`)}}try{const d=await ta.selectProviderWithPing(p()),u=o.find(e=>e.providerId===d.id);if(null!=u){const l=await n.getDataSetMetadata(u.pdpVerifierDataSetId);return{provider:d,dataSetId:u.pdpVerifierDataSetId,isExisting:!0,dataSetMetadata:l}}console.warn(`Could not match selected provider ${d.serviceProvider} (ID: ${d.id}) to existing data sets. Falling back to selecting from all providers.`)}catch(c){console.warn("All providers from existing data sets failed health check. Falling back to all providers.")}}const s=await a.getApprovedProviders();if(0===s.length)throw v("StorageContext","smartSelectProvider","No approved service providers available");return{provider:await ta.selectRandomProvider(s,r),dataSetId:-1,isExisting:!1,dataSetMetadata:t}}static async selectRandomProvider(e,t){if(0===e.length)throw v("StorageContext","selectRandomProvider","No providers available");return await ta.selectProviderWithPing(async function*(){const n=[...e];for(;n.length>0;){let e;if(void 0!==globalThis.crypto&&null!=globalThis.crypto.getRandomValues){const t=new Uint8Array(1);globalThis.crypto.getRandomValues(t),e=t[0]%n.length}else{const a=Date.now(),r=Math.random();if(null!=t){const i=a*r*(await t.getAddress()).split("").reduce((e,t)=>e+t.charCodeAt(0),0)%n.length;e=Math.floor(Math.abs(i))}else e=Math.floor(Math.random()*n.length)}const a=n.splice(e,1)[0];yield a}}())}static async selectProviderWithPing(e){let t=0;for await(const n of e){t++;try{if(!n.products.PDP?.data.serviceURL)continue;const e=new Qn(null,n.products.PDP.data.serviceURL);return await e.ping(),n}catch(e){console.warn(`Provider ${n.serviceProvider} failed ping test:`,e instanceof Error?e.message:String(e))}}if(0===t)throw v("StorageContext","selectProviderWithPing","No providers available to select from");throw v("StorageContext","selectProviderWithPing",`All ${t} providers failed health check. Storage may be temporarily unavailable.`)}static async performPreflightCheck(e,t,n,a){ta.validateRawSize(n,"preflightUpload");const r=await e.checkAllowanceForStorage(n,a,t);return{estimatedCost:{perEpoch:r.costs.perEpoch,perDay:r.costs.perDay,perMonth:r.costs.perMonth},allowanceCheck:{sufficient:r.sufficient,message:r.message},selectedProvider:null,selectedDataSetId:null}}async preflightUpload(e){return{...await ta.performPreflightCheck(this._warmStorageService,this._synapse.payments,e,this._withCDN),selectedProvider:this._provider,selectedDataSetId:this._dataSetId}}async upload(e,t){performance.mark("synapse:upload-start");const n=e instanceof ArrayBuffer?new Uint8Array(e):e,a=n.length;let r;ta.validateRawSize(a,"upload");try{performance.mark("synapse:pdpServer.uploadPiece-start"),r=await this._pdpServer.uploadPiece(n),performance.mark("synapse:pdpServer.uploadPiece-end"),performance.measure("synapse:pdpServer.uploadPiece","synapse:pdpServer.uploadPiece-start","synapse:pdpServer.uploadPiece-end")}catch(e){throw performance.mark("synapse:pdpServer.uploadPiece-end"),performance.measure("synapse:pdpServer.uploadPiece","synapse:pdpServer.uploadPiece-start","synapse:pdpServer.uploadPiece-end"),v("StorageContext","uploadPiece","Failed to upload piece to service provider",e)}const i=m.PIECE_PARKING_TIMEOUT_MS,s=m.PIECE_PARKING_POLL_INTERVAL_MS,o=Date.now();let p=!1;for(performance.mark("synapse:findPiece-start");Date.now()-o<i;)try{await this._pdpServer.findPiece(r.pieceCid),p=!0;break}catch{Date.now()-o+s<i&&await new Promise(e=>setTimeout(e,s))}if(performance.mark("synapse:findPiece-end"),performance.measure("synapse:findPiece","synapse:findPiece-start","synapse:findPiece-end"),!p)throw v("StorageContext","findPiece","Timeout waiting for piece to be parked on service provider");null!=t?.onUploadComplete&&t.onUploadComplete(r.pieceCid);const d=r.pieceCid;null!=t?.metadata&&D(t.metadata);const u=await new Promise((e,n)=>{this._pendingPieces.push({pieceData:d,resolve:e,reject:n,callbacks:t,metadata:t?.metadata?A(t.metadata):void 0}),setTimeout(()=>{this._processPendingPieces().catch(e=>{console.error("Failed to process pending pieces batch:",e)})},0)});return performance.mark("synapse:upload-end"),performance.measure("synapse:upload","synapse:upload-start","synapse:upload-end"),{pieceCid:r.pieceCid,size:r.size,pieceId:u}}async _processPendingPieces(){if(this._isProcessing||0===this._pendingPieces.length)return;this._isProcessing=!0;const e=this._pendingPieces.slice(0,this._uploadBatchSize);this._pendingPieces=this._pendingPieces.slice(this._uploadBatchSize);try{performance.mark("synapse:getAddPiecesInfo-start");const t=await this._warmStorageService.getAddPiecesInfo(this._dataSetId);performance.mark("synapse:getAddPiecesInfo-end"),performance.measure("synapse:getAddPiecesInfo","synapse:getAddPiecesInfo-start","synapse:getAddPiecesInfo-end");const n=e.map(e=>e.pieceData),a=e.map(e=>e.metadata??[]);performance.mark("synapse:pdpServer.addPieces-start");const r=await this._pdpServer.addPieces(this._dataSetId,t.clientDataSetId,t.nextPieceId,n,a);performance.mark("synapse:pdpServer.addPieces-end"),performance.measure("synapse:pdpServer.addPieces","synapse:pdpServer.addPieces-start","synapse:pdpServer.addPieces-end");let i=[];if(null==r.txHash)throw v("StorageContext","addPieces","Server did not return a transaction hash for piece addition");let s=null;const o=Date.now(),p=m.TRANSACTION_PROPAGATION_TIMEOUT_MS,d=m.TRANSACTION_PROPAGATION_POLL_INTERVAL_MS;for(performance.mark("synapse:getTransaction.addPieces-start");Date.now()-o<p;){try{if(s=await this._synapse.getProvider().getTransaction(r.txHash),null!==s)break}catch{}await new Promise(e=>setTimeout(e,d))}if(performance.mark("synapse:getTransaction.addPieces-end"),performance.measure("synapse:getTransaction.addPieces","synapse:getTransaction.addPieces-start","synapse:getTransaction.addPieces-end"),null==s)throw v("StorageContext","addPieces",`Server returned transaction hash ${r.txHash} but transaction was not found on-chain after ${p/1e3} seconds`);let u;e.forEach(e=>{e.callbacks?.onPieceAdded?.(s)});try{performance.mark("synapse:transaction.wait-start"),u=await s.wait(m.TRANSACTION_CONFIRMATIONS),performance.mark("synapse:transaction.wait-end"),performance.measure("synapse:transaction.wait","synapse:transaction.wait-start","synapse:transaction.wait-end")}catch(e){throw performance.mark("synapse:transaction.wait-end"),performance.measure("synapse:transaction.wait","synapse:transaction.wait-start","synapse:transaction.wait-end"),v("StorageContext","addPieces","Failed to wait for transaction confirmation",e)}if(1!==u?.status)throw v("StorageContext","addPieces","Piece addition transaction  failed on-chain");const l=m.PIECE_ADDITION_TIMEOUT_MS,c=m.PIECE_ADDITION_POLL_INTERVAL_MS,y=Date.now();let h=null,g=!1;for(performance.mark("synapse:getPieceAdditionStatus-start");Date.now()-y<l;)try{const t=await this._pdpServer.getPieceAdditionStatus(this._dataSetId,r.txHash);if("pending"===t.txStatus||null===t.addMessageOk){await new Promise(e=>setTimeout(e,c));continue}if(!t.addMessageOk)throw new Error("Piece addition failed: Transaction was unsuccessful");if(null!=t.confirmedPieceIds&&t.confirmedPieceIds.length>0){i=t.confirmedPieceIds,e.forEach(e=>{e.callbacks?.onPieceConfirmed?.(t.confirmedPieceIds??[])}),g=!0;break}await new Promise(e=>setTimeout(e,c))}catch(e){if(h=e,e instanceof Error&&e.message.includes("not found")){await new Promise(e=>setTimeout(e,c));continue}throw v("StorageContext","addPieces",`Failed to verify piece addition with server: ${e instanceof Error?e.message:"Unknown error"}`,e)}if(performance.mark("synapse:getPieceAdditionStatus-end"),performance.measure("synapse:getPieceAdditionStatus","synapse:getPieceAdditionStatus-start","synapse:getPieceAdditionStatus-end"),!g)throw v("StorageContext","addPieces",`Failed to verify piece addition after ${l/1e3} seconds: ${null!=h?h.message:"Server did not provide confirmation"}. The transaction was confirmed on-chain but the server failed to acknowledge it.`,h);e.forEach((e,n)=>{const a=i[n]??t.nextPieceId+n;e.resolve(a)})}catch(t){const n=v("StorageContext","addPieces","Failed to add piece to data set",t);e.forEach(e=>{e.reject(n)})}finally{this._isProcessing=!1,this._pendingPieces.length>0&&this._processPendingPieces().catch(e=>{console.error("Failed to process pending pieces batch:",e)})}}async download(e,t){const n=this._synapse.storage?.download??this._synapse.download;return await n.call(this._synapse.storage??this._synapse,e,{providerAddress:this._provider.serviceProvider,withCDN:t?.withCDN??this._withCDN})}async providerDownload(e,t){return console.warn("providerDownload() is deprecated. Use download() instead."),await this.download(e,t)}async getProviderInfo(){return await this._synapse.getProviderInfo(this.serviceProvider)}async getDataSetPieces(){return(await this._pdpServer.getDataSet(this._dataSetId)).pieces.map(e=>e.pieceCid)}async hasPiece(e){const t=On(e);if(null==t)return!1;try{return await this._pdpServer.findPiece(t),!0}catch{return!1}}async pieceStatus(e){const t=On(e);if(null==t)throw v("StorageContext","pieceStatus","Invalid PieceCID provided");const[n,a,r]=await Promise.all([this.hasPiece(t),this._pdpServer.getDataSet(this._dataSetId).catch(e=>(console.debug("Failed to get data set data:",e),null)),I(this._synapse.getProvider())]),i=this._synapse.getNetwork();let s,o=null,p=null,d=null,u=!1,l=0,c=!1;if(n){const[e,n]=await Promise.all([this.getProviderInfo().catch(()=>null),null!=a?Promise.all([this._warmStorageService.getMaxProvingPeriod(),this._warmStorageService.getChallengeWindow()]).then(([e,t])=>({maxProvingPeriod:e,challengeWindow:t})).catch(()=>null):Promise.resolve(null)]);if(null!=e){if(!e.products.PDP?.data.serviceURL)throw new Error(`Provider ${e.id} does not have a PDP product with serviceURL`);o=`${e.products.PDP.data.serviceURL.replace(/\/$/,"")}/piece/${t.toString()}`}if(null!=a&&null!=n){const e=a.pieces.find(e=>e.pieceCid.toString()===t.toString());if(null!=e)if(s=e.pieceId,a.nextChallengeEpoch>0){const e=a.nextChallengeEpoch,t=e+n.challengeWindow;d=w(t,i);const s=b(a.nextChallengeEpoch,n.maxProvingPeriod,i);null!=s&&(p=s),u=Number(r)>=e&&Number(r)<t,c=Number(r)>=t,Number(r)<e&&(l=P(e,Number(r)).hours)}else console.debug("Data set has nextChallengeEpoch=0, may have just been proven")}}return{exists:n,dataSetLastProven:p,dataSetNextProofDue:d,retrievalUrl:o,pieceId:s,inChallengeWindow:u,hoursUntilChallengeWindow:l,isProofOverdue:c}}async terminate(){return this._synapse.storage.terminateDataSet(this._dataSetId)}}class na{_synapse;_warmStorageService;_pieceRetriever;_withCDN;_defaultContext;constructor(e,t,n,a){this._synapse=e,this._warmStorageService=t,this._pieceRetriever=n,this._withCDN=a}async upload(e,t){if(null!=t?.context){const e=[];if(void 0!==t.providerId&&e.push("providerId"),void 0!==t.providerAddress&&e.push("providerAddress"),void 0!==t.dataSetId&&e.push("dataSetId"),void 0!==t.withCDN&&e.push("withCDN"),void 0!==t.forceCreateDataSet&&e.push("forceCreateDataSet"),void 0!==t.uploadBatchSize&&e.push("uploadBatchSize"),e.length>0)throw v("StorageManager","upload",`Cannot specify both 'context' and other options: ${e.join(", ")}`)}const n=t?.context??await this.createContext({providerId:t?.providerId,providerAddress:t?.providerAddress,dataSetId:t?.dataSetId,withCDN:t?.withCDN,forceCreateDataSet:t?.forceCreateDataSet,uploadBatchSize:t?.uploadBatchSize,callbacks:t?.callbacks});return await n.upload(e,{...t?.callbacks,metadata:t?.metadata})}async download(e,t){if(null!=t?.context){const n=[];if(void 0!==t.providerAddress&&n.push("providerAddress"),void 0!==t.withCDN&&n.push("withCDN"),n.length>0)throw v("StorageManager","download",`Cannot specify both 'context' and other options: ${n.join(", ")}`);return await t.context.download(e,t)}const n=On(e);if(null==n)throw v("StorageManager","download",`Invalid PieceCID: ${String(e)}`);const a=t?.withCDN??this._withCDN;if(null!=this._defaultContext&&!a&&null==t?.providerAddress&&!1===(this._defaultContext._withCDN??this._withCDN)&&await this._defaultContext.hasPiece(n))return await this._defaultContext.download(e,t);const r=await this._synapse.getSigner().getAddress(),i=await this._pieceRetriever.fetchPiece(n,r,{providerAddress:t?.providerAddress,withCDN:a});return await N(i,n)}async preflightUpload(e,t){let n=t?.withCDN??this._withCDN;if(null!=t?.metadata&&y.WITH_CDN in t.metadata){const e=t.metadata[y.WITH_CDN];""!==e&&console.warn(`Warning: withCDN metadata entry has unexpected value "${e}". Expected empty string.`),n=!0}return await ta.performPreflightCheck(this._warmStorageService,this._synapse.payments,e,n)}async createContext(e){const t=e?.withCDN??this._withCDN;if(null==e||null==e.providerId&&null==e.providerAddress&&null==e.dataSetId&&!0!==e.forceCreateDataSet&&null==e.uploadBatchSize){if(null!=this._defaultContext){const n=E(e?.metadata,t);if(_(this._defaultContext.dataSetMetadata,n)){if(null!=e?.callbacks){try{e.callbacks.onProviderSelected?.(this._defaultContext.provider)}catch(e){console.error("Error in onProviderSelected callback:",e)}try{e.callbacks.onDataSetResolved?.({isExisting:!0,dataSetId:this._defaultContext.dataSetId,provider:this._defaultContext.provider})}catch(e){console.error("Error in onDataSetResolved callback:",e)}}return this._defaultContext}}const n=await ta.create(this._synapse,this._warmStorageService,{...e,withCDN:t});return this._defaultContext=n,n}return await ta.create(this._synapse,this._warmStorageService,{...e,withCDN:t})}async getDefaultContext(){return await this.createContext()}async findDataSets(e){const t=e??await this._synapse.getSigner().getAddress();return await this._warmStorageService.getClientDataSetsWithDetails(t)}async terminateDataSet(e){return this._warmStorageService.terminateDataSet(this._synapse.getSigner(),e)}async getStorageInfo(){try{const t=async()=>{try{const e=this._synapse.getWarmStorageAddress(),t=await this._synapse.payments.serviceApproval(e,o.USDFC);return{service:e,rateAllowance:t.rateAllowance,lockupAllowance:t.lockupAllowance,rateUsed:t.rateUsed,lockupUsed:t.lockupUsed}}catch{return null}},n=this._warmStorageService.getServiceProviderRegistryAddress(),a=new Jn(this._synapse.getProvider(),n),r=new ea(this._warmStorageService,a),[i,s,p]=await Promise.all([this._warmStorageService.getServicePrice(),r.getApprovedProviders(),t()]),d=BigInt(i.epochsPerMonth),l=BigInt(i.pricePerTiBPerMonthNoCDN)/d,y=BigInt(i.pricePerTiBPerMonthWithCDN)/d,m=BigInt(i.pricePerTiBPerMonthNoCDN)/u.DAYS_PER_MONTH,h=BigInt(i.pricePerTiBPerMonthWithCDN)/u.DAYS_PER_MONTH,g=s.filter(t=>t.serviceProvider!==e.ZeroAddress),f=this._synapse.getNetwork();return{pricing:{noCDN:{perTiBPerMonth:BigInt(i.pricePerTiBPerMonthNoCDN),perTiBPerDay:m,perTiBPerEpoch:l},withCDN:{perTiBPerMonth:BigInt(i.pricePerTiBPerMonthWithCDN),perTiBPerDay:h,perTiBPerEpoch:y},tokenAddress:i.tokenAddress,tokenSymbol:"USDFC"},providers:g,serviceParameters:{network:f,epochsPerMonth:d,epochsPerDay:u.EPOCHS_PER_DAY,epochDuration:u.EPOCH_DURATION,minUploadSize:c.MIN_UPLOAD_SIZE,maxUploadSize:c.MAX_UPLOAD_SIZE,warmStorageAddress:this._synapse.getWarmStorageAddress(),paymentsAddress:this._warmStorageService.getPaymentsAddress(),pdpVerifierAddress:this._warmStorageService.getPDPVerifierAddress()},allowances:p}}catch(e){throw new Error(`Failed to get storage service information: ${e instanceof Error?e.message:String(e)}`)}}}const aa="\n    query GetApprovedProvidersForCommP($cid: Bytes!) {\n      pieces(where: { cid: $cid }) {\n        id\n        dataSet {\n          setId\n          owner {\n            id\n            address\n            pdpUrl\n            pieceRetrievalUrl\n            registeredAt\n            status\n            approvedAt\n          }\n        }\n      }\n    }\n  ",ra="\n    query Provider($providerId: ID!) {\n      provider(id: $providerId) {\n        id\n        address\n        pdpUrl\n        pieceRetrievalUrl\n        registeredAt\n        approvedAt\n      }\n    }\n  ",ia="\n    query ProvidersFlexible($where: Provider_filter, $first: Int, $skip: Int, $orderBy: Provider_orderBy, $orderDirection: OrderDirection) {\n      providers(\n        where: $where\n        first: $first\n        skip: $skip\n        orderBy: $orderBy\n        orderDirection: $orderDirection\n      ) {\n        id\n        address\n        pdpUrl\n        pieceRetrievalUrl\n        registeredAt\n        approvedAt\n        status\n        totalFaultedPeriods\n        totalFaultedPieces\n        totalDataSets\n        totalPieces\n        totalDataSize\n        createdAt\n        updatedAt\n      }\n    }\n  ",sa="\n    query DataSetsFlexible($where: DataSet_filter, $first: Int, $skip: Int, $orderBy: DataSet_orderBy, $orderDirection: OrderDirection) {\n      dataSets(\n        where: $where\n        first: $first\n        skip: $skip\n        orderBy: $orderBy\n        orderDirection: $orderDirection\n      ) {\n        id\n        setId\n        listener\n        clientAddr\n        withCDN\n        isActive\n        leafCount\n        challengeRange\n        lastProvenEpoch\n        nextChallengeEpoch\n        totalPieces\n        totalDataSize\n        totalProofs\n        totalProvedPieces\n        totalFaultedPeriods\n        totalFaultedPieces\n        metadata\n        createdAt\n        updatedAt\n        owner {\n          id\n          address\n          pdpUrl\n          pieceRetrievalUrl\n          registeredAt\n          approvedAt\n        }\n        rail {\n          id\n          railId\n          token\n          paymentRate\n          lockupPeriod\n          settledUpto\n          endEpoch\n        }\n      }\n    }\n  ",oa="\n    query PiecesFlexible($where: Piece_filter, $first: Int, $skip: Int, $orderBy: Piece_orderBy, $orderDirection: OrderDirection) {\n      pieces(\n        where: $where\n        first: $first\n        skip: $skip\n        orderBy: $orderBy\n        orderDirection: $orderDirection\n      ) {\n        id\n        setId\n        pieceId\n        rawSize\n        leafCount\n        cid\n        removed\n        totalProofsSubmitted\n        totalPeriodsFaulted\n        lastProvenEpoch\n        lastProvenAt\n        lastFaultedEpoch\n        lastFaultedAt\n        createdAt\n        metadata\n        dataSet {\n          id\n          setId\n          isActive\n          owner {\n            id\n            address\n            pdpUrl\n            pieceRetrievalUrl\n            registeredAt\n            approvedAt\n          }\n        }\n      }\n    }\n  ",pa="\n    query FaultRecordsFlexible($where: FaultRecord_filter, $first: Int, $skip: Int, $orderBy: FaultRecord_orderBy, $orderDirection: OrderDirection) {\n      faultRecords(\n        where: $where\n        first: $first\n        skip: $skip\n        orderBy: $orderBy\n        orderDirection: $orderDirection\n      ) {\n        id\n        dataSetId\n        pieceIds\n        currentChallengeEpoch\n        nextChallengeEpoch\n        periodsFaulted\n        deadline\n        createdAt\n        dataSet {\n          id\n          setId\n          owner {\n            id\n            address\n            pdpUrl\n            pieceRetrievalUrl\n            registeredAt\n            approvedAt\n          }\n        }\n      }\n    }\n  ";class da{endpoint;headers;constructor(e){this.endpoint=this.resolveEndpoint(e),this.headers=this.buildHeaders(e.apiKey)}resolveEndpoint(e){if(null!=e.endpoint&&""!==e.endpoint.trim())return e.endpoint.trim();if(null!=e.goldsky)return this.buildGoldskyEndpoint(e.goldsky);throw v("SubgraphService","constructor","Invalid configuration: provide either endpoint or complete goldsky config")}buildGoldskyEndpoint(e){const{projectId:t,subgraphName:n,version:a}=e;if(null==t?.trim()||""===t?.trim()||null==n?.trim()||""===n?.trim()||null==a?.trim()||""===a?.trim())throw v("SubgraphService","constructor","Incomplete Goldsky config: projectId, subgraphName, and version required");return`https://api.goldsky.com/api/public/${t}/subgraphs/${n}/${a}/gn`}buildHeaders(e){const t={"Content-Type":"application/json"};return null!=e&&""!==e?{...t,Authorization:`Bearer ${e}`}:t}normalizeQueryOptions(e={}){return{where:{},first:10,skip:0,orderBy:"createdAt",orderDirection:"desc",...e}}async executeQuery(e,t,n){try{const a=await fetch(this.endpoint,{method:"POST",headers:this.headers,body:JSON.stringify({query:e,variables:t})});if(!a.ok){const e=await a.text();throw v("SubgraphService",n,`HTTP ${a.status}: ${e}`)}const r=await a.json();if(null!=r.errors&&r.errors.length>0)throw v("SubgraphService",n,`GraphQL errors: ${r.errors.map(e=>e.message).join("; ")}`);return r.data}catch(e){if(e instanceof Error&&"SynapseError"===e.name)throw e;throw v("SubgraphService",n,`Query execution failed: ${e.message}`,{cause:e})}}transformProviderData(e){const t=e.serviceURL??e.pdpUrl??"https://unknown.provider";return{id:1,serviceProvider:e.serviceProvider??e.serviceProvider??e.id,payee:e.payee??e.serviceProvider??e.id,name:"Subgraph Provider",description:"Provider from subgraph",active:!0,products:{PDP:{type:"PDP",isActive:!0,capabilities:{},data:{serviceURL:t,minPieceSizeInBytes:BigInt(1024),maxPieceSizeInBytes:BigInt(1073741824),ipniPiece:!1,ipniIpfs:!1,storagePricePerTibPerMonth:BigInt(1e6),minProvingPeriodInEpochs:2880,location:"Unknown",paymentTokenAddress:"0x0000000000000000000000000000000000000000"}}}}}parseTimestamp(e){if(null==e)return 0;const t=Number(e);return Number.isNaN(t)?0:t}safeConvertHexToCid(e){try{const t=function(e){const t=e.match(/../g);return null!=t?new Uint8Array(t.map(e=>parseInt(e,16))):z}(e.startsWith("0x")?e.slice(2):e),n=On(nn.decode(t));if(null==n)throw new Error(`Failed to convert CID to PieceCID format: ${e}`);return n}catch(e){return console.warn(`SubgraphService: queryProviders: Failed to convert CID to PieceCID format: ${e instanceof Error?e.message:"Unknown error"}`),null}}isValidProviderData(e){return null!=e?.id&&""!==e.id.trim()&&null!=e?.serviceURL&&""!==e.serviceURL.trim()}async getApprovedProvidersForPieceCID(e){const t=On(e);if(null==t)throw v("SubgraphService","getApprovedProvidersForPieceCID","Invalid PieceCID");const n=t.bytes.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),""),a=await this.executeQuery(aa,{cid:n},"getApprovedProvidersForPieceCID");if(null==a?.pieces||0===a.pieces.length)return console.log(`SubgraphService: No providers found for PieceCID: ${t.toString()}`),[];const r=a.pieces.reduce((e,t)=>{const n=t.dataSet.serviceProvider,a=n?.serviceProvider?.toLowerCase();return"Approved"!==n?.status||null==a||""===a||e.has(a)?e:this.isValidProviderData(n)?(e.set(a,n),e):(console.warn("SubgraphService: Skipping incomplete provider data for approved provider:",n),e)},new Map);return Array.from(r.values()).map(e=>this.transformProviderData(e))}async getProviderByAddress(e){const t=await this.executeQuery(ra,{providerId:e},"getProviderByAddress");return null==t?.provider?(console.log(`SubgraphService: No provider found for address: ${e}`),null):this.transformProviderData(t.provider)}async queryProviders(e={}){const t=await this.executeQuery(ia,this.normalizeQueryOptions(e),"queryProviders");return null==t?.providers||0===t?.providers?.length?(console.log("SubgraphService: No providers found for the given criteria"),[]):t.providers.filter(e=>this.isValidProviderData(e)).map(e=>this.transformProviderData(e))}async queryDataSets(e={}){const t=await this.executeQuery(sa,this.normalizeQueryOptions(e),"queryDataSets");return null==t?.dataSets||0===t?.dataSets?.length?(console.log("SubgraphService: No data sets found for the given criteria"),[]):t.dataSets.map(e=>({id:e.id,setId:this.parseTimestamp(e.setId),listener:e.listener??"",clientAddr:e.clientAddr??"",withCDN:e.withCDN??!1,isActive:e.isActive,leafCount:this.parseTimestamp(e.leafCount),challengeRange:this.parseTimestamp(e.challengeRange),lastProvenEpoch:this.parseTimestamp(e.lastProvenEpoch),nextChallengeEpoch:this.parseTimestamp(e.nextChallengeEpoch),totalPieces:this.parseTimestamp(e.totalPieces),totalDataSize:this.parseTimestamp(e.totalDataSize),totalProofs:this.parseTimestamp(e.totalProofs),totalProvedPieces:this.parseTimestamp(e.totalProvedPieces),totalFaultedPeriods:this.parseTimestamp(e.totalFaultedPeriods),totalFaultedPieces:this.parseTimestamp(e.totalFaultedPieces),metadata:e.metadata??"",createdAt:this.parseTimestamp(e.createdAt),updatedAt:this.parseTimestamp(e.updatedAt),owner:null!=e.owner?this.transformProviderData(e.owner):this.transformProviderData({}),serviceProvider:null!=e.serviceProvider?this.transformProviderData(e.serviceProvider):this.transformProviderData({}),rail:null!=e.rail?{id:e.rail.id,railId:this.parseTimestamp(e.rail.railId),token:e.rail.token,paymentRate:this.parseTimestamp(e.rail.paymentRate),lockupPeriod:this.parseTimestamp(e.rail.lockupPeriod),settledUpto:this.parseTimestamp(e.rail.settledUpto),endEpoch:this.parseTimestamp(e.rail.endEpoch)}:void 0}))}async queryPieces(e={}){const t=await this.executeQuery(oa,this.normalizeQueryOptions(e),"queryPieces");return null==t?.pieces||0===t?.pieces?.length?(console.log("SubgraphService: No pieces found for the given criteria"),[]):t.pieces.map(e=>({id:e.id,setId:this.parseTimestamp(e.setId),pieceId:this.parseTimestamp(e.pieceId),rawSize:this.parseTimestamp(e.rawSize),leafCount:this.parseTimestamp(e.leafCount),cid:this.safeConvertHexToCid(e.cid),removed:e.removed,totalProofsSubmitted:this.parseTimestamp(e.totalProofsSubmitted),totalPeriodsFaulted:this.parseTimestamp(e.totalPeriodsFaulted),lastProvenEpoch:this.parseTimestamp(e.lastProvenEpoch),lastProvenAt:this.parseTimestamp(e.lastProvenAt),lastFaultedEpoch:this.parseTimestamp(e.lastFaultedEpoch),lastFaultedAt:this.parseTimestamp(e.lastFaultedAt),createdAt:this.parseTimestamp(e.createdAt),metadata:e.metadata??"",dataSet:{id:e.dataSet.id,setId:this.parseTimestamp(e.dataSet.setId),isActive:e.dataSet.isActive,serviceProvider:this.transformProviderData(e.dataSet.serviceProvider)}}))}async queryFaultRecords(e={}){const t=await this.executeQuery(pa,this.normalizeQueryOptions(e),"queryFaultRecords");return null==t?.faultRecords||0===t?.faultRecords?.length?(console.log("SubgraphService: No fault records found for the given criteria"),[]):t.faultRecords.map(e=>({id:e.id,dataSetId:this.parseTimestamp(e.dataSetId),pieceIds:e.pieceIds.map(e=>this.parseTimestamp(e)),currentChallengeEpoch:this.parseTimestamp(e.currentChallengeEpoch),nextChallengeEpoch:this.parseTimestamp(e.nextChallengeEpoch),periodsFaulted:this.parseTimestamp(e.periodsFaulted),deadline:this.parseTimestamp(e.deadline),createdAt:this.parseTimestamp(e.createdAt),dataSet:{id:e.dataSet.id,setId:this.parseTimestamp(e.dataSet.setId),serviceProvider:this.transformProviderData(e.dataSet.serviceProvider)}}))}}async function ua(e,t,n,a){const r=[],i=[],s=e.map(async(e,n)=>{const s=new AbortController;i[n]=s,null!=a&&(a.addEventListener("abort",()=>{s.abort(a.reason)},{once:!0}),a.aborted&&s.abort(a.reason));try{if(!e.products.PDP?.data.serviceURL)throw new Error(`Provider ${e.id} does not have PDP product with serviceURL`);const a=M(e.products.PDP.data.serviceURL,t),i=await fetch(a,{signal:s.signal});if(!i.ok)throw r.push({provider:e.serviceProvider,error:`findPiece returned ${i.status}`}),new Error("Provider does not have piece");const o=R(e.products.PDP.data.serviceURL,t),p=await fetch(o,{signal:s.signal});if(p.ok)return{response:p,index:n};throw r.push({provider:e.serviceProvider,error:`download returned ${p.status}`}),new Error(`Download failed with status ${p.status}`)}catch(t){const n=t.message??"Unknown error";throw r.some(t=>t.provider===e.serviceProvider)||r.push({provider:e.serviceProvider,error:n}),console.warn(`Failed to fetch from provider ${e.serviceProvider}:`,n),t}});try{const{response:e,index:t}=await Promise.any(s);return i.forEach((e,n)=>{n!==t&&e.abort()}),e}catch(e){if(e instanceof AggregateError){const e=r.map(e=>`${e.provider}: ${e.error}`).join("; ");throw v(n,"fetchPiecesFromProviders",`All providers failed to serve piece ${t.toString()}. Details: ${e}`)}throw e}}class la{warmStorageService;childRetriever;spRegistry;constructor(e,t,n){this.warmStorageService=e,this.spRegistry=t,this.childRetriever=n}async findProviders(e,t){const n=new ea(this.warmStorageService,this.spRegistry);if(null!=t){const e=await n.getApprovedProviderByAddress(t);if(null==e)throw v("ChainRetriever","findProviders",`Provider ${t} not found or not approved`);return[e]}const a=(await this.warmStorageService.getClientDataSetsWithDetails(e)).filter(e=>e.isLive&&e.currentPieceCount>0);if(0===a.length)throw v("ChainRetriever","findProviders",`No active data sets with data found for client ${e}`);const r=[...new Set(a.map(e=>e.providerId))],i=(await n.getApprovedProvidersByIds(r)).filter(e=>null!=e);if(0===i.length)throw v("ChainRetriever","findProviders","No valid providers found (all providers may have been removed or are inactive)");return i}async fetchPiece(e,t,n){const a=async a=>{if(void 0!==this.childRetriever)return await this.childRetriever.fetchPiece(e,t,n);throw v("ChainRetriever","fetchPiece",`Failed to retrieve piece ${e.toString()}: ${a}`)};let r=[];try{r=await this.findProviders(t,n?.providerAddress)}catch(e){const t=e instanceof Error?e.message:"Provider discovery failed";return await a(t)}if(0===r.length)return await a("No providers found and no additional retriever method was configured");try{return await ua(r,e,"ChainRetriever",n?.signal)}catch{return await a("All provider retrieval attempts failed and no additional retriever method was configured")}}}class ca{baseRetriever;network;constructor(e,t){this.baseRetriever=e,this.network=t}hostname(){return"mainnet"===this.network?"filcdn.io":"calibration.filcdn.io"}async fetchPiece(e,t,n){if(!0===n?.withCDN){const a=`https://${t}.${this.hostname()}/${e.toString()}`;try{const e=await fetch(a,{signal:n?.signal});if(e.ok)return e;402===e.status?console.warn("CDN requires payment. Please initialise Synapse SDK with the option `withCDN: true` and re-upload your files."):console.warn("CDN fetch failed with status:",e.status)}catch(e){console.warn("CDN fetch failed:",e)}}return console.log("Falling back to direct retrieval"),await this.baseRetriever.fetchPiece(e,t,n)}}class ya{subgraphService;childRetriever;constructor(e,t){this.subgraphService=e,this.childRetriever=t}async findProviders(e,t){if(null!=t){const e=await this.subgraphService.getProviderByAddress(t);return null!==e?[e]:[]}return await this.subgraphService.getApprovedProvidersForPieceCID(e)}async fetchPiece(e,t,n){const a=async a=>{if(void 0!==this.childRetriever)return await this.childRetriever.fetchPiece(e,t,n);throw v("SubgraphRetriever","fetchPiece",`Failed to retrieve piece ${e.toString()}: ${a}`)};let r=[];try{r=await this.findProviders(e,n?.providerAddress)}catch{return await a("Provider discovery failed and no additional retriever method was configured")}if(0===r.length)return await a("No providers found and no additional retriever method was configured");try{return await ua(r,e,"SubgraphRetriever",n?.signal)}catch{return await a("All provider retrieval attempts failed and no additional retriever method was configured")}}}class ma{_provider;_warmStorageAddress;_warmStorageContract=null;_warmStorageViewContract=null;_pdpVerifier=null;_addresses;constructor(e,t,n){this._provider=e,this._warmStorageAddress=t,this._addresses=n}static async create(t,n){const a=await x(t),r=new e.Contract(f.MULTICALL3[a],d.MULTICALL3,t),i=new e.Interface(d.WARM_STORAGE),s=[{target:n,allowFailure:!1,callData:i.encodeFunctionData("pdpVerifierAddress")},{target:n,allowFailure:!1,callData:i.encodeFunctionData("paymentsContractAddress")},{target:n,allowFailure:!1,callData:i.encodeFunctionData("usdfcTokenAddress")},{target:n,allowFailure:!1,callData:i.encodeFunctionData("filCDNBeneficiaryAddress")},{target:n,allowFailure:!1,callData:i.encodeFunctionData("viewContractAddress")},{target:n,allowFailure:!1,callData:i.encodeFunctionData("serviceProviderRegistry")}],o=await r.aggregate3.staticCall(s),p={pdpVerifier:i.decodeFunctionResult("pdpVerifierAddress",o[0].returnData)[0],payments:i.decodeFunctionResult("paymentsContractAddress",o[1].returnData)[0],usdfcToken:i.decodeFunctionResult("usdfcTokenAddress",o[2].returnData)[0],filCDNBeneficiary:i.decodeFunctionResult("filCDNBeneficiaryAddress",o[3].returnData)[0],viewContract:i.decodeFunctionResult("viewContractAddress",o[4].returnData)[0],serviceProviderRegistry:i.decodeFunctionResult("serviceProviderRegistry",o[5].returnData)[0]};return new ma(t,n,p)}getPDPVerifierAddress(){return this._addresses.pdpVerifier}getPaymentsAddress(){return this._addresses.payments}getUSDFCTokenAddress(){return this._addresses.usdfcToken}getViewContractAddress(){return this._addresses.viewContract}getServiceProviderRegistryAddress(){return this._addresses.serviceProviderRegistry}getProvider(){return this._provider}_getWarmStorageContract(){return null==this._warmStorageContract&&(this._warmStorageContract=new e.Contract(this._warmStorageAddress,d.WARM_STORAGE,this._provider)),this._warmStorageContract}_getWarmStorageViewContract(){if(null==this._warmStorageViewContract){const t=this.getViewContractAddress();this._warmStorageViewContract=new e.Contract(t,d.WARM_STORAGE_VIEW,this._provider)}return this._warmStorageViewContract}_getPDPVerifier(){if(null==this._pdpVerifier){const e=this.getPDPVerifierAddress();this._pdpVerifier=new Xn(this._provider,e)}return this._pdpVerifier}async getDataSet(e){const t=this._getWarmStorageViewContract(),n=await t.getDataSet(e);if(0===Number(n.pdpRailId))throw v("WarmStorageService","getDataSet",`Data set ${e} does not exist`);return{pdpRailId:Number(n.pdpRailId),cacheMissRailId:Number(n.cacheMissRailId),cdnRailId:Number(n.cdnRailId),payer:n.payer,payee:n.payee,serviceProvider:n.serviceProvider,commissionBps:Number(n.commissionBps),clientDataSetId:Number(n.clientDataSetId),pdpEndEpoch:Number(n.pdpEndEpoch),providerId:Number(n.providerId),cdnEndEpoch:Number(n.cdnEndEpoch)}}async getClientDataSets(e){try{const t=this._getWarmStorageViewContract();return(await t.getClientDataSets(e)).map(e=>({pdpRailId:Number(e.pdpRailId),cacheMissRailId:Number(e.cacheMissRailId),cdnRailId:Number(e.cdnRailId),payer:e.payer,payee:e.payee,serviceProvider:e.serviceProvider,commissionBps:Number(e.commissionBps),clientDataSetId:Number(e.clientDataSetId),pdpEndEpoch:Number(e.pdpEndEpoch),providerId:Number(e.providerId),cdnEndEpoch:Number(e.cdnEndEpoch)}))}catch(e){throw new Error(`Failed to get client data sets: ${e instanceof Error?e.message:String(e)}`)}}async getClientDataSetsWithDetails(e,t=!1){const n=await this.getClientDataSets(e),a=this._getPDPVerifier(),r=this._getWarmStorageViewContract(),i=n.map(async e=>{try{const n=Number(await r.railToDataSet(e.pdpRailId));if(0===e.pdpRailId)return t?null:{...e,pdpVerifierDataSetId:0,nextPieceId:0,currentPieceCount:0,isLive:!1,isManaged:!1,withCDN:e.cdnRailId>0,metadata:Object.create(null)};const[i,s,o]=await Promise.all([a.dataSetLive(n),a.getDataSetListener(n).catch(()=>null),this.getDataSetMetadata(n).catch(()=>Object.create(null))]),p=null!=s&&s.toLowerCase()===this._warmStorageAddress.toLowerCase();if(t&&!p)return null;const d=i?await a.getNextPieceId(n):0;return{...e,pdpVerifierDataSetId:n,nextPieceId:Number(d),currentPieceCount:Number(d),isLive:i,isManaged:p,withCDN:e.cdnRailId>0,metadata:o}}catch(t){throw new Error(`Failed to get details for data set with enhanced info ${e.pdpRailId}: ${t instanceof Error?t.message:String(t)}`)}});return(await Promise.all(i)).filter(e=>null!==e)}async getAddPiecesInfo(e){try{const t=this._getWarmStorageViewContract(),n=this._getPDPVerifier(),[a,r,i,s]=await Promise.all([n.dataSetLive(Number(e)),n.getNextPieceId(Number(e)),n.getDataSetListener(Number(e)),t.getDataSet(Number(e))]);if(!a)throw new Error(`Data set ${e} does not exist or is not live`);if(i.toLowerCase()!==this._warmStorageAddress.toLowerCase())throw new Error(`Data set ${e} is not managed by this WarmStorage contract (${this._warmStorageAddress}), managed by ${String(i)}`);const o=Number(s.clientDataSetId);return{nextPieceId:Number(r),clientDataSetId:o,currentPieceCount:Number(r)}}catch(e){throw new Error(`Failed to get add pieces info: ${e instanceof Error?e.message:String(e)}`)}}async getNextClientDataSetId(e){try{const t=this._getWarmStorageViewContract(),n=await t.clientDataSetIDs(e);return Number(n)}catch(e){throw new Error(`Failed to get next client dataset ID: ${e instanceof Error?e.message:String(e)}`)}}async verifyDataSetCreation(e){try{const t="string"==typeof e?e:e.hash;let n;if(n="string"==typeof e?await this._provider.getTransactionReceipt(t):await e.wait(m.TRANSACTION_CONFIRMATIONS),null==n)return{transactionMined:!1,transactionSuccess:!1,dataSetLive:!1};if(1!==n.status)return{transactionMined:!0,transactionSuccess:!1,dataSetLive:!1,blockNumber:n.blockNumber,gasUsed:n.gasUsed,error:"Transaction failed"};const a=this._getPDPVerifier(),r=await a.extractDataSetIdFromReceipt(n);return null==r?{transactionMined:!0,transactionSuccess:!0,dataSetLive:!1,blockNumber:n.blockNumber,gasUsed:n.gasUsed,error:"Could not find DataSetCreated event in transaction"}:{transactionMined:!0,transactionSuccess:!0,dataSetId:r,dataSetLive:await a.dataSetLive(r),blockNumber:n.blockNumber,gasUsed:n.gasUsed}}catch(e){return{transactionMined:!1,transactionSuccess:!1,dataSetLive:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getComprehensiveDataSetStatus(e,t){const n="string"==typeof e?e:e.hash;let a=null;if(null!=t)try{performance.mark("synapse:pdpServer.getDataSetCreationStatus-start"),a=await t.getDataSetCreationStatus(n),performance.mark("synapse:pdpServer.getDataSetCreationStatus-end"),performance.measure("synapse:pdpServer.getDataSetCreationStatus","synapse:pdpServer.getDataSetCreationStatus-start","synapse:pdpServer.getDataSetCreationStatus-end")}catch{performance.mark("synapse:pdpServer.getDataSetCreationStatus-end"),performance.measure("synapse:pdpServer.getDataSetCreationStatus","synapse:pdpServer.getDataSetCreationStatus-start","synapse:pdpServer.getDataSetCreationStatus-end")}performance.mark("synapse:verifyDataSetCreation-start");const r=await this.verifyDataSetCreation(e);performance.mark("synapse:verifyDataSetCreation-end"),performance.measure("synapse:verifyDataSetCreation","synapse:verifyDataSetCreation-start","synapse:verifyDataSetCreation-end");const i=r.transactionMined&&r.transactionSuccess&&null!=r.dataSetId&&r.dataSetLive&&null!=a&&!0===a.ok&&a.dataSetCreated,s=a?.dataSetId??r.dataSetId??null;let o=r.error??null;return null!=a&&!1===a.ok&&(o=`Server reported transaction failed (status: ${a.txStatus})`),{txHash:n,serverStatus:a,chainStatus:r,summary:{isComplete:i,isLive:r.dataSetLive,dataSetId:s,error:o}}}async waitForDataSetCreationWithStatus(e,t,n=m.DATA_SET_CREATION_TIMEOUT_MS,a=m.DATA_SET_CREATION_POLL_INTERVAL_MS,r){const i=Date.now();for(;Date.now()-i<n;){const n=await this.getComprehensiveDataSetStatus(e,t),s=Date.now()-i;if(null!=r)try{await r(n,s)}catch(e){console.error("Error in progress callback:",e)}if(n.summary.isComplete)return n;if(null!=n.summary.error&&n.chainStatus.transactionMined)throw new Error(n.summary.error);await new Promise(e=>setTimeout(e,a))}throw new Error(`Data set creation timed out after ${n/1e3} seconds`)}async getDataSetMetadata(e){const t=this._getWarmStorageViewContract(),[n,a]=await t.getAllDataSetMetadata(e),r=Object.create(null);for(let e=0;e<n.length;e++)r[n[e]]=a[e];return r}async getDataSetMetadataByKey(e,t){const n=this._getWarmStorageViewContract(),[a,r]=await n.getDataSetMetadata(e,t);return a?r:null}async getPieceMetadata(e,t){const n=this._getWarmStorageViewContract(),[a,r]=await n.getAllPieceMetadata(e,t),i=Object.create(null);for(let e=0;e<a.length;e++)i[a[e]]=r[e];return i}async getPieceMetadataByKey(e,t,n){const a=this._getWarmStorageViewContract(),[r,i]=await a.getPieceMetadata(e,t,n);return r?i:null}async getServicePrice(){const e=this._getWarmStorageContract(),t=await e.getServicePrice();return{pricePerTiBPerMonthNoCDN:t.pricePerTiBPerMonthNoCDN,pricePerTiBPerMonthWithCDN:t.pricePerTiBPerMonthWithCDN,tokenAddress:t.tokenAddress,epochsPerMonth:t.epochsPerMonth}}async calculateStorageCost(e){const t=await this.getServicePrice(),n=BigInt(e),a=t.pricePerTiBPerMonthNoCDN*n/(c.TiB*t.epochsPerMonth),r=t.pricePerTiBPerMonthWithCDN*n/(c.TiB*t.epochsPerMonth);return{perEpoch:a,perDay:a*BigInt(u.EPOCHS_PER_DAY),perMonth:a*t.epochsPerMonth,withCDN:{perEpoch:r,perDay:r*BigInt(u.EPOCHS_PER_DAY),perMonth:r*t.epochsPerMonth}}}async checkAllowanceForStorage(e,t,n,a){const[r,i]=await Promise.all([n.serviceApproval(this._warmStorageAddress,o.USDFC),this.calculateStorageCost(e)]),s=t?i.withCDN:i,p=s.perEpoch,d=p*(BigInt(a??Number(u.DEFAULT_LOCKUP_DAYS))*BigInt(u.EPOCHS_PER_DAY)),l=BigInt(r.rateUsed)+p,c=BigInt(r.lockupUsed)+d,y=r.rateAllowance>=l&&r.lockupAllowance>=c,m=l>r.rateAllowance?l-r.rateAllowance:0n,h=c>r.lockupAllowance?c-r.lockupAllowance:0n;let g;if(!y){const e=m>0n,t=h>0n;e&&t?g="Insufficient rate and lockup allowances":e?g="Insufficient rate allowance":t&&(g="Insufficient lockup allowance")}return{rateAllowanceNeeded:m,lockupAllowanceNeeded:h,currentRateAllowance:r.rateAllowance,currentLockupAllowance:r.lockupAllowance,currentRateUsed:r.rateUsed,currentLockupUsed:r.lockupUsed,sufficient:y,message:g,costs:s,depositAmountNeeded:d}}async prepareStorageUpload(e,t){const[n,a]=await Promise.all([this.calculateStorageCost(e.dataSize),this.checkAllowanceForStorage(e.dataSize,e.withCDN??!1,t)]),r=e.withCDN?n.withCDN:n,i=[],s=await t.accountInfo(o.USDFC),p=r.perMonth;if(s.availableFunds<p){const e=p-s.availableFunds;i.push({type:"deposit",description:`Deposit ${e} USDFC to payments contract`,execute:async()=>await t.deposit(e,o.USDFC)})}return a.sufficient||i.push({type:"approveService",description:`Approve service with rate allowance ${a.rateAllowanceNeeded} and lockup allowance ${a.lockupAllowanceNeeded}`,execute:async()=>await t.approveService(this._warmStorageAddress,a.rateAllowanceNeeded,a.lockupAllowanceNeeded,86400n,o.USDFC)}),{estimatedCost:{perEpoch:r.perEpoch,perDay:r.perDay,perMonth:r.perMonth},allowanceCheck:{sufficient:a.sufficient,message:a.sufficient?void 0:`Insufficient allowances: rate needed ${a.rateAllowanceNeeded}, lockup needed ${a.lockupAllowanceNeeded}`},actions:i}}async terminateDataSet(e,t){const n=this._getWarmStorageContract().connect(e);return await n.terminateService(t)}async addApprovedProvider(e,t){const n=this._getWarmStorageContract().connect(e);return await n.addApprovedProvider(t)}async removeApprovedProvider(e,t){const n=this._getWarmStorageContract().connect(e),a=this._getWarmStorageViewContract(),r=(await a.getApprovedProviders()).findIndex(e=>Number(e)===t);if(-1===r)throw new Error(`Provider ${t} is not in the approved list`);return await n.removeApprovedProvider(t,r)}async getApprovedProviderIds(){const e=this._getWarmStorageViewContract();return(await e.getApprovedProviders()).map(e=>Number(e))}async isProviderIdApproved(e){const t=this._getWarmStorageViewContract();return await t.isProviderApproved(e)}async getOwner(){const e=this._getWarmStorageContract();return await e.owner()}async isOwner(e){const t=await e.getAddress(),n=await this.getOwner();return t.toLowerCase()===n.toLowerCase()}async getMaxProvingPeriod(){const e=this._getWarmStorageViewContract(),t=await e.getMaxProvingPeriod();return Number(t)}async getChallengeWindow(){const e=this._getWarmStorageViewContract(),t=await e.challengeWindow();return Number(t)}}class ha{_signer;_network;_withCDN;_payments;_provider;_warmStorageAddress;_warmStorageService;_pieceRetriever;_storageManager;static async create(t){if(1!==[t.privateKey,t.provider,t.signer].filter(Boolean).length)throw new Error("Must provide exactly one of: privateKey, provider, or signer");let n,a,r;if(null!=t.privateKey){const i=t.rpcURL??t.rpcURL;if(null==i)throw new Error("rpcURL is required when using privateKey");let s=t.privateKey;s.startsWith("0x")||(s=`0x${s}`),r=/^ws(s)?:\/\//i.test(i)?new e.WebSocketProvider(i):new e.JsonRpcProvider(i),n=await x(r);const o=new e.Wallet(s,r);a=!0===t.disableNonceManager?o:new e.NonceManager(o)}else if(null!=t.provider){if(r=t.provider,n=await x(r),!("getSigner"in r)||"function"!=typeof r.getSigner)throw new Error("Provider does not support signing operations");{const n=await r.getSigner(0);a=!0===t.disableNonceManager?n:new e.NonceManager(n)}}else{if(null==t.signer)throw new Error("No valid authentication method provided");if(a=t.signer,!0===t.disableNonceManager||a instanceof e.NonceManager||(a=new e.NonceManager(a)),null==a.provider)throw new Error("Signer must have a provider");r=a.provider,n=await x(r)}if("mainnet"!==n&&"calibration"!==n)throw new Error(`Invalid network: ${String(n)}. Only 'mainnet' and 'calibration' are supported.`);const i=t.warmStorageAddress??f.WARM_STORAGE[n];if(!i)throw new Error(`No Warm Storage address configured for network: ${n}`);const s=await ma.create(r,i),o=s.getPaymentsAddress(),p=s.getUSDFCTokenAddress(),d=new k(r,a,o,p,!0===t.disableNonceManager),u=s.getServiceProviderRegistryAddress(),l=new Jn(r,u);let c;if(null!=t.pieceRetriever)c=t.pieceRetriever;else{let e=new la(s,l);if(null!=t.subgraphConfig||null!=t.subgraphService){const n=null!=t.subgraphService?t.subgraphService:new da(t.subgraphConfig);e=new ya(n)}c=new ca(e,n)}return new ha(a,r,n,d,!0===t.withCDN,i,s,c)}constructor(e,t,n,a,r,i,s,o){this._signer=e,this._provider=t,this._network=n,this._payments=a,this._withCDN=r,this._warmStorageService=s,this._pieceRetriever=o,this._warmStorageAddress=i,this._storageManager=new na(this,this._warmStorageService,this._pieceRetriever,this._withCDN)}getNetwork(){return this._network}getSigner(){return this._signer}getProvider(){return this._provider}getChainId(){return"mainnet"===this._network?p.mainnet:p.calibration}getWarmStorageAddress(){return this._warmStorageAddress}getPaymentsAddress(){return this._warmStorageService.getPaymentsAddress()}getPDPVerifierAddress(){return this._warmStorageService.getPDPVerifierAddress()}get payments(){return this._payments}get storage(){return this._storageManager}async createStorage(e={}){return await this._storageManager.createContext(e)}async download(e,t){return console.warn("synapse.download() is deprecated. Use synapse.storage.download() instead."),await this._storageManager.download(e,t)}async getProviderInfo(t){try{if("string"==typeof t)try{e.getAddress(t)}catch{throw new Error(`Invalid provider address: ${t}`)}const n=this._warmStorageService.getServiceProviderRegistryAddress(),a=new Jn(this._provider,n),r=new ea(this._warmStorageService,a);let i;if(i="string"==typeof t?await r.getApprovedProviderByAddress(t):await r.getApprovedProvider(t),null==i)throw new Error(`Provider ${t} not found or not approved`);return i}catch(e){if(e instanceof Error&&e.message.includes("Invalid provider address"))throw e;if(e instanceof Error&&e.message.includes("is not approved"))throw e;if(e instanceof Error&&e.message.includes("not found"))throw e;throw new Error(`Failed to get provider info: ${e instanceof Error?e.message:String(e)}`)}}async getStorageInfo(){return console.warn("synapse.getStorageInfo() is deprecated. Use synapse.storage.getStorageInfo() instead."),await this._storageManager.getStorageInfo()}}const ga={...s,...a,...r,...i};export{ga as default};